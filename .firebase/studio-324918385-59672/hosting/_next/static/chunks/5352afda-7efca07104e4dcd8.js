"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[42],{1144:(e,t,n)=>{var r,i,s,a,o=n(9509),l=n(9641).Buffer;Object.defineProperty(t,"__esModule",{value:!0});var u=n(9438),c=n(9910),h=n(3517),d=n(8793),f=n(7061),m=n(4905);let g="@firebase/firestore";class p{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}p.UNAUTHENTICATED=new p(null),p.GOOGLE_CREDENTIALS=new p("google-credentials-uid"),p.FIRST_PARTY=new p("first-party-uid"),p.MOCK_USER=new p("mock-user");let y="10.14.0",w=new h.Logger("@firebase/firestore");function v(){return w.logLevel}function I(e,...t){if(w.logLevel<=h.LogLevel.DEBUG){let n=t.map(T);w.debug(`Firestore (${y}): ${e}`,...n)}}function _(e,...t){if(w.logLevel<=h.LogLevel.ERROR){let n=t.map(T);w.error(`Firestore (${y}): ${e}`,...n)}}function b(e,...t){if(w.logLevel<=h.LogLevel.WARN){let n=t.map(T);w.warn(`Firestore (${y}): ${e}`,...n)}}function T(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return e}}function E(e="Unexpected state"){let t=`FIRESTORE (${y}) INTERNAL ASSERTION FAILED: `+e;throw _(t),Error(t)}let S={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class x extends d.FirebaseError{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class C{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class D{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class N{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(p.UNAUTHENTICATED))}shutdown(){}}class A{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class k{constructor(e){this.t=e,this.currentUser=p.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){void 0===this.o||E();let n=this.i,r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve(),i=new C;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new C,e.enqueueRetryable(()=>r(this.currentUser))};let s=()=>{let t=i;e.enqueueRetryable(async()=>{await t.promise,await r(this.currentUser)})},a=e=>{I("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.o&&(this.auth.addAuthTokenListener(this.o),s())};this.t.onInit(e=>a(e)),setTimeout(()=>{if(!this.auth){let e=this.t.getImmediate({optional:!0});e?a(e):(I("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new C)}},0),s()}getToken(){let e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(I("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?("string"==typeof t.accessToken||E(),new D(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){let e=this.auth&&this.auth.getUid();return null===e||"string"==typeof e||E(),new p(e)}}class R{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=p.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);let e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class F{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new R(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(p.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class M{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class L{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(e,t){void 0===this.o||E();let n=e=>{null!=e.error&&I("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);let n=e.token!==this.R;return this.R=e.token,I("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable(()=>n(t))};let r=e=>{I("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.o&&this.appCheck.addTokenListener(this.o)};this.A.onInit(e=>r(e)),setTimeout(()=>{if(!this.appCheck){let e=this.A.getImmediate({optional:!0});e?r(e):I("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){let e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?("string"==typeof e.token||E(),this.R=e.token,new M(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}class V{getToken(){return Promise.resolve(new M(""))}invalidateToken(){}start(e,t){}shutdown(){}}class P{static newId(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length,n="";for(;n.length<20;){let r=function(e){let t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(40);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let e=0;e<40;e++)n[e]=Math.floor(256*Math.random());return n}(40);for(let i=0;i<r.length;++i)n.length<20&&r[i]<t&&(n+=e.charAt(r[i]%e.length))}return n}}function O(e,t){return e<t?-1:+(e>t)}function q(e,t,n){return e.length===t.length&&e.every((e,r)=>n(e,t[r]))}class U{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0||t>=1e9)throw new x(S.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-0xe7791f700||e>=0x3afff44180)throw new x(S.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return U.fromMillis(Date.now())}static fromDate(e){return U.fromMillis(e.getTime())}static fromMillis(e){let t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new U(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?O(this.nanoseconds,e.nanoseconds):O(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){return String(this.seconds- -0xe7791f700).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class B{constructor(e){this.timestamp=e}static fromTimestamp(e){return new B(e)}static min(){return new B(new U(0,0))}static max(){return new B(new U(0x3afff4417f,0x3b9ac9ff))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class z{constructor(e,t,n){void 0===t?t=0:t>e.length&&E(),void 0===n?n=e.length-t:n>e.length-t&&E(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===z.comparator(this,e)}child(e){let t=this.segments.slice(this.offset,this.limit());return e instanceof z?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){let n=Math.min(e.length,t.length);for(let r=0;r<n;r++){let n=e.get(r),i=t.get(r);if(n<i)return -1;if(n>i)return 1}return e.length<t.length?-1:+(e.length>t.length)}}class G extends z{construct(e,t,n){return new G(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){let t=[];for(let n of e){if(n.indexOf("//")>=0)throw new x(S.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>e.length>0))}return new G(t)}static emptyPath(){return new G([])}}let K=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class $ extends z{construct(e,t,n){return new $(e,t,n)}static isValidIdentifier(e){return K.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),$.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new $(["__name__"])}static fromServerFormat(e){let t=[],n="",r=0,i=()=>{if(0===n.length)throw new x(S.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""},s=!1;for(;r<e.length;){let t=e[r];if("\\"===t){if(r+1===e.length)throw new x(S.INVALID_ARGUMENT,"Path has trailing escape character: "+e);let t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new x(S.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?s=!s:"."!==t||s?n+=t:i(),r++}if(i(),s)throw new x(S.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new $(t)}static emptyPath(){return new $([])}}class Q{constructor(e){this.path=e}static fromPath(e){return new Q(G.fromString(e))}static fromName(e){return new Q(G.fromString(e).popFirst(5))}static empty(){return new Q(G.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===G.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return G.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new Q(new G(e.slice()))}}class j{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function W(e){return e.fields.find(e=>2===e.kind)}function J(e){return e.fields.filter(e=>2!==e.kind)}function H(e,t){let n=O(e.collectionGroup,t.collectionGroup);if(0!==n)return n;for(let r=0;r<Math.min(e.fields.length,t.fields.length);++r)if(0!==(n=function(e,t){let n=$.comparator(e.fieldPath,t.fieldPath);return 0!==n?n:O(e.kind,t.kind)}(e.fields[r],t.fields[r])))return n;return O(e.fields.length,t.fields.length)}j.UNKNOWN_ID=-1;class Y{constructor(e,t){this.fieldPath=e,this.kind=t}}class X{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new X(0,et.min())}}function Z(e,t){let n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1;return new et(B.fromTimestamp(1e9===r?new U(n+1,0):new U(n,r)),Q.empty(),t)}function ee(e){return new et(e.readTime,e.key,-1)}class et{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new et(B.min(),Q.empty(),-1)}static max(){return new et(B.max(),Q.empty(),-1)}}function en(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n||0!==(n=Q.comparator(e.documentKey,t.documentKey))?n:O(e.largestBatchId,t.largestBatchId)}let er="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ei{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function es(e){if(e.code!==S.FAILED_PRECONDITION||e.message!==er)throw e;I("LocalStore","Unexpectedly lost primary lease")}class ea{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&E(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new ea((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{let t=e();return t instanceof ea?t:ea.resolve(t)}catch(e){return ea.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):ea.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):ea.reject(t)}static resolve(e){return new ea((t,n)=>{t(e)})}static reject(e){return new ea((t,n)=>{n(e)})}static waitFor(e){return new ea((t,n)=>{let r=0,i=0,s=!1;e.forEach(e=>{++r,e.next(()=>{++i,s&&i===r&&t()},e=>n(e))}),s=!0,i===r&&t()})}static or(e){let t=ea.resolve(!1);for(let n of e)t=t.next(e=>e?ea.resolve(e):n());return t}static forEach(e,t){let n=[];return e.forEach((e,r)=>{n.push(t.call(this,e,r))}),this.waitFor(n)}static mapArray(e,t){return new ea((n,r)=>{let i=e.length,s=Array(i),a=0;for(let o=0;o<i;o++){let l=o;t(e[l]).next(e=>{s[l]=e,++a===i&&n(s)},e=>r(e))}})}static doWhile(e,t){return new ea((n,r)=>{let i=()=>{!0===e()?t().next(()=>{i()},r):n()};i()})}}class eo{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.V=new C,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{t.error?this.V.reject(new eh(e,t.error)):this.V.resolve()},this.transaction.onerror=t=>{let n=ep(t.target.error);this.V.reject(new eh(e,n))}}static open(e,t,n,r){try{return new eo(t,e.transaction(r,n))}catch(e){throw new eh(t,e)}}get m(){return this.V.promise}abort(e){e&&this.V.reject(e),this.aborted||(I("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){let e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){return new ef(this.transaction.objectStore(e))}}class el{constructor(e,t,n){this.name=e,this.version=t,this.p=n,12.2===el.S(d.getUA())&&_("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return I("SimpleDb","Removing database:",e),em(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!d.isIndexedDBAvailable())return!1;if(el.v())return!0;let e=d.getUA(),t=el.S(e),n=eu(e);return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||0<t&&t<10||0<n&&n<4.5)}static v(){var e;return void 0!==o&&"YES"===(null==(e=o.__PRIVATE_env)?void 0:e.C)}static F(e,t){return e.store(t)}static S(e){let t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i);return Number(t?t[1].split("_").slice(0,2).join("."):"-1")}async M(e){return this.db||(I("SimpleDb","Opening database:",this.name),this.db=await new Promise((t,n)=>{let r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{t(e.target.result)},r.onblocked=()=>{n(new eh(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{let r=t.target.error;"VersionError"===r.name?n(new x(S.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new x(S.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new eh(e,r))},r.onupgradeneeded=e=>{I("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);let t=e.target.result;this.p.O(t,r.transaction,e.oldVersion,this.version).next(()=>{I("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.N&&(this.db.onversionchange=e=>this.N(e)),this.db}L(e){this.N=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){let i="readonly"===t,s=0;for(;;){++s;try{this.db=await this.M(e);let t=eo.open(this.db,e,i?"readonly":"readwrite",n),s=r(t).next(e=>(t.g(),e)).catch(e=>(t.abort(e),ea.reject(e))).toPromise();return s.catch(()=>{}),await t.m,s}catch(t){let e="FirebaseError"!==t.name&&s<3;if(I("SimpleDb","Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}function eu(e){let t=e.match(/Android ([\d.]+)/i);return Number(t?t[1].split(".").slice(0,2).join("."):"-1")}class ec{constructor(e){this.B=e,this.k=!1,this.q=null}get isDone(){return this.k}get K(){return this.q}set cursor(e){this.B=e}done(){this.k=!0}$(e){this.q=e}delete(){return em(this.B.delete())}}class eh extends x{constructor(e,t){super(S.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function ed(e){return"IndexedDbTransactionError"===e.name}class ef{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(I("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(I("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),em(n)}add(e){return I("SimpleDb","ADD",this.store.name,e,e),em(this.store.add(e))}get(e){return em(this.store.get(e)).next(t=>(void 0===t&&(t=null),I("SimpleDb","GET",this.store.name,e,t),t))}delete(e){return I("SimpleDb","DELETE",this.store.name,e),em(this.store.delete(e))}count(){return I("SimpleDb","COUNT",this.store.name),em(this.store.count())}U(e,t){let n=this.options(e,t),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){let e=r.getAll(n.range);return new ea((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}{let e=this.cursor(n),t=[];return this.W(e,(e,n)=>{t.push(n)}).next(()=>t)}}G(e,t){let n=this.store.getAll(e,null===t?void 0:t);return new ea((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}})}j(e,t){I("SimpleDb","DELETE ALL",this.store.name);let n=this.options(e,t);n.H=!1;let r=this.cursor(n);return this.W(r,(e,t,n)=>n.delete())}J(e,t){let n;t?n=e:(n={},t=e);let r=this.cursor(n);return this.W(r,t)}Y(e){let t=this.cursor({});return new ea((n,r)=>{t.onerror=e=>{r(ep(e.target.error))},t.onsuccess=t=>{let r=t.target.result;r?e(r.primaryKey,r.value).next(e=>{e?r.continue():n()}):n()}})}W(e,t){let n=[];return new ea((r,i)=>{e.onerror=e=>{i(e.target.error)},e.onsuccess=e=>{let i=e.target.result;if(!i)return void r();let s=new ec(i),a=t(i.primaryKey,i.value,s);if(a instanceof ea){let e=a.catch(e=>(s.done(),ea.reject(e)));n.push(e)}s.isDone?r():null===s.K?i.continue():i.continue(s.K)}}).next(()=>ea.waitFor(n))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){let n=this.store.index(e.index);return e.H?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function em(e){return new ea((t,n)=>{e.onsuccess=e=>{t(e.target.result)},e.onerror=e=>{n(ep(e.target.error))}})}let eg=!1;function ep(e){let t=el.S(d.getUA());if(t>=12.2&&t<13){let t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){let e=new x("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return eg||(eg=!0,setTimeout(()=>{throw e},0)),e}}return e}class ey{constructor(e,t){this.asyncQueue=e,this.Z=t,this.task=null}start(){this.X(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}X(e){I("IndexBackfiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{I("IndexBackfiller",`Documents written: ${await this.Z.ee()}`)}catch(e){ed(e)?I("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",e):await es(e)}await this.X(6e4)})}}class ew{constructor(e,t){this.localStore=e,this.persistence=t}async ee(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.te(t,e))}te(e,t){let n=new Set,r=t,i=!0;return ea.doWhile(()=>!0===i&&r>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>{if(null!==t&&!n.has(t))return I("IndexBackfiller",`Processing collection: ${t}`),this.ne(e,t,r).next(e=>{r-=e,n.add(t)});i=!1})).next(()=>t-r)}ne(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next(n=>{let i=n.changes;return this.localStore.indexManager.updateIndexEntries(e,i).next(()=>this.re(r,n)).next(n=>(I("IndexBackfiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n))).next(()=>i.size)}))}re(e,t){let n=e;return t.changes.forEach((e,t)=>{let r=ee(t);en(r,n)>0&&(n=r)}),new et(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class ev{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ie(e),this.se=e=>t.writeSequenceNumber(e))}ie(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){let e=++this.previousValue;return this.se&&this.se(e),e}}function eI(e){return null==e}function e_(e){return 0===e&&1/e==-1/0}function eb(e){return"number"==typeof e&&Number.isInteger(e)&&!e_(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function eT(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t+="\x01\x01"),t=function(e,t){let n=t,r=e.length;for(let t=0;t<r;t++){let r=e.charAt(t);switch(r){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=r}}return n}(e.get(n),t);return t+"\x01\x01"}ev.oe=-1;function eE(e){let t=e.length;if(t>=2||E(),2===t)return"\x01"===e.charAt(0)&&"\x01"===e.charAt(1)||E(),G.emptyPath();let n=t-2,r=[],i="";for(let s=0;s<t;){let t=e.indexOf("\x01",s);switch((t<0||t>n)&&E(),e.charAt(t+1)){case"\x01":let a,o=e.substring(s,t);0===i.length?a=o:(i+=o,a=i,i=""),r.push(a);break;case"\x10":i+=e.substring(s,t),i+="\0";break;case"\x11":i+=e.substring(s,t+1);break;default:E()}s=t+2}return new G(r)}let eS=["userId","batchId"],ex={},eC=["prefixPath","collectionGroup","readTime","documentId"],eD=["prefixPath","collectionGroup","documentId"],eN=["collectionGroup","readTime","prefixPath","documentId"],eA=["canonicalId","targetId"],ek=["targetId","path"],eR=["path","targetId"],eF=["collectionId","parent"],eM=["indexId","uid"],eL=["uid","sequenceNumber"],eV=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],eP=["indexId","uid","orderedDocumentKey"],eO=["userId","collectionPath","documentId"],eq=["userId","collectionPath","largestBatchId"],eU=["userId","collectionGroup","largestBatchId"],eB=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],ez=[...eB,"documentOverlays"],eG=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],eK=[...eG,"indexConfiguration","indexState","indexEntries"],e$=[...eK,"globals"];class eQ extends ei{constructor(e,t){super(),this._e=e,this.currentSequenceNumber=t}}function ej(e,t){return el.F(e._e,t)}function eW(e){let t=0;for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function eJ(e,t){for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function eH(e,t){let n=[];for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&n.push(t(e[r],r,e));return n}function eY(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class eX{constructor(e,t){this.comparator=e,this.root=t||e0.EMPTY}insert(e,t){return new eX(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,e0.BLACK,null,null))}remove(e){return new eX(this.comparator,this.root.remove(e,this.comparator).copy(null,null,e0.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){let n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){let r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return -1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,n)=>(e(t,n),!1))}toString(){let e=[];return this.inorderTraversal((t,n)=>(e.push(`${t}:${n}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new eZ(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new eZ(this.root,e,this.comparator,!1)}getReverseIterator(){return new eZ(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new eZ(this.root,e,this.comparator,!0)}}class eZ{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;let e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class e0{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:e0.RED,this.left=null!=r?r:e0.EMPTY,this.right=null!=i?i:e0.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new e0(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this,i=n(e,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()}removeMin(){if(this.left.isEmpty())return e0.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),(e=e.copy(null,null,null,e.left.removeMin(),null)).fixUp()}remove(e,t){let n,r=this;if(0>t(e,r.key))r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return e0.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=(e=e.rotateRight()).colorFlip()),e}rotateLeft(){let e=this.copy(null,null,e0.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){let e=this.copy(null,null,e0.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){return Math.pow(2,this.check())<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw E();let e=this.left.check();if(e!==this.right.check())throw E();return e+ +!this.isRed()}}e0.EMPTY=null,e0.RED=!0,e0.BLACK=!1,e0.EMPTY=new class{constructor(){this.size=0}get key(){throw E()}get value(){throw E()}get color(){throw E()}get left(){throw E()}get right(){throw E()}copy(e,t,n,r,i){return this}insert(e,t,n){return new e0(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class e1{constructor(e){this.comparator=e,this.data=new eX(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,n)=>(e(t),!1))}forEachInRange(e,t){let n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){let r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){let t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new e2(this.data.getIterator())}getIteratorFrom(e){return new e2(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof e1)||this.size!==e.size)return!1;let t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){let e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){let e=[];return this.forEach(t=>{e.push(t)}),e}toString(){let e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){let t=new e1(this.comparator);return t.data=e,t}}class e2{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function e5(e){return e.hasNext()?e.getNext():void 0}class e4{constructor(e){this.fields=e,e.sort($.comparator)}static empty(){return new e4([])}unionWith(e){let t=new e1($.comparator);for(let e of this.fields)t=t.add(e);for(let n of e)t=t.add(n);return new e4(t.toArray())}covers(e){for(let t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return q(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class e8 extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class e3{constructor(e){this.binaryString=e}static fromBase64String(e){return new e3(function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new e8("Invalid base64 string: "+e):e}}(e))}static fromUint8Array(e){return new e3(function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e))}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return btoa(this.binaryString)}toUint8Array(){var e=this.binaryString;let t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return O(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}e3.EMPTY_BYTE_STRING=new e3("");let e6=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function e9(e){if(e||E(),"string"==typeof e){let t=0,n=e6.exec(e);if(n||E(),n[1]){let e=n[1];t=Number(e=(e+"000000000").substr(0,9))}return{seconds:Math.floor(new Date(e).getTime()/1e3),nanos:t}}return{seconds:e7(e.seconds),nanos:e7(e.nanos)}}function e7(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function te(e){return"string"==typeof e?e3.fromBase64String(e):e3.fromUint8Array(e)}function tt(e){var t,n;return"server_timestamp"===(null==(n=((null==(t=null==e?void 0:e.mapValue)?void 0:t.fields)||{}).__type__)?void 0:n.stringValue)}function tn(e){let t=e.mapValue.fields.__previous_value__;return tt(t)?tn(t):t}function tr(e){let t=e9(e.mapValue.fields.__local_write_time__.timestampValue);return new U(t.seconds,t.nanos)}class ti{constructor(e,t,n,r,i,s,a,o,l){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=l}}class ts{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new ts("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof ts&&e.projectId===this.projectId&&e.database===this.database}}let ta={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},to={nullValue:"NULL_VALUE"};function tl(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?tt(e)?4:tT(e)?0x1fffffffffffff:t_(e)?10:11:E()}function tu(e,t){if(e===t)return!0;let n=tl(e);if(n!==tl(t))return!1;switch(n){case 0:case 0x1fffffffffffff:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return tr(e).isEqual(tr(t));case 3:if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;let r=e9(e.timestampValue),i=e9(t.timestampValue);return r.seconds===i.seconds&&r.nanos===i.nanos;case 5:return e.stringValue===t.stringValue;case 6:return te(e.bytesValue).isEqual(te(t.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return e7(e.geoPointValue.latitude)===e7(t.geoPointValue.latitude)&&e7(e.geoPointValue.longitude)===e7(t.geoPointValue.longitude);case 2:if("integerValue"in e&&"integerValue"in t)return e7(e.integerValue)===e7(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){let n=e7(e.doubleValue),r=e7(t.doubleValue);return n===r?e_(n)===e_(r):isNaN(n)&&isNaN(r)}return!1;case 9:return q(e.arrayValue.values||[],t.arrayValue.values||[],tu);case 10:case 11:let s=e.mapValue.fields||{},a=t.mapValue.fields||{};if(eW(s)!==eW(a))return!1;for(let e in s)if(s.hasOwnProperty(e)&&(void 0===a[e]||!tu(s[e],a[e])))return!1;return!0;default:return E()}}function tc(e,t){return void 0!==(e.values||[]).find(e=>tu(e,t))}function th(e,t){if(e===t)return 0;let n=tl(e),r=tl(t);if(n!==r)return O(n,r);switch(n){case 0:case 0x1fffffffffffff:return 0;case 1:return O(e.booleanValue,t.booleanValue);case 2:let i=e7(e.integerValue||e.doubleValue),s=e7(t.integerValue||t.doubleValue);return i<s?-1:i>s?1:i===s?0:isNaN(i)?isNaN(s)?0:-1:1;case 3:return td(e.timestampValue,t.timestampValue);case 4:return td(tr(e),tr(t));case 5:return O(e.stringValue,t.stringValue);case 6:return function(e,t){let n=te(e),r=te(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){let n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){let t=O(n[e],r[e]);if(0!==t)return t}return O(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){let n=O(e7(e.latitude),e7(t.latitude));return 0!==n?n:O(e7(e.longitude),e7(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return tf(e.arrayValue,t.arrayValue);case 10:return function(e,t){var n,r,i,s;let a=e.fields||{},o=t.fields||{},l=null==(n=a.value)?void 0:n.arrayValue,u=null==(r=o.value)?void 0:r.arrayValue,c=O((null==(i=null==l?void 0:l.values)?void 0:i.length)||0,(null==(s=null==u?void 0:u.values)?void 0:s.length)||0);return 0!==c?c:tf(l,u)}(e.mapValue,t.mapValue);case 11:return function(e,t){if(e===ta.mapValue&&t===ta.mapValue)return 0;if(e===ta.mapValue)return 1;if(t===ta.mapValue)return -1;let n=e.fields||{},r=Object.keys(n),i=t.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let e=0;e<r.length&&e<s.length;++e){let t=O(r[e],s[e]);if(0!==t)return t;let a=th(n[r[e]],i[s[e]]);if(0!==a)return a}return O(r.length,s.length)}(e.mapValue,t.mapValue);default:throw E()}}function td(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return O(e,t);let n=e9(e),r=e9(t),i=O(n.seconds,r.seconds);return 0!==i?i:O(n.nanos,r.nanos)}function tf(e,t){let n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){let t=th(n[e],r[e]);if(t)return t}return O(n.length,r.length)}function tm(e){var t,n;return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){let t=e9(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?te(e.bytesValue).toBase64():"referenceValue"in e?(t=e.referenceValue,Q.fromName(t).toString()):"geoPointValue"in e?(n=e.geoPointValue,`geo(${n.latitude},${n.longitude})`):"arrayValue"in e?function(e){let t="[",n=!0;for(let r of e.values||[])n?n=!1:t+=",",t+=tm(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){let t=Object.keys(e.fields||{}).sort(),n="{",r=!0;for(let i of t)r?r=!1:n+=",",n+=`${i}:${tm(e.fields[i])}`;return n+"}"}(e.mapValue):E()}function tg(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function tp(e){return!!e&&"integerValue"in e}function ty(e){return!!e&&"arrayValue"in e}function tw(e){return!!e&&"nullValue"in e}function tv(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function tI(e){return!!e&&"mapValue"in e}function t_(e){var t,n;return"__vector__"===(null==(n=((null==(t=null==e?void 0:e.mapValue)?void 0:t.fields)||{}).__type__)?void 0:n.stringValue)}function tb(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){let t={mapValue:{fields:{}}};return eJ(e.mapValue.fields,(e,n)=>t.mapValue.fields[e]=tb(n)),t}if(e.arrayValue){let t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=tb(e.arrayValue.values[n]);return t}return Object.assign({},e)}function tT(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}let tE={mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{}}}}};function tS(e,t){let n=th(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function tx(e,t){let n=th(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class tC{constructor(e){this.value=e}static empty(){return new tC({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(!tI(t=(t.mapValue.fields||{})[e.get(n)]))return null;return(t=(t.mapValue.fields||{})[e.lastSegment()])||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=tb(t)}setAll(e){let t=$.emptyPath(),n={},r=[];e.forEach((e,i)=>{if(!t.isImmediateParentOf(i)){let e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=i.popLast()}e?n[i.lastSegment()]=tb(e):r.push(i.lastSegment())});let i=this.getFieldsMap(t);this.applyChanges(i,n,r)}delete(e){let t=this.field(e.popLast());tI(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return tu(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];tI(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){for(let r of(eJ(t,(t,n)=>e[t]=n),n))delete e[r]}clone(){return new tC(tb(this.value))}}class tD{constructor(e,t,n,r,i,s,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new tD(e,0,B.min(),B.min(),B.min(),tC.empty(),0)}static newFoundDocument(e,t,n,r){return new tD(e,1,t,B.min(),n,r,0)}static newNoDocument(e,t){return new tD(e,2,t,B.min(),B.min(),tC.empty(),0)}static newUnknownDocument(e,t){return new tD(e,3,t,B.min(),B.min(),tC.empty(),2)}convertToFoundDocument(e,t){return this.createTime.isEqual(B.min())&&(2===this.documentType||0===this.documentType)&&(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=tC.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=tC.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=B.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof tD&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new tD(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class tN{constructor(e,t){this.position=e,this.inclusive=t}}function tA(e,t,n){let r=0;for(let i=0;i<e.position.length;i++){let s=t[i],a=e.position[i];if(r=s.field.isKeyField()?Q.comparator(Q.fromName(a.referenceValue),n.key):th(a,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function tk(e,t){if(null===e)return null===t;if(null===t||e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!tu(e.position[n],t.position[n]))return!1;return!0}class tR{constructor(e,t="asc"){this.field=e,this.dir=t}}class tF{}class tM extends tF{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new tB(e,t,n):"array-contains"===t?new t$(e,n):"in"===t?new tQ(e,n):"not-in"===t?new tj(e,n):"array-contains-any"===t?new tW(e,n):new tM(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new tz(e,n):new tG(e,n)}matches(e){let t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(th(t,this.value)):null!==t&&tl(this.value)===tl(t)&&this.matchesComparison(th(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return E()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class tL extends tF{constructor(e,t){super(),this.filters=e,this.op=t,this.ae=null}static create(e,t){return new tL(e,t)}matches(e){return tV(this)?void 0===this.filters.find(t=>!t.matches(e)):void 0!==this.filters.find(t=>t.matches(e))}getFlattenedFilters(){return null!==this.ae||(this.ae=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ae}getFilters(){return Object.assign([],this.filters)}}function tV(e){return"and"===e.op}function tP(e){return"or"===e.op}function tO(e){return tq(e)&&tV(e)}function tq(e){for(let t of e.filters)if(t instanceof tL)return!1;return!0}function tU(e,t){let n=e.filters.concat(t);return tL.create(n,e.op)}class tB extends tM{constructor(e,t,n){super(e,t,n),this.key=Q.fromName(n.referenceValue)}matches(e){let t=Q.comparator(e.key,this.key);return this.matchesComparison(t)}}class tz extends tM{constructor(e,t){super(e,"in",t),this.keys=tK("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class tG extends tM{constructor(e,t){super(e,"not-in",t),this.keys=tK("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function tK(e,t){var n;return((null==(n=t.arrayValue)?void 0:n.values)||[]).map(e=>Q.fromName(e.referenceValue))}class t$ extends tM{constructor(e,t){super(e,"array-contains",t)}matches(e){let t=e.data.field(this.field);return ty(t)&&tc(t.arrayValue,this.value)}}class tQ extends tM{constructor(e,t){super(e,"in",t)}matches(e){let t=e.data.field(this.field);return null!==t&&tc(this.value.arrayValue,t)}}class tj extends tM{constructor(e,t){super(e,"not-in",t)}matches(e){if(tc(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let t=e.data.field(this.field);return null!==t&&!tc(this.value.arrayValue,t)}}class tW extends tM{constructor(e,t){super(e,"array-contains-any",t)}matches(e){let t=e.data.field(this.field);return!(!ty(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>tc(this.value.arrayValue,e))}}class tJ{constructor(e,t=null,n=[],r=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=a,this.ue=null}}function tH(e,t=null,n=[],r=[],i=null,s=null,a=null){return new tJ(e,t,n,r,i,s,a)}function tY(e){if(null===e.ue){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(e=>(function e(t){if(t instanceof tM)return t.field.canonicalString()+t.op.toString()+tm(t.value);if(tO(t))return t.filters.map(t=>e(t)).join(",");{let n=t.filters.map(t=>e(t)).join(",");return`${t.op}(${n})`}})(e)).join(","),t+="|ob:",t+=e.orderBy.map(e=>e.field.canonicalString()+e.dir).join(","),eI(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>tm(e)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>tm(e)).join(",")),e.ue=t}return e.ue}function tX(e,t){if(e.limit!==t.limit||e.orderBy.length!==t.orderBy.length)return!1;for(let i=0;i<e.orderBy.length;i++){var n,r;if(n=e.orderBy[i],r=t.orderBy[i],!(n.dir===r.dir&&n.field.isEqual(r.field)))return!1}if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!function e(t,n){return t instanceof tM?n instanceof tM&&t.op===n.op&&t.field.isEqual(n.field)&&tu(t.value,n.value):t instanceof tL?n instanceof tL&&t.op===n.op&&t.filters.length===n.filters.length&&t.filters.reduce((t,r,i)=>t&&e(r,n.filters[i]),!0):void E()}(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!tk(e.startAt,t.startAt)&&tk(e.endAt,t.endAt)}function tZ(e){return Q.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function t0(e,t){return e.filters.filter(e=>e instanceof tM&&e.field.isEqual(t))}function t1(e,t,n){let r=to,i=!0;for(let n of t0(e,t)){let e=to,t=!0;switch(n.op){case"<":case"<=":var s;e="nullValue"in(s=n.value)?to:"booleanValue"in s?{booleanValue:!1}:"integerValue"in s||"doubleValue"in s?{doubleValue:NaN}:"timestampValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in s?{stringValue:""}:"bytesValue"in s?{bytesValue:""}:"referenceValue"in s?tg(ts.empty(),Q.empty()):"geoPointValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in s?{arrayValue:{}}:"mapValue"in s?t_(s)?tE:{mapValue:{}}:E();break;case"==":case"in":case">=":e=n.value;break;case">":e=n.value,t=!1;break;case"!=":case"not-in":e=to}0>tS({value:r,inclusive:i},{value:e,inclusive:t})&&(r=e,i=t)}if(null!==n){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=n.position[s];0>tS({value:r,inclusive:i},{value:e,inclusive:n.inclusive})&&(r=e,i=n.inclusive);break}}return{value:r,inclusive:i}}function t2(e,t,n){let r=ta,i=!0;for(let n of t0(e,t)){let e=ta,t=!0;switch(n.op){case">=":case">":var s;e="nullValue"in(s=n.value)?{booleanValue:!1}:"booleanValue"in s?{doubleValue:NaN}:"integerValue"in s||"doubleValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in s?{stringValue:""}:"stringValue"in s?{bytesValue:""}:"bytesValue"in s?tg(ts.empty(),Q.empty()):"referenceValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in s?{arrayValue:{}}:"arrayValue"in s?tE:"mapValue"in s?t_(s)?{mapValue:{}}:ta:E(),t=!1;break;case"==":case"in":case"<=":e=n.value;break;case"<":e=n.value,t=!1;break;case"!=":case"not-in":e=ta}tx({value:r,inclusive:i},{value:e,inclusive:t})>0&&(r=e,i=t)}if(null!==n){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=n.position[s];tx({value:r,inclusive:i},{value:e,inclusive:n.inclusive})>0&&(r=e,i=n.inclusive);break}}return{value:r,inclusive:i}}class t5{constructor(e,t=null,n=[],r=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}}function t4(e){return new t5(e)}function t8(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function t3(e){return null!==e.collectionGroup}function t6(e){if(null===e.ce){let t;e.ce=[];let n=new Set;for(let t of e.explicitOrderBy)e.ce.push(t),n.add(t.field.canonicalString());let r=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(t=new e1($.comparator),e.filters.forEach(e=>{e.getFlattenedFilters().forEach(e=>{e.isInequality()&&(t=t.add(e.field))})}),t).forEach(t=>{n.has(t.canonicalString())||t.isKeyField()||e.ce.push(new tR(t,r))}),n.has($.keyField().canonicalString())||e.ce.push(new tR($.keyField(),r))}return e.ce}function t9(e){return e.le||(e.le=ne(e,t6(e))),e.le}function t7(e){return e.he||(e.he=ne(e,e.explicitOrderBy)),e.he}function ne(e,t){if("F"===e.limitType)return tH(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map(e=>{let t="desc"===e.dir?"asc":"desc";return new tR(e.field,t)});let n=e.endAt?new tN(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new tN(e.startAt.position,e.startAt.inclusive):null;return tH(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}function nt(e,t){let n=e.filters.concat([t]);return new t5(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function nn(e,t,n){return new t5(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function nr(e,t){return tX(t9(e),t9(t))&&e.limitType===t.limitType}function ni(e){return`${tY(t9(e))}|lt:${e.limitType}`}function ns(e){var t;let n;return`Query(target=${n=(t=t9(e)).path.canonicalString(),null!==t.collectionGroup&&(n+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(n+=`, filters: [${t.filters.map(e=>(function e(t){return t instanceof tM?`${t.field.canonicalString()} ${t.op} ${tm(t.value)}`:t instanceof tL?t.op.toString()+" {"+t.getFilters().map(e).join(" ,")+"}":"Filter"})(e)).join(", ")}]`),eI(t.limit)||(n+=", limit: "+t.limit),t.orderBy.length>0&&(n+=`, orderBy: [${t.orderBy.map(e=>`${e.field.canonicalString()} (${e.dir})`).join(", ")}]`),t.startAt&&(n+=", startAt: ",n+=t.startAt.inclusive?"b:":"a:",n+=t.startAt.position.map(e=>tm(e)).join(",")),t.endAt&&(n+=", endAt: ",n+=t.endAt.inclusive?"a:":"b:",n+=t.endAt.position.map(e=>tm(e)).join(",")),`Target(${n})`}; limitType=${e.limitType})`}function na(e,t){return t.isFoundDocument()&&function(e,t){let n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):Q.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(let n of t6(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(let n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&(!e.startAt||!!function(e,t,n){let r=tA(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,t6(e),t))&&(!e.endAt||!!function(e,t,n){let r=tA(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,t6(e),t))}function no(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function nl(e){return(t,n)=>{let r=!1;for(let i of t6(e)){let e=function(e,t,n){let r=e.field.isKeyField()?Q.comparator(t.key,n.key):function(e,t,n){let r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?th(r,i):E()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return -1*r;default:return E()}}(i,t,n);if(0!==e)return e;r=r||i.field.isKeyField()}return 0}}class nu{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){let t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n){for(let[t,r]of n)if(this.equalsFn(t,e))return r}}has(e){return void 0!==this.get(e)}set(e,t){let n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){let t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){eJ(this.inner,(t,n)=>{for(let[t,r]of n)e(t,r)})}isEmpty(){return eY(this.inner)}size(){return this.innerSize}}let nc=new eX(Q.comparator),nh=new eX(Q.comparator);function nd(...e){let t=nh;for(let n of e)t=t.insert(n.key,n);return t}function nf(e){let t=nh;return e.forEach((e,n)=>t=t.insert(e,n.overlayedDocument)),t}function nm(){return new nu(e=>e.toString(),(e,t)=>e.isEqual(t))}let ng=new eX(Q.comparator),np=new e1(Q.comparator);function ny(...e){let t=np;for(let n of e)t=t.add(n);return t}let nw=new e1(O);function nv(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:e_(t)?"-0":t}}function nI(e){return{integerValue:""+e}}function n_(e,t){return eb(t)?nI(t):nv(e,t)}class nb{constructor(){this._=void 0}}function nT(e,t){return e instanceof nN?tp(t)||t&&"doubleValue"in t?t:{integerValue:0}:null}class nE extends nb{}class nS extends nb{constructor(e){super(),this.elements=e}}function nx(e,t){let n=nk(t);for(let t of e.elements)n.some(e=>tu(e,t))||n.push(t);return{arrayValue:{values:n}}}class nC extends nb{constructor(e){super(),this.elements=e}}function nD(e,t){let n=nk(t);for(let t of e.elements)n=n.filter(e=>!tu(e,t));return{arrayValue:{values:n}}}class nN extends nb{constructor(e,t){super(),this.serializer=e,this.Pe=t}}function nA(e){return e7(e.integerValue||e.doubleValue)}function nk(e){return ty(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class nR{constructor(e,t){this.field=e,this.transform=t}}class nF{constructor(e,t){this.version=e,this.transformResults=t}}class nM{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new nM}static exists(e){return new nM(void 0,e)}static updateTime(e){return new nM(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function nL(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class nV{}function nP(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new n$(e.key,nM.none()):new nU(e.key,e.data,nM.none());{let n=e.data,r=tC.empty(),i=new e1($.comparator);for(let e of t.fields)if(!i.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),i=i.add(e)}return new nB(e.key,r,new e4(i.toArray()),nM.none())}}function nO(e,t,n,r){return e instanceof nU?function(e,t,n,r){if(!nL(e.precondition,t))return n;let i=e.value.clone(),s=nK(e.fieldTransforms,r,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof nB?function(e,t,n,r){if(!nL(e.precondition,t))return n;let i=nK(e.fieldTransforms,r,t),s=t.data;return(s.setAll(nz(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===n)?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):nL(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}function nq(e,t){var n,r;return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||!(!n||!r)&&q(n,r,(e,t)=>{var n,r;return e.field.isEqual(t.field)&&(n=e.transform,r=t.transform,n instanceof nS&&r instanceof nS||n instanceof nC&&r instanceof nC?q(n.elements,r.elements,tu):n instanceof nN&&r instanceof nN?tu(n.Pe,r.Pe):n instanceof nE&&r instanceof nE)})))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class nU extends nV{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class nB extends nV{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function nz(e){let t=new Map;return e.fieldMask.fields.forEach(n=>{if(!n.isEmpty()){let r=e.data.field(n);t.set(n,r)}}),t}function nG(e,t,n){var r;let i=new Map;e.length===n.length||E();for(let s=0;s<n.length;s++){let a=e[s],o=a.transform,l=t.data.field(a.field);i.set(a.field,(r=n[s],o instanceof nS?nx(o,l):o instanceof nC?nD(o,l):r))}return i}function nK(e,t,n){let r=new Map;for(let i of e){let e=i.transform,s=n.data.field(i.field);r.set(i.field,e instanceof nE?function(e,t){let n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&tt(t)&&(t=tn(t)),t&&(n.fields.__previous_value__=t),{mapValue:n}}(t,s):e instanceof nS?nx(e,s):e instanceof nC?nD(e,s):function(e,t){let n=nT(e,t),r=nA(n)+nA(e.Pe);return tp(n)&&tp(e.Pe)?nI(r):nv(e.serializer,r)}(e,s))}return r}class n$ extends nV{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class nQ extends nV{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class nj{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){let n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){let r=this.mutations[t];r.key.isEqual(e.key)&&function(e,t,n){e instanceof nU?function(e,t,n){let r=e.value.clone(),i=nG(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof nB?function(e,t,n){if(!nL(e.precondition,t))return t.convertToUnknownDocument(n.version);let r=nG(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(nz(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(e,t,n):t.convertToNoDocument(n.version).setHasCommittedMutations()}(r,e,n[t])}}applyToLocalView(e,t){for(let n of this.baseMutations)n.key.isEqual(e.key)&&(t=nO(n,e,t,this.localWriteTime));for(let n of this.mutations)n.key.isEqual(e.key)&&(t=nO(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){let n=nm();return this.mutations.forEach(r=>{let i=e.get(r.key),s=i.overlayedDocument,a=this.applyToLocalView(s,i.mutatedFields),o=nP(s,a=t.has(r.key)?null:a);null!==o&&n.set(r.key,o),s.isValidDocument()||s.convertToNoDocument(B.min())}),n}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),ny())}isEqual(e){return this.batchId===e.batchId&&q(this.mutations,e.mutations,(e,t)=>nq(e,t))&&q(this.baseMutations,e.baseMutations,(e,t)=>nq(e,t))}}class nW{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){e.mutations.length===n.length||E();let r=ng,i=e.mutations;for(let e=0;e<i.length;e++)r=r.insert(i[e].key,n[e].version);return new nW(e,t,n,r)}}class nJ{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class nH{constructor(e,t,n){this.alias=e,this.aggregateType=t,this.fieldPath=n}}class nY{constructor(e,t){this.count=e,this.unchangedNames=t}}function nX(e){switch(e){default:return E();case S.CANCELLED:case S.UNKNOWN:case S.DEADLINE_EXCEEDED:case S.RESOURCE_EXHAUSTED:case S.INTERNAL:case S.UNAVAILABLE:case S.UNAUTHENTICATED:return!1;case S.INVALID_ARGUMENT:case S.NOT_FOUND:case S.ALREADY_EXISTS:case S.PERMISSION_DENIED:case S.FAILED_PRECONDITION:case S.ABORTED:case S.OUT_OF_RANGE:case S.UNIMPLEMENTED:case S.DATA_LOSS:return!0}}function nZ(e){if(void 0===e)return _("GRPC error has no .code"),S.UNKNOWN;switch(e){case r.OK:return S.OK;case r.CANCELLED:return S.CANCELLED;case r.UNKNOWN:return S.UNKNOWN;case r.DEADLINE_EXCEEDED:return S.DEADLINE_EXCEEDED;case r.RESOURCE_EXHAUSTED:return S.RESOURCE_EXHAUSTED;case r.INTERNAL:return S.INTERNAL;case r.UNAVAILABLE:return S.UNAVAILABLE;case r.UNAUTHENTICATED:return S.UNAUTHENTICATED;case r.INVALID_ARGUMENT:return S.INVALID_ARGUMENT;case r.NOT_FOUND:return S.NOT_FOUND;case r.ALREADY_EXISTS:return S.ALREADY_EXISTS;case r.PERMISSION_DENIED:return S.PERMISSION_DENIED;case r.FAILED_PRECONDITION:return S.FAILED_PRECONDITION;case r.ABORTED:return S.ABORTED;case r.OUT_OF_RANGE:return S.OUT_OF_RANGE;case r.UNIMPLEMENTED:return S.UNIMPLEMENTED;case r.DATA_LOSS:return S.DATA_LOSS;default:return E()}}(i=r||(r={}))[i.OK=0]="OK",i[i.CANCELLED=1]="CANCELLED",i[i.UNKNOWN=2]="UNKNOWN",i[i.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",i[i.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",i[i.NOT_FOUND=5]="NOT_FOUND",i[i.ALREADY_EXISTS=6]="ALREADY_EXISTS",i[i.PERMISSION_DENIED=7]="PERMISSION_DENIED",i[i.UNAUTHENTICATED=16]="UNAUTHENTICATED",i[i.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",i[i.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",i[i.ABORTED=10]="ABORTED",i[i.OUT_OF_RANGE=11]="OUT_OF_RANGE",i[i.UNIMPLEMENTED=12]="UNIMPLEMENTED",i[i.INTERNAL=13]="INTERNAL",i[i.UNAVAILABLE=14]="UNAVAILABLE",i[i.DATA_LOSS=15]="DATA_LOSS";let n0=null;function n1(){return new TextEncoder}let n2=new f.Integer([0xffffffff,0xffffffff],0);function n5(e){let t=n1().encode(e),n=new f.Md5;return n.update(t),new Uint8Array(n.digest())}function n4(e){let t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new f.Integer([n,r],0),new f.Integer([i,s],0)]}class n8{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new n3(`Invalid padding: ${t}`);if(n<0||e.length>0&&0===this.hashCount)throw new n3(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new n3(`Invalid padding when bitmap length is 0: ${t}`);this.Ie=8*e.length-t,this.Te=f.Integer.fromNumber(this.Ie)}Ee(e,t,n){let r=e.add(t.multiply(f.Integer.fromNumber(n)));return 1===r.compare(n2)&&(r=new f.Integer([r.getBits(0),r.getBits(1)],0)),r.modulo(this.Te).toNumber()}de(e){return 0!=(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Ie)return!1;let[t,n]=n4(n5(e));for(let e=0;e<this.hashCount;e++){let r=this.Ee(t,n,e);if(!this.de(r))return!1}return!0}static create(e,t,n){let r=new n8(new Uint8Array(Math.ceil(e/8)),e%8==0?0:8-e%8,t);return n.forEach(e=>r.insert(e)),r}insert(e){if(0===this.Ie)return;let[t,n]=n4(n5(e));for(let e=0;e<this.hashCount;e++){let r=this.Ee(t,n,e);this.Ae(r)}}Ae(e){let t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class n3 extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class n6{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){let r=new Map;return r.set(e,n9.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new n6(B.min(),r,new eX(O),nc,ny())}}class n9{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new n9(n,t,ny(),ny(),ny())}}class n7{constructor(e,t,n,r){this.Re=e,this.removedTargetIds=t,this.key=n,this.Ve=r}}class re{constructor(e,t){this.targetId=e,this.me=t}}class rt{constructor(e,t,n=e3.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class rn{constructor(){this.fe=0,this.ge=rs(),this.pe=e3.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return 0!==this.fe}get be(){return this.we}De(e){e.approximateByteSize()>0&&(this.we=!0,this.pe=e)}ve(){let e=ny(),t=ny(),n=ny();return this.ge.forEach((r,i)=>{switch(i){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:E()}}),new n9(this.pe,this.ye,e,t,n)}Ce(){this.we=!1,this.ge=rs()}Fe(e,t){this.we=!0,this.ge=this.ge.insert(e,t)}Me(e){this.we=!0,this.ge=this.ge.remove(e)}xe(){this.fe+=1}Oe(){this.fe-=1,this.fe>=0||E()}Ne(){this.we=!0,this.ye=!0}}class rr{constructor(e){this.Le=e,this.Be=new Map,this.ke=nc,this.qe=ri(),this.Qe=new eX(O)}Ke(e){for(let t of e.Re)e.Ve&&e.Ve.isFoundDocument()?this.$e(t,e.Ve):this.Ue(t,e.key,e.Ve);for(let t of e.removedTargetIds)this.Ue(t,e.key,e.Ve)}We(e){this.forEachTarget(e,t=>{let n=this.Ge(t);switch(e.state){case 0:this.ze(t)&&n.De(e.resumeToken);break;case 1:n.Oe(),n.Se||n.Ce(),n.De(e.resumeToken);break;case 2:n.Oe(),n.Se||this.removeTarget(t);break;case 3:this.ze(t)&&(n.Ne(),n.De(e.resumeToken));break;case 4:this.ze(t)&&(this.je(t),n.De(e.resumeToken));break;default:E()}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Be.forEach((e,n)=>{this.ze(n)&&t(n)})}He(e){let t=e.targetId,n=e.me.count,r=this.Je(t);if(r){let i=r.target;if(tZ(i))if(0===n){let e=new Q(i.path);this.Ue(t,e,tD.newNoDocument(e,B.min()))}else 1===n||E();else{let r=this.Ye(t);if(r!==n){let n=this.Ze(e),i=n?this.Xe(n,e,r):1;0!==i&&(this.je(t),this.Qe=this.Qe.insert(t,2===i?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch")),null==n0||n0.et(function(e,t,n,r,i){var s,a,o,l,u,c;let h={localCacheCount:e,existenceFilterCount:t.count,databaseId:n.database,projectId:n.projectId},d=t.unchangedNames;return d&&(h.bloomFilter={applied:0===i,hashCount:null!=(s=null==d?void 0:d.hashCount)?s:0,bitmapLength:null!=(l=null==(o=null==(a=null==d?void 0:d.bits)?void 0:a.bitmap)?void 0:o.length)?l:0,padding:null!=(c=null==(u=null==d?void 0:d.bits)?void 0:u.padding)?c:0,mightContain:e=>{var t;return null!=(t=null==r?void 0:r.mightContain(e))&&t}}),h}(r,e.me,this.Le.tt(),n,i))}}}}Ze(e){let t,n,r=e.me.unchangedNames;if(!r||!r.bits)return null;let{bits:{bitmap:i="",padding:s=0},hashCount:a=0}=r;try{t=te(i).toUint8Array()}catch(e){if(e instanceof e8)return b("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{n=new n8(t,s,a)}catch(e){return b(e instanceof n3?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===n.Ie?null:n}Xe(e,t,n){return 2*(t.me.count!==n-this.nt(e,t.targetId))}nt(e,t){let n=this.Le.getRemoteKeysForTarget(t),r=0;return n.forEach(n=>{let i=this.Le.tt(),s=`projects/${i.projectId}/databases/${i.database}/documents/${n.path.canonicalString()}`;e.mightContain(s)||(this.Ue(t,n,null),r++)}),r}rt(e){let t=new Map;this.Be.forEach((n,r)=>{let i=this.Je(r);if(i){if(n.current&&tZ(i.target)){let t=new Q(i.target.path);null!==this.ke.get(t)||this.it(r,t)||this.Ue(r,t,tD.newNoDocument(t,e))}n.be&&(t.set(r,n.ve()),n.Ce())}});let n=ny();this.qe.forEach((e,t)=>{let r=!0;t.forEachWhile(e=>{let t=this.Je(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)}),r&&(n=n.add(e))}),this.ke.forEach((t,n)=>n.setReadTime(e));let r=new n6(e,t,this.Qe,this.ke,n);return this.ke=nc,this.qe=ri(),this.Qe=new eX(O),r}$e(e,t){if(!this.ze(e))return;let n=2*!!this.it(e,t.key);this.Ge(e).Fe(t.key,n),this.ke=this.ke.insert(t.key,t),this.qe=this.qe.insert(t.key,this.st(t.key).add(e))}Ue(e,t,n){if(!this.ze(e))return;let r=this.Ge(e);this.it(e,t)?r.Fe(t,1):r.Me(t),this.qe=this.qe.insert(t,this.st(t).delete(e)),n&&(this.ke=this.ke.insert(t,n))}removeTarget(e){this.Be.delete(e)}Ye(e){let t=this.Ge(e).ve();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}xe(e){this.Ge(e).xe()}Ge(e){let t=this.Be.get(e);return t||(t=new rn,this.Be.set(e,t)),t}st(e){let t=this.qe.get(e);return t||(t=new e1(O),this.qe=this.qe.insert(e,t)),t}ze(e){let t=null!==this.Je(e);return t||I("WatchChangeAggregator","Detected inactive target",e),t}Je(e){let t=this.Be.get(e);return t&&t.Se?null:this.Le.ot(e)}je(e){this.Be.set(e,new rn),this.Le.getRemoteKeysForTarget(e).forEach(t=>{this.Ue(e,t,null)})}it(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}}function ri(){return new eX(Q.comparator)}function rs(){return new eX(Q.comparator)}let ra={asc:"ASCENDING",desc:"DESCENDING"},ro={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},rl={and:"AND",or:"OR"};class ru{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function rc(e,t){return e.useProto3Json||eI(t)?t:{value:t}}function rh(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function rd(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function rf(e){return e||E(),B.fromTimestamp(function(e){let t=e9(e);return new U(t.seconds,t.nanos)}(e))}function rm(e,t){return rg(e,t).canonicalString()}function rg(e,t){let n=new G(["projects",e.projectId,"databases",e.database]).child("documents");return void 0===t?n:n.child(t)}function rp(e){let t=G.fromString(e);return rF(t)||E(),t}function ry(e,t){return rm(e.databaseId,t.path)}function rw(e,t){let n=rp(t);if(n.get(1)!==e.databaseId.projectId)throw new x(S.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new x(S.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new Q(rb(n))}function rv(e,t){return rm(e.databaseId,t)}function rI(e){let t=rp(e);return 4===t.length?G.emptyPath():rb(t)}function r_(e){return new G(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function rb(e){return e.length>4&&"documents"===e.get(4)||E(),e.popFirst(5)}function rT(e,t,n){return{name:ry(e,t),fields:n.value.mapValue.fields}}function rE(e,t,n){let r=rw(e,t.name),i=rf(t.updateTime),s=t.createTime?rf(t.createTime):B.min(),a=new tC({mapValue:{fields:t.fields}}),o=tD.newFoundDocument(r,i,s,a);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function rS(e,t){var n;let r;if(t instanceof nU)r={update:rT(e,t.key,t.value)};else if(t instanceof n$)r={delete:ry(e,t.key)};else if(t instanceof nB)r={update:rT(e,t.key,t.data),updateMask:function(e){let t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof nQ))return E();r={verify:ry(e,t.key)}}return t.fieldTransforms.length>0&&(r.updateTransforms=t.fieldTransforms.map(e=>(function(e,t){let n=t.transform;if(n instanceof nE)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof nS)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof nC)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof nN)return{fieldPath:t.field.canonicalString(),increment:n.Pe};throw E()})(0,e))),t.precondition.isNone||(r.currentDocument=void 0!==(n=t.precondition).updateTime?{updateTime:rh(e,n.updateTime.toTimestamp())}:void 0!==n.exists?{exists:n.exists}:E()),r}function rx(e,t){var n;let r=t.currentDocument?void 0!==(n=t.currentDocument).updateTime?nM.updateTime(rf(n.updateTime)):void 0!==n.exists?nM.exists(n.exists):nM.none():nM.none(),i=t.updateTransforms?t.updateTransforms.map(t=>{var n,r;let i;return n=e,i=null,"setToServerValue"in(r=t)?("REQUEST_TIME"===r.setToServerValue||E(),i=new nE):"appendMissingElements"in r?i=new nS(r.appendMissingElements.values||[]):"removeAllFromArray"in r?i=new nC(r.removeAllFromArray.values||[]):"increment"in r?i=new nN(n,r.increment):E(),new nR($.fromServerFormat(r.fieldPath),i)}):[];if(t.update){t.update.name;let n=rw(e,t.update.name),s=new tC({mapValue:{fields:t.update.fields}});return t.updateMask?new nB(n,s,new e4((t.updateMask.fieldPaths||[]).map(e=>$.fromServerFormat(e))),r,i):new nU(n,s,r,i)}return t.delete?new n$(rw(e,t.delete),r):t.verify?new nQ(rw(e,t.verify),r):E()}function rC(e,t){return{documents:[rv(e,t.path)]}}function rD(e,t){var n,r;let i,s={structuredQuery:{}},a=t.path;null!==t.collectionGroup?(i=a,s.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=a.popLast(),s.structuredQuery.from=[{collectionId:a.lastSegment()}]),s.parent=rv(e,i);let o=function(e){if(0!==e.length)return function e(t){return t instanceof tM?function(e){if("=="===e.op){if(tv(e.value))return{unaryFilter:{field:rk(e.field),op:"IS_NAN"}};if(tw(e.value))return{unaryFilter:{field:rk(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(tv(e.value))return{unaryFilter:{field:rk(e.field),op:"IS_NOT_NAN"}};if(tw(e.value))return{unaryFilter:{field:rk(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:rk(e.field),op:ro[e.op],value:e.value}}}(t):t instanceof tL?function(t){let n=t.getFilters().map(t=>e(t));return 1===n.length?n[0]:{compositeFilter:{op:rl[t.op],filters:n}}}(t):E()}(tL.create(e,"and"))}(t.filters);o&&(s.structuredQuery.where=o);let l=function(e){if(0!==e.length)return e.map(e=>({field:rk(e.field),direction:ra[e.dir]}))}(t.orderBy);l&&(s.structuredQuery.orderBy=l);let u=rc(e,t.limit);return null!==u&&(s.structuredQuery.limit=u),t.startAt&&(s.structuredQuery.startAt={before:(n=t.startAt).inclusive,values:n.position}),t.endAt&&(s.structuredQuery.endAt={before:!(r=t.endAt).inclusive,values:r.position}),{_t:s,parent:i}}function rN(e,t,n,r){let{_t:i,parent:s}=rD(e,t),a={},o=[],l=0;return n.forEach(e=>{let t=r?e.alias:"aggregate_"+l++;a[t]=e.alias,"count"===e.aggregateType?o.push({alias:t,count:{}}):"avg"===e.aggregateType?o.push({alias:t,avg:{field:rk(e.fieldPath)}}):"sum"===e.aggregateType&&o.push({alias:t,sum:{field:rk(e.fieldPath)}})}),{request:{structuredAggregationQuery:{aggregations:o,structuredQuery:i.structuredQuery},parent:i.parent},ut:a,parent:s}}function rA(e){var t;let n,r=rI(e.parent),i=e.structuredQuery,s=i.from?i.from.length:0,a=null;if(s>0){1===s||E();let e=i.from[0];e.allDescendants?a=e.collectionId:r=r.child(e.collectionId)}let o=[];i.where&&(o=function(e){let t=function e(t){return void 0!==t.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":let t=rR(e.unaryFilter.field);return tM.create(t,"==",{doubleValue:NaN});case"IS_NULL":let n=rR(e.unaryFilter.field);return tM.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let r=rR(e.unaryFilter.field);return tM.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let i=rR(e.unaryFilter.field);return tM.create(i,"!=",{nullValue:"NULL_VALUE"});default:return E()}}(t):void 0!==t.fieldFilter?tM.create(rR(t.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return E()}}(t.fieldFilter.op),t.fieldFilter.value):void 0!==t.compositeFilter?tL.create(t.compositeFilter.filters.map(t=>e(t)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return E()}}(t.compositeFilter.op)):E()}(e);return t instanceof tL&&tO(t)?t.getFilters():[t]}(i.where));let l=[];i.orderBy&&(l=i.orderBy.map(e=>new tR(rR(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))));let u=null;i.limit&&(u=eI(n="object"==typeof(t=i.limit)?t.value:t)?null:n);let c=null;i.startAt&&(c=function(e){let t=!!e.before;return new tN(e.values||[],t)}(i.startAt));let h=null;return i.endAt&&(h=function(e){let t=!e.before;return new tN(e.values||[],t)}(i.endAt)),new t5(r,a,l,o,u,"F",c,h)}function rk(e){return{fieldPath:e.canonicalString()}}function rR(e){return $.fromServerFormat(e.fieldPath)}function rF(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class rM{constructor(e,t,n,r,i=B.min(),s=B.min(),a=e3.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new rM(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new rM(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new rM(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new rM(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class rL{constructor(e){this.ct=e}}function rV(e,t){let n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:rP(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument()){var i;r.document={name:ry(i=e.ct,t.key),fields:t.data.value.mapValue.fields,updateTime:rh(i,t.version.toTimestamp()),createTime:rh(i,t.createTime.toTimestamp())}}else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:rO(t.version)};else{if(!t.isUnknownDocument())return E();r.unknownDocument={path:n.path.toArray(),version:rO(t.version)}}return r}function rP(e){let t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function rO(e){let t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function rq(e){let t=new U(e.seconds,e.nanoseconds);return B.fromTimestamp(t)}function rU(e,t){let n=(t.baseMutations||[]).map(t=>rx(e.ct,t));for(let e=0;e<t.mutations.length-1;++e){let n=t.mutations[e];e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform&&(n.updateTransforms=t.mutations[e+1].transform.fieldTransforms,t.mutations.splice(e+1,1),++e)}let r=t.mutations.map(t=>rx(e.ct,t)),i=U.fromMillis(t.localWriteTimeMs);return new nj(t.batchId,i,n,r)}function rB(e){var t;let n=rq(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?rq(e.lastLimboFreeSnapshotVersion):B.min();return new rM(void 0!==e.query.documents?(1===(t=e.query).documents.length||E(),t9(t4(rI(t.documents[0])))):t9(rA(e.query)),e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,n,r,e3.fromBase64String(e.resumeToken))}function rz(e,t){let n,r=rO(t.snapshotVersion),i=rO(t.lastLimboFreeSnapshotVersion);n=tZ(t.target)?rC(e.ct,t.target):rD(e.ct,t.target)._t;let s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:tY(t.target),readTime:r,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:i,query:n}}function rG(e){let t=rA({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?nn(t,t.limit,"L"):t}function rK(e,t){return new nJ(t.largestBatchId,rx(e.ct,t.overlayMutation))}function r$(e,t){let n=t.path.lastSegment();return[e,eT(t.path.popLast()),n]}function rQ(e,t,n,r){return{indexId:e,uid:t,sequenceNumber:n,readTime:rO(r.readTime),documentKey:eT(r.documentKey.path),largestBatchId:r.largestBatchId}}class rj{getBundleMetadata(e,t){return rW(e).get(t).next(e=>{if(e)return{id:e.bundleId,createTime:rq(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return rW(e).put({bundleId:t.id,createTime:rO(rf(t.createTime)),version:t.version})}getNamedQuery(e,t){return rJ(e).get(t).next(e=>{if(e)return{name:e.name,query:rG(e.bundledQuery),readTime:rq(e.readTime)}})}saveNamedQuery(e,t){return rJ(e).put({name:t.name,readTime:rO(rf(t.readTime)),bundledQuery:t.bundledQuery})}}function rW(e){return ej(e,"bundles")}function rJ(e){return ej(e,"namedQueries")}class rH{constructor(e,t){this.serializer=e,this.userId=t}static lt(e,t){return new rH(e,t.uid||"")}getOverlay(e,t){return rY(e).get(r$(this.userId,t)).next(e=>e?rK(this.serializer,e):null)}getOverlays(e,t){let n=nm();return ea.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){let r=[];return n.forEach((n,i)=>{let s=new nJ(t,i);r.push(this.ht(e,s))}),ea.waitFor(r)}removeOverlaysForBatchId(e,t,n){let r=new Set;t.forEach(e=>r.add(eT(e.getCollectionPath())));let i=[];return r.forEach(t=>{let r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);i.push(rY(e).j("collectionPathOverlayIndex",r))}),ea.waitFor(i)}getOverlaysForCollection(e,t,n){let r=nm(),i=eT(t),s=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,Number.POSITIVE_INFINITY],!0);return rY(e).U("collectionPathOverlayIndex",s).next(e=>{for(let t of e){let e=rK(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,r){let i,s=nm(),a=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return rY(e).J({index:"collectionGroupOverlayIndex",range:a},(e,t,n)=>{let a=rK(this.serializer,t);s.size()<r||a.largestBatchId===i?(s.set(a.getKey(),a),i=a.largestBatchId):n.done()}).next(()=>s)}ht(e,t){return rY(e).put(function(e,t,n){let[r,i,s]=r$(t,n.mutation.key);return{userId:t,collectionPath:i,documentId:s,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:rS(e.ct,n.mutation)}}(this.serializer,this.userId,t))}}function rY(e){return ej(e,"documentOverlays")}class rX{Pt(e){return ej(e,"globals")}getSessionToken(e){return this.Pt(e).get("sessionToken").next(e=>{let t=null==e?void 0:e.value;return t?e3.fromUint8Array(t):e3.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.Pt(e).put({name:"sessionToken",value:t.toUint8Array()})}}class rZ{constructor(){}It(e,t){this.Tt(e,t),t.Et()}Tt(e,t){if("nullValue"in e)this.dt(t,5);else if("booleanValue"in e)this.dt(t,10),t.At(+!!e.booleanValue);else if("integerValue"in e)this.dt(t,15),t.At(e7(e.integerValue));else if("doubleValue"in e){let n=e7(e.doubleValue);isNaN(n)?this.dt(t,13):(this.dt(t,15),e_(n)?t.At(0):t.At(n))}else if("timestampValue"in e){let n=e.timestampValue;this.dt(t,20),"string"==typeof n&&(n=e9(n)),t.Rt(`${n.seconds||""}`),t.At(n.nanos||0)}else if("stringValue"in e)this.Vt(e.stringValue,t),this.ft(t);else if("bytesValue"in e)this.dt(t,30),t.gt(te(e.bytesValue)),this.ft(t);else if("referenceValue"in e)this.yt(e.referenceValue,t);else if("geoPointValue"in e){let n=e.geoPointValue;this.dt(t,45),t.At(n.latitude||0),t.At(n.longitude||0)}else"mapValue"in e?tT(e)?this.dt(t,Number.MAX_SAFE_INTEGER):t_(e)?this.wt(e.mapValue,t):(this.St(e.mapValue,t),this.ft(t)):"arrayValue"in e?(this.bt(e.arrayValue,t),this.ft(t)):E()}Vt(e,t){this.dt(t,25),this.Dt(e,t)}Dt(e,t){t.Rt(e)}St(e,t){let n=e.fields||{};for(let e of(this.dt(t,55),Object.keys(n)))this.Vt(e,t),this.Tt(n[e],t)}wt(e,t){var n,r;let i=e.fields||{};this.dt(t,53);let s="value",a=(null==(r=null==(n=i[s].arrayValue)?void 0:n.values)?void 0:r.length)||0;this.dt(t,15),t.At(e7(a)),this.Vt(s,t),this.Tt(i[s],t)}bt(e,t){let n=e.values||[];for(let e of(this.dt(t,50),n))this.Tt(e,t)}yt(e,t){this.dt(t,37),Q.fromName(e).path.forEach(e=>{this.dt(t,60),this.Dt(e,t)})}dt(e,t){e.At(t)}ft(e){e.At(2)}}function r0(e){return Math.ceil((64-function(e){let t=0;for(let n=0;n<8;++n){let r=function(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}(255&e[n]);if(t+=r,8!==r)break}return t}(e))/8)}rZ.vt=new rZ;class r1{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ct(e){let t=e[Symbol.iterator](),n=t.next();for(;!n.done;)this.Ft(n.value),n=t.next();this.Mt()}xt(e){let t=e[Symbol.iterator](),n=t.next();for(;!n.done;)this.Ot(n.value),n=t.next();this.Nt()}Lt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.Ft(e);else if(e<2048)this.Ft(960|e>>>6),this.Ft(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ft(480|e>>>12),this.Ft(128|63&e>>>6),this.Ft(128|63&e);else{let e=t.codePointAt(0);this.Ft(240|e>>>18),this.Ft(128|63&e>>>12),this.Ft(128|63&e>>>6),this.Ft(128|63&e)}}this.Mt()}Bt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.Ot(e);else if(e<2048)this.Ot(960|e>>>6),this.Ot(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ot(480|e>>>12),this.Ot(128|63&e>>>6),this.Ot(128|63&e);else{let e=t.codePointAt(0);this.Ot(240|e>>>18),this.Ot(128|63&e>>>12),this.Ot(128|63&e>>>6),this.Ot(128|63&e)}}this.Nt()}kt(e){let t=this.qt(e),n=r0(t);this.Qt(1+n),this.buffer[this.position++]=255&n;for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=255&t[e]}Kt(e){let t=this.qt(e),n=r0(t);this.Qt(1+n),this.buffer[this.position++]=~(255&n);for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}$t(){this.Ut(255),this.Ut(255)}Wt(){this.Gt(255),this.Gt(255)}reset(){this.position=0}seed(e){this.Qt(e.length),this.buffer.set(e,this.position),this.position+=e.length}zt(){return this.buffer.slice(0,this.position)}qt(e){let t=function(e){let t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=255*!!n;return t}Ft(e){let t=255&e;0===t?(this.Ut(0),this.Ut(255)):255===t?(this.Ut(255),this.Ut(0)):this.Ut(t)}Ot(e){let t=255&e;0===t?(this.Gt(0),this.Gt(255)):255===t?(this.Gt(255),this.Gt(0)):this.Gt(e)}Mt(){this.Ut(0),this.Ut(1)}Nt(){this.Gt(0),this.Gt(1)}Ut(e){this.Qt(1),this.buffer[this.position++]=e}Gt(e){this.Qt(1),this.buffer[this.position++]=~e}Qt(e){let t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);let r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class r2{constructor(e){this.jt=e}gt(e){this.jt.Ct(e)}Rt(e){this.jt.Lt(e)}At(e){this.jt.kt(e)}Et(){this.jt.$t()}}class r5{constructor(e){this.jt=e}gt(e){this.jt.xt(e)}Rt(e){this.jt.Bt(e)}At(e){this.jt.Kt(e)}Et(){this.jt.Wt()}}class r4{constructor(){this.jt=new r1,this.Ht=new r2(this.jt),this.Jt=new r5(this.jt)}seed(e){this.jt.seed(e)}Yt(e){return 0===e?this.Ht:this.Jt}zt(){return this.jt.zt()}reset(){this.jt.reset()}}class r8{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Zt(){let e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new r8(this.indexId,this.documentKey,this.arrayValue,n)}}function r3(e,t){let n=e.indexId-t.indexId;return 0!==n||0!==(n=r6(e.arrayValue,t.arrayValue))||0!==(n=r6(e.directionalValue,t.directionalValue))?n:Q.comparator(e.documentKey,t.documentKey)}function r6(e,t){for(let n=0;n<e.length&&n<t.length;++n){let r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}class r9{constructor(e){for(let t of(this.Xt=new e1((e,t)=>$.comparator(e.field,t.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.en=e.orderBy,this.tn=[],e.filters))t.isInequality()?this.Xt=this.Xt.add(t):this.tn.push(t)}get nn(){return this.Xt.size>1}rn(e){if(e.collectionGroup===this.collectionId||E(),this.nn)return!1;let t=W(e);if(void 0!==t&&!this.sn(t))return!1;let n=J(e),r=new Set,i=0,s=0;for(;i<n.length&&this.sn(n[i]);++i)r=r.add(n[i].fieldPath.canonicalString());if(i===n.length)return!0;if(this.Xt.size>0){let e=this.Xt.getIterator().getNext();if(!r.has(e.field.canonicalString())){let t=n[i];if(!this.on(e,t)||!this._n(this.en[s++],t))return!1}++i}for(;i<n.length;++i){let e=n[i];if(s>=this.en.length||!this._n(this.en[s++],e))return!1}return!0}an(){if(this.nn)return null;let e=new e1($.comparator),t=[];for(let n of this.tn)if(!n.field.isKeyField())if("array-contains"===n.op||"array-contains-any"===n.op)t.push(new Y(n.field,2));else{if(e.has(n.field))continue;e=e.add(n.field),t.push(new Y(n.field,0))}for(let n of this.en)n.field.isKeyField()||e.has(n.field)||(e=e.add(n.field),t.push(new Y(n.field,+("asc"!==n.dir))));return new j(j.UNKNOWN_ID,this.collectionId,t,X.empty())}sn(e){for(let t of this.tn)if(this.on(t,e))return!0;return!1}on(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;let n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}_n(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function r7(e){return e instanceof tM}function ie(e){return e instanceof tL&&tO(e)}function it(e){return r7(e)||ie(e)||function(e){if(e instanceof tL&&tP(e)){for(let t of e.getFilters())if(!r7(t)&&!ie(t))return!1;return!0}return!1}(e)}function ir(e,t){return e instanceof tM||e instanceof tL||E(),t instanceof tM||t instanceof tL||E(),is(e instanceof tM?t instanceof tM?tL.create([e,t],"and"):ii(e,t):t instanceof tM?ii(t,e):function(e,t){if(e.filters.length>0&&t.filters.length>0||E(),tV(e)&&tV(t))return tU(e,t.getFilters());let n=tP(e)?e:t,r=tP(e)?t:e,i=n.filters.map(e=>ir(e,r));return tL.create(i,"or")}(e,t))}function ii(e,t){if(tV(t))return tU(t,e.getFilters());{let n=t.filters.map(t=>ir(e,t));return tL.create(n,"or")}}function is(e){if(e instanceof tM||e instanceof tL||E(),e instanceof tM)return e;let t=e.getFilters();if(1===t.length)return is(t[0]);if(tq(e))return e;let n=t.map(e=>is(e)),r=[];return n.forEach(t=>{t instanceof tM?r.push(t):t instanceof tL&&(t.op===e.op?r.push(...t.filters):r.push(t))}),1===r.length?r[0]:tL.create(r,e.op)}class ia{constructor(){this.un=new io}addToCollectionParentIndex(e,t){return this.un.add(t),ea.resolve()}getCollectionParents(e,t){return ea.resolve(this.un.getEntries(t))}addFieldIndex(e,t){return ea.resolve()}deleteFieldIndex(e,t){return ea.resolve()}deleteAllFieldIndexes(e){return ea.resolve()}createTargetIndexes(e,t){return ea.resolve()}getDocumentsMatchingTarget(e,t){return ea.resolve(null)}getIndexType(e,t){return ea.resolve(0)}getFieldIndexes(e,t){return ea.resolve([])}getNextCollectionGroupToUpdate(e){return ea.resolve(null)}getMinOffset(e,t){return ea.resolve(et.min())}getMinOffsetFromCollectionGroup(e,t){return ea.resolve(et.min())}updateCollectionGroup(e,t,n){return ea.resolve()}updateIndexEntries(e,t){return ea.resolve()}}class io{constructor(){this.index={}}add(e){let t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new e1(G.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}has(e){let t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new e1(G.comparator)).toArray()}}let il=new Uint8Array(0);class iu{constructor(e,t){this.databaseId=t,this.cn=new io,this.ln=new nu(e=>tY(e),(e,t)=>tX(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.cn.has(t)){let n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this.cn.add(t)});let i={collectionId:n,parent:eT(r)};return ic(e).put(i)}return ea.resolve()}getCollectionParents(e,t){let n=[],r=IDBKeyRange.bound([t,""],[t+"\0",""],!1,!0);return ic(e).U(r).next(e=>{for(let r of e){if(r.collectionId!==t)break;n.push(eE(r.parent))}return n})}addFieldIndex(e,t){let n=id(e),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;let i=n.add(r);if(t.indexState){let n=im(e);return i.next(e=>{n.put(rQ(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return i.next()}deleteFieldIndex(e,t){let n=id(e),r=im(e),i=ih(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){let t=id(e),n=ih(e),r=im(e);return t.j().next(()=>n.j()).next(()=>r.j())}createTargetIndexes(e,t){return ea.forEach(this.hn(t),t=>this.getIndexType(e,t).next(n=>{if(0===n||1===n){let n=new r9(t).an();if(null!=n)return this.addFieldIndex(e,n)}}))}getDocumentsMatchingTarget(e,t){let n=ih(e),r=!0,i=new Map;return ea.forEach(this.hn(t),t=>this.Pn(e,t).next(e=>{r&&(r=!!e),i.set(t,e)})).next(()=>{if(r){let e=ny(),r=[];return ea.forEach(i,(i,s)=>{I("IndexedDbIndexManager",`Using index id=${i.indexId}|cg=${i.collectionGroup}|f=${i.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")} to execute ${tY(t)}`);let a=function(e,t){let n=W(t);if(void 0===n)return null;for(let t of t0(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(s,i),o=function(e,t){let n=new Map;for(let r of J(t))for(let t of t0(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(s,i),l=function(e,t){let n=[],r=!0;for(let i of J(t)){let t=0===i.kind?t1(e,i.fieldPath,e.startAt):t2(e,i.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new tN(n,r)}(s,i),u=function(e,t){let n=[],r=!0;for(let i of J(t)){let t=0===i.kind?t2(e,i.fieldPath,e.endAt):t1(e,i.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new tN(n,r)}(s,i),c=this.In(i,s,l),h=this.In(i,s,u),d=this.Tn(i,s,o),f=this.En(i.indexId,a,c,l.inclusive,h,u.inclusive,d);return ea.forEach(f,i=>n.G(i,t.limit).next(t=>{t.forEach(t=>{let n=Q.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))})}))}).next(()=>r)}return ea.resolve(null)})}hn(e){let t=this.ln.get(e);return t||(t=0===e.filters.length?[e]:(function(e){if(0===e.getFilters().length)return[];let t=function e(t){if(t instanceof tM||t instanceof tL||E(),t instanceof tM)return t;if(1===t.filters.length)return e(t.filters[0]);let n=t.filters.map(t=>e(t)),r=tL.create(n,t.op);return it(r=is(r))?r:(r instanceof tL||E(),tV(r)||E(),r.filters.length>1||E(),r.filters.reduce((e,t)=>ir(e,t)))}(function e(t){var n,r;if(t instanceof tM||t instanceof tL||E(),t instanceof tM){if(t instanceof tQ){let e=(null==(r=null==(n=t.value.arrayValue)?void 0:n.values)?void 0:r.map(e=>tM.create(t.field,"==",e)))||[];return tL.create(e,"or")}return t}let i=t.filters.map(t=>e(t));return tL.create(i,t.op)}(e));return it(t)||E(),r7(t)||ie(t)?[t]:t.getFilters()})(tL.create(e.filters,"and")).map(t=>tH(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt)),this.ln.set(e,t)),t}En(e,t,n,r,i,s,a){let o=(null!=t?t.length:1)*Math.max(n.length,i.length),l=o/(null!=t?t.length:1),u=[];for(let c=0;c<o;++c){let o=t?this.dn(t[c/l]):il,h=this.An(e,o,n[c%l],r),d=this.Rn(e,o,i[c%l],s),f=a.map(t=>this.An(e,o,t,!0));u.push(...this.createRange(h,d,f))}return u}An(e,t,n,r){let i=new r8(e,Q.empty(),t,n);return r?i:i.Zt()}Rn(e,t,n,r){let i=new r8(e,Q.empty(),t,n);return r?i.Zt():i}Pn(e,t){let n=new r9(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next(e=>{let t=null;for(let r of e)n.rn(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t})}getIndexType(e,t){let n=2,r=this.hn(t);return ea.forEach(r,t=>this.Pn(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new e1($.comparator),n=!1;for(let r of e.filters)for(let e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(let n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+ +!!n}(t)&&(n=1):n=0})).next(()=>null!==t.limit&&r.length>1&&2===n?1:n)}Vn(e,t){let n=new r4;for(let r of J(e)){let e=t.data.field(r.fieldPath);if(null==e)return null;let i=n.Yt(r.kind);rZ.vt.It(e,i)}return n.zt()}dn(e){let t=new r4;return rZ.vt.It(e,t.Yt(0)),t.zt()}mn(e,t){let n=new r4;return rZ.vt.It(tg(this.databaseId,t),n.Yt(function(e){let t=J(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.zt()}Tn(e,t,n){if(null===n)return[];let r=[];r.push(new r4);let i=0;for(let s of J(e)){let e=n[i++];for(let n of r)if(this.fn(t,s.fieldPath)&&ty(e))r=this.gn(r,s,e);else{let t=n.Yt(s.kind);rZ.vt.It(e,t)}}return this.pn(r)}In(e,t,n){return this.Tn(e,t,n.position)}pn(e){let t=[];for(let n=0;n<e.length;++n)t[n]=e[n].zt();return t}gn(e,t,n){let r=[...e],i=[];for(let e of n.arrayValue.values||[])for(let n of r){let r=new r4;r.seed(n.zt()),rZ.vt.It(e,r.Yt(t.kind)),i.push(r)}return i}fn(e,t){return!!e.filters.find(e=>e instanceof tM&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){let n=id(e),r=im(e);return(t?n.U("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.U()).next(e=>{let t=[];return ea.forEach(e,e=>r.get([e.indexId,this.uid]).next(n=>{t.push(function(e,t){let n=t?new X(t.sequenceNumber,new et(rq(t.readTime),new Q(eE(t.documentKey)),t.largestBatchId)):X.empty(),r=e.fields.map(([e,t])=>new Y($.fromServerFormat(e),t));return new j(e.indexId,e.collectionGroup,r,n)}(e,n))})).next(()=>t)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{let n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:O(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,t,n){let r=id(e),i=im(e);return this.yn(e).next(e=>r.U("collectionGroupIndex",IDBKeyRange.bound(t,t)).next(t=>ea.forEach(t,t=>i.put(rQ(t.indexId,this.uid,e,n)))))}updateIndexEntries(e,t){let n=new Map;return ea.forEach(t,(t,r)=>{let i=n.get(t.collectionGroup);return(i?ea.resolve(i):this.getFieldIndexes(e,t.collectionGroup)).next(i=>(n.set(t.collectionGroup,i),ea.forEach(i,n=>this.wn(e,t,n).next(t=>{let i=this.Sn(r,n);return t.isEqual(i)?ea.resolve():this.bn(e,r,n,t,i)}))))})}Dn(e,t,n,r){return ih(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.mn(n,t.key),documentKey:t.key.path.toArray()})}vn(e,t,n,r){return ih(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.mn(n,t.key),t.key.path.toArray()])}wn(e,t,n){let r=ih(e),i=new e1(r3);return r.J({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.mn(n,t)])},(e,r)=>{i=i.add(new r8(n.indexId,t,r.arrayValue,r.directionalValue))}).next(()=>i)}Sn(e,t){let n=new e1(r3),r=this.Vn(t,e);if(null==r)return n;let i=W(t);if(null!=i){let s=e.data.field(i.fieldPath);if(ty(s))for(let i of s.arrayValue.values||[])n=n.add(new r8(t.indexId,e.key,this.dn(i),r))}else n=n.add(new r8(t.indexId,e.key,il,r));return n}bn(e,t,n,r,i){I("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);let s=[];return function(e,t,n,r,i){let s=e.getIterator(),a=t.getIterator(),o=e5(s),l=e5(a);for(;o||l;){let e=!1,t=!1;if(o&&l){let r=n(o,l);r<0?t=!0:r>0&&(e=!0)}else null!=o?t=!0:e=!0;e?(r(l),l=e5(a)):t?(i(o),o=e5(s)):(o=e5(s),l=e5(a))}}(r,i,r3,r=>{s.push(this.Dn(e,t,n,r))},r=>{s.push(this.vn(e,t,n,r))}),ea.waitFor(s)}yn(e){let t=1;return im(e).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,n,r)=>{r.done(),t=n.sequenceNumber+1}).next(()=>t)}createRange(e,t,n){n=n.sort((e,t)=>r3(e,t)).filter((e,t,n)=>!t||0!==r3(e,n[t-1]));let r=[];for(let i of(r.push(e),n)){let n=r3(i,e),s=r3(i,t);if(0===n)r[0]=e.Zt();else if(n>0&&s<0)r.push(i),r.push(i.Zt());else if(s>0)break}r.push(t);let i=[];for(let e=0;e<r.length;e+=2){if(this.Cn(r[e],r[e+1]))return[];let t=[r[e].indexId,this.uid,r[e].arrayValue,r[e].directionalValue,il,[]],n=[r[e+1].indexId,this.uid,r[e+1].arrayValue,r[e+1].directionalValue,il,[]];i.push(IDBKeyRange.bound(t,n))}return i}Cn(e,t){return r3(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(ig)}getMinOffset(e,t){return ea.mapArray(this.hn(t),t=>this.Pn(e,t).next(e=>e||E())).next(ig)}}function ic(e){return ej(e,"collectionParents")}function ih(e){return ej(e,"indexEntries")}function id(e){return ej(e,"indexConfiguration")}function im(e){return ej(e,"indexState")}function ig(e){0!==e.length||E();let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){let i=e[r].indexState.offset;0>en(i,t)&&(t=i),n<i.largestBatchId&&(n=i.largestBatchId)}return new et(t.readTime,t.documentKey,n)}let ip={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class iy{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new iy(e,iy.DEFAULT_COLLECTION_PERCENTILE,iy.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function iw(e,t,n){let r=e.store("mutations"),i=e.store("documentMutations"),s=[],a=IDBKeyRange.only(n.batchId),o=0,l=r.J({range:a},(e,t,n)=>(o++,n.delete()));s.push(l.next(()=>{1===o||E()}));let u=[];for(let e of n.mutations){var c,h;let r=(c=e.key.path,h=n.batchId,[t,eT(c),h]);s.push(i.delete(r)),u.push(e.key)}return ea.waitFor(s).next(()=>u)}function iv(e){let t;if(!e)return 0;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw E();t=e.noDocument}return JSON.stringify(t).length}iy.DEFAULT_COLLECTION_PERCENTILE=10,iy.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,iy.DEFAULT=new iy(0x2800000,iy.DEFAULT_COLLECTION_PERCENTILE,iy.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),iy.DISABLED=new iy(-1,0,0);class iI{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Fn={}}static lt(e,t,n,r){return""!==e.uid||E(),new iI(e.isAuthenticated()?e.uid:"",t,n,r)}checkEmpty(e){let t=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return ib(e).J({index:"userMutationsIndex",range:n},(e,n,r)=>{t=!1,r.done()}).next(()=>t)}addMutationBatch(e,t,n,r){let i=iT(e),s=ib(e);return s.add({}).next(a=>{var o,l;"number"==typeof a||E();let u=new nj(a,t,n,r),c=function(e,t,n){let r=n.baseMutations.map(t=>rS(e.ct,t)),i=n.mutations.map(t=>rS(e.ct,t));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:i}}(this.serializer,this.userId,u),h=[],d=new e1((e,t)=>O(e.canonicalString(),t.canonicalString()));for(let e of r){let t=(o=this.userId,l=e.key.path,[o,eT(l),a]);d=d.add(e.key.path.popLast()),h.push(s.put(c)),h.push(i.put(t,ex))}return d.forEach(t=>{h.push(this.indexManager.addToCollectionParentIndex(e,t))}),e.addOnCommittedListener(()=>{this.Fn[a]=u.keys()}),ea.waitFor(h).next(()=>u)})}lookupMutationBatch(e,t){return ib(e).get(t).next(e=>e?(e.userId===this.userId||E(),rU(this.serializer,e)):null)}Mn(e,t){return this.Fn[t]?ea.resolve(this.Fn[t]):this.lookupMutationBatch(e,t).next(e=>{if(e){let n=e.keys();return this.Fn[t]=n,n}return null})}getNextMutationBatchAfterBatchId(e,t){let n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]),i=null;return ib(e).J({index:"userMutationsIndex",range:r},(e,t,r)=>{t.userId===this.userId&&(t.batchId>=n||E(),i=rU(this.serializer,t)),r.done()}).next(()=>i)}getHighestUnacknowledgedBatchId(e){let t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),n=-1;return ib(e).J({index:"userMutationsIndex",range:t,reverse:!0},(e,t,r)=>{n=t.batchId,r.done()}).next(()=>n)}getAllMutationBatches(e){let t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return ib(e).U("userMutationsIndex",t).next(e=>e.map(e=>rU(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(e,t){let n=[this.userId,eT(t.path)],r=IDBKeyRange.lowerBound(n),i=[];return iT(e).J({range:r},(n,r,s)=>{let[a,o,l]=n,u=eE(o);if(a===this.userId&&t.path.isEqual(u))return ib(e).get(l).next(e=>{if(!e)throw E();e.userId===this.userId||E(),i.push(rU(this.serializer,e))});s.done()}).next(()=>i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new e1(O),r=[];return t.forEach(t=>{let i=[this.userId,eT(t.path)],s=IDBKeyRange.lowerBound(i),a=iT(e).J({range:s},(e,r,i)=>{let[s,a,o]=e,l=eE(a);s===this.userId&&t.path.isEqual(l)?n=n.add(o):i.done()});r.push(a)}),ea.waitFor(r).next(()=>this.xn(e,n))}getAllMutationBatchesAffectingQuery(e,t){let n=t.path,r=n.length+1,i=[this.userId,eT(n)],s=IDBKeyRange.lowerBound(i),a=new e1(O);return iT(e).J({range:s},(e,t,i)=>{let[s,o,l]=e,u=eE(o);s===this.userId&&n.isPrefixOf(u)?u.length===r&&(a=a.add(l)):i.done()}).next(()=>this.xn(e,a))}xn(e,t){let n=[],r=[];return t.forEach(t=>{r.push(ib(e).get(t).next(e=>{if(null===e)throw E();e.userId===this.userId||E(),n.push(rU(this.serializer,e))}))}),ea.waitFor(r).next(()=>n)}removeMutationBatch(e,t){return iw(e._e,this.userId,t).next(n=>(e.addOnCommittedListener(()=>{this.On(t.batchId)}),ea.forEach(n,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}On(e){delete this.Fn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return ea.resolve();let n=IDBKeyRange.lowerBound([this.userId]),r=[];return iT(e).J({range:n},(e,t,n)=>{if(e[0]===this.userId){let t=eE(e[1]);r.push(t)}else n.done()}).next(()=>{0===r.length||E()})})}containsKey(e,t){return i_(e,this.userId,t)}Nn(e){return iE(e).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function i_(e,t,n){let r=[t,eT(n.path)],i=r[1],s=IDBKeyRange.lowerBound(r),a=!1;return iT(e).J({range:s,H:!0},(e,n,r)=>{let[s,o,l]=e;s===t&&o===i&&(a=!0),r.done()}).next(()=>a)}function ib(e){return ej(e,"mutations")}function iT(e){return ej(e,"documentMutations")}function iE(e){return ej(e,"mutationQueues")}class iS{constructor(e){this.Ln=e}next(){return this.Ln+=2,this.Ln}static Bn(){return new iS(0)}static kn(){return new iS(-1)}}class ix{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.qn(e).next(t=>{let n=new iS(t.highestTargetId);return t.highestTargetId=n.next(),this.Qn(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.qn(e).next(e=>B.fromTimestamp(new U(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.qn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(e,t,n){return this.qn(e).next(r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.Qn(e,r)))}addTargetData(e,t){return this.Kn(e,t).next(()=>this.qn(e).next(n=>(n.targetCount+=1,this.$n(t,n),this.Qn(e,n))))}updateTargetData(e,t){return this.Kn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>iC(e).delete(t.targetId)).next(()=>this.qn(e)).next(t=>(t.targetCount>0||E(),t.targetCount-=1,this.Qn(e,t)))}removeTargets(e,t,n){let r=0,i=[];return iC(e).J((s,a)=>{let o=rB(a);o.sequenceNumber<=t&&null===n.get(o.targetId)&&(r++,i.push(this.removeTargetData(e,o)))}).next(()=>ea.waitFor(i)).next(()=>r)}forEachTarget(e,t){return iC(e).J((e,n)=>{t(rB(n))})}qn(e){return iD(e).get("targetGlobalKey").next(e=>(null!==e||E(),e))}Qn(e,t){return iD(e).put("targetGlobalKey",t)}Kn(e,t){return iC(e).put(rz(this.serializer,t))}$n(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.qn(e).next(e=>e.targetCount)}getTargetData(e,t){let n=tY(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]),i=null;return iC(e).J({range:r,index:"queryTargetsIndex"},(e,n,r)=>{let s=rB(n);tX(t,s.target)&&(i=s,r.done())}).next(()=>i)}addMatchingKeys(e,t,n){let r=[],i=iN(e);return t.forEach(t=>{let s=eT(t.path);r.push(i.put({targetId:n,path:s})),r.push(this.referenceDelegate.addReference(e,n,t))}),ea.waitFor(r)}removeMatchingKeys(e,t,n){let r=iN(e);return ea.forEach(t,t=>{let i=eT(t.path);return ea.waitFor([r.delete([n,i]),this.referenceDelegate.removeReference(e,n,t)])})}removeMatchingKeysForTargetId(e,t){let n=iN(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){let n=IDBKeyRange.bound([t],[t+1],!1,!0),r=iN(e),i=ny();return r.J({range:n,H:!0},(e,t,n)=>{let r=new Q(eE(e[1]));i=i.add(r)}).next(()=>i)}containsKey(e,t){let n=eT(t.path),r=IDBKeyRange.bound([n],[n+"\0"],!1,!0),i=0;return iN(e).J({index:"documentTargetsIndex",H:!0,range:r},([e,t],n,r)=>{0!==e&&(i++,r.done())}).next(()=>i>0)}ot(e,t){return iC(e).get(t).next(e=>e?rB(e):null)}}function iC(e){return ej(e,"targets")}function iD(e){return ej(e,"targetGlobal")}function iN(e){return ej(e,"targetDocuments")}function iA([e,t],[n,r]){let i=O(e,n);return 0===i?O(t,r):i}class ik{constructor(e){this.Un=e,this.buffer=new e1(iA),this.Wn=0}Gn(){return++this.Wn}zn(e){let t=[e,this.Gn()];if(this.buffer.size<this.Un)this.buffer=this.buffer.add(t);else{let e=this.buffer.last();0>iA(t,e)&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class iR{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.jn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Hn(6e4)}stop(){this.jn&&(this.jn.cancel(),this.jn=null)}get started(){return null!==this.jn}Hn(e){I("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.jn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.jn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){ed(e)?I("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await es(e)}await this.Hn(3e5)})}}class iF{constructor(e,t){this.Jn=e,this.params=t}calculateTargetCount(e,t){return this.Jn.Yn(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return ea.resolve(ev.oe);let n=new ik(t);return this.Jn.forEachTarget(e,e=>n.zn(e.sequenceNumber)).next(()=>this.Jn.Zn(e,e=>n.zn(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.Jn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.Jn.removeOrphanedDocuments(e,t)}collect(e,t){return -1===this.params.cacheSizeCollectionThreshold?(I("LruGarbageCollector","Garbage collection skipped; disabled"),ea.resolve(ip)):this.getCacheSize(e).next(n=>n<this.params.cacheSizeCollectionThreshold?(I("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),ip):this.Xn(e,t))}getCacheSize(e){return this.Jn.getCacheSize(e)}Xn(e,t){let n,r,i,s,a,o,l,u=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(t>this.params.maximumSequenceNumbersToCollect?(I("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,s=Date.now(),this.nthSequenceNumber(e,r))).next(r=>(n=r,a=Date.now(),this.removeTargets(e,n,t))).next(t=>(i=t,o=Date.now(),this.removeOrphanedDocuments(e,n))).next(e=>(l=Date.now(),v()<=h.LogLevel.DEBUG&&I("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${s-u}ms
	Determined least recently used ${r} in `+(a-s)+"ms\n"+`	Removed ${i} targets in `+(o-a)+"ms\n"+`	Removed ${e} documents in `+(l-o)+"ms\n"+`Total Duration: ${l-u}ms`),ea.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:i,documentsRemoved:e})))}}class iM{constructor(e,t){this.db=e,this.garbageCollector=new iF(this,t)}Yn(e){let t=this.er(e);return this.db.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}er(e){let t=0;return this.Zn(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Zn(e,t){return this.tr(e,(e,n)=>t(n))}addReference(e,t,n){return iL(e,n)}removeReference(e,t,n){return iL(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return iL(e,t)}nr(e,t){let n;return n=!1,iE(e).Y(r=>i_(e,r,t).next(e=>(e&&(n=!0),ea.resolve(!e)))).next(()=>n)}removeOrphanedDocuments(e,t){let n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[],i=0;return this.tr(e,(s,a)=>{if(a<=t){let t=this.nr(e,s).next(t=>{if(!t)return i++,n.getEntry(e,s).next(()=>(n.removeEntry(s,B.min()),iN(e).delete([0,eT(s.path)])))});r.push(t)}}).next(()=>ea.waitFor(r)).next(()=>n.apply(e)).next(()=>i)}removeTarget(e,t){let n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return iL(e,t)}tr(e,t){let n=iN(e),r,i=ev.oe;return n.J({index:"documentTargetsIndex"},([e,n],{path:s,sequenceNumber:a})=>{0===e?(i!==ev.oe&&t(new Q(eE(r)),i),i=a,r=s):i=ev.oe}).next(()=>{i!==ev.oe&&t(new Q(eE(r)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function iL(e,t){var n;return iN(e).put((n=e.currentSequenceNumber,{targetId:0,path:eT(t.path),sequenceNumber:n}))}class iV{constructor(){this.changes=new nu(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,tD.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();let n=this.changes.get(t);return void 0!==n?ea.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class iP{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return iU(e).put(n)}removeEntry(e,t,n){return iU(e).delete(function(e,t){let n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],rP(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next(n=>(n.byteSize+=t,this.rr(e,n)))}getEntry(e,t){let n=tD.newInvalidDocument(t);return iU(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(iB(t))},(e,r)=>{n=this.ir(t,r)}).next(()=>n)}sr(e,t){let n={size:0,document:tD.newInvalidDocument(t)};return iU(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(iB(t))},(e,r)=>{n={document:this.ir(t,r),size:iv(r)}}).next(()=>n)}getEntries(e,t){let n=nc;return this._r(e,t,(e,t)=>{let r=this.ir(e,t);n=n.insert(e,r)}).next(()=>n)}ar(e,t){let n=nc,r=new eX(Q.comparator);return this._r(e,t,(e,t)=>{let i=this.ir(e,t);n=n.insert(e,i),r=r.insert(e,iv(t))}).next(()=>({documents:n,ur:r}))}_r(e,t,n){if(t.isEmpty())return ea.resolve();let r=new e1(iG);t.forEach(e=>r=r.add(e));let i=IDBKeyRange.bound(iB(r.first()),iB(r.last())),s=r.getIterator(),a=s.getNext();return iU(e).J({index:"documentKeyIndex",range:i},(e,t,r)=>{let i=Q.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;a&&0>iG(a,i);)n(a,null),a=s.getNext();a&&a.isEqual(i)&&(n(a,t),a=s.hasNext()?s.getNext():null),a?r.$(iB(a)):r.done()}).next(()=>{for(;a;)n(a,null),a=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(e,t,n,r,i){let s=t.path,a=[s.popLast().toArray(),s.lastSegment(),rP(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return iU(e).U(IDBKeyRange.bound(a,o,!0)).next(e=>{null==i||i.incrementDocumentReadCount(e.length);let n=nc;for(let i of e){let e=this.ir(Q.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);e.isFoundDocument()&&(na(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n})}getAllFromCollectionGroup(e,t,n,r){let i=nc,s=iz(t,n),a=iz(t,et.max());return iU(e).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(s,a,!0)},(e,t,n)=>{let s=this.ir(Q.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);(i=i.insert(s.key,s)).size===r&&n.done()}).next(()=>i)}newChangeBuffer(e){return new iO(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return iq(e).get("remoteDocumentGlobalKey").next(e=>(e||E(),e))}rr(e,t){return iq(e).put("remoteDocumentGlobalKey",t)}ir(e,t){if(t){let e=function(e,t){let n;if(t.document)n=rE(e.ct,t.document,!!t.hasCommittedMutations);else if(t.noDocument){let e=Q.fromSegments(t.noDocument.path),r=rq(t.noDocument.readTime);n=tD.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return E();{let e=Q.fromSegments(t.unknownDocument.path),r=rq(t.unknownDocument.version);n=tD.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function(e){let t=new U(e[0],e[1]);return B.fromTimestamp(t)}(t.readTime)),n}(this.serializer,t);if(!(e.isNoDocument()&&e.version.isEqual(B.min())))return e}return tD.newInvalidDocument(e)}}class iO extends iV{constructor(e,t){super(),this.cr=e,this.trackRemovals=t,this.lr=new nu(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(e){let t=[],n=0,r=new e1((e,t)=>O(e.canonicalString(),t.canonicalString()));return this.changes.forEach((i,s)=>{let a=this.lr.get(i);if(t.push(this.cr.removeEntry(e,i,a.readTime)),s.isValidDocument()){let o=rV(this.cr.serializer,s);r=r.add(i.path.popLast());let l=iv(o);n+=l-a.size,t.push(this.cr.addEntry(e,i,o))}else if(n-=a.size,this.trackRemovals){let n=rV(this.cr.serializer,s.convertToNoDocument(B.min()));t.push(this.cr.addEntry(e,i,n))}}),r.forEach(n=>{t.push(this.cr.indexManager.addToCollectionParentIndex(e,n))}),t.push(this.cr.updateMetadata(e,n)),ea.waitFor(t)}getFromCache(e,t){return this.cr.sr(e,t).next(e=>(this.lr.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.cr.ar(e,t).next(({documents:e,ur:t})=>(t.forEach((t,n)=>{this.lr.set(t,{size:n,readTime:e.get(t).readTime})}),e))}}function iq(e){return ej(e,"remoteDocumentGlobal")}function iU(e){return ej(e,"remoteDocumentsV14")}function iB(e){let t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function iz(e,t){let n=t.documentKey.path.toArray();return[e,rP(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function iG(e,t){let n=e.path.toArray(),r=t.path.toArray(),i=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(i=O(n[e],r[e]))return i;return(i=O(n.length,r.length))||(i=O(n[n.length-2],r[r.length-2]))||O(n[n.length-1],r[r.length-1])}class iK{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class i${constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next(r=>(n=r,this.remoteDocumentCache.getEntry(e,t))).next(e=>(null!==n&&nO(n.mutation,e,e4.empty(),U.now()),e))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.getLocalViewOfDocuments(e,t,ny()).next(()=>t))}getLocalViewOfDocuments(e,t,n=ny()){let r=nm();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let t=nd();return e.forEach((e,n)=>{t=t.insert(e,n.overlayedDocument)}),t}))}getOverlayedDocuments(e,t){let n=nm();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,ny()))}populateOverlays(e,t,n){let r=[];return n.forEach(e=>{t.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,n)=>{t.set(e,n)})})}computeViews(e,t,n,r){let i=nc,s=nm(),a=nm();return t.forEach((e,t)=>{let a=n.get(t.key);r.has(t.key)&&(void 0===a||a.mutation instanceof nB)?i=i.insert(t.key,t):void 0!==a?(s.set(t.key,a.mutation.getFieldMask()),nO(a.mutation,t,a.mutation.getFieldMask(),U.now())):s.set(t.key,e4.empty())}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>s.set(e,t)),t.forEach((e,t)=>{var n;return a.set(e,new iK(t,null!=(n=s.get(e))?n:null))}),a))}recalculateAndSaveOverlays(e,t){let n=nm(),r=new eX((e,t)=>e-t),i=ny();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(e=>{for(let i of e)i.keys().forEach(e=>{let s=t.get(e);if(null===s)return;let a=n.get(e)||e4.empty();a=i.applyToLocalView(s,a),n.set(e,a);let o=(r.get(i.batchId)||ny()).add(e);r=r.insert(i.batchId,o)})}).next(()=>{let s=[],a=r.getReverseIterator();for(;a.hasNext();){let r=a.getNext(),o=r.key,l=r.value,u=nm();l.forEach(e=>{if(!i.has(e)){let r=nP(t.get(e),n.get(e));null!==r&&u.set(e,r),i=i.add(e)}}),s.push(this.documentOverlayCache.saveOverlays(e,o,u))}return ea.waitFor(s)}).next(()=>n)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.recalculateAndSaveOverlays(e,t))}getDocumentsMatchingQuery(e,t,n,r){return Q.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):t3(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next(i=>{let s=r-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-i.size):ea.resolve(nm()),a=-1,o=i;return s.next(t=>ea.forEach(t,(t,n)=>(a<n.largestBatchId&&(a=n.largestBatchId),i.get(t)?ea.resolve():this.remoteDocumentCache.getEntry(e,t).next(e=>{o=o.insert(t,e)}))).next(()=>this.populateOverlays(e,t,i)).next(()=>this.computeViews(e,o,t,ny())).next(e=>({batchId:a,changes:nf(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new Q(t)).next(e=>{let t=nd();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(e,t,n,r){let i=t.collectionGroup,s=nd();return this.indexManager.getCollectionParents(e,i).next(a=>ea.forEach(a,a=>{let o=new t5(a.child(i),null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt);return this.getDocumentsMatchingCollectionQuery(e,o,n,r).next(e=>{e.forEach((e,t)=>{s=s.insert(e,t)})})}).next(()=>s))}getDocumentsMatchingCollectionQuery(e,t,n,r){let i;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next(s=>(i=s,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,i,r))).next(e=>{i.forEach((t,n)=>{let r=n.getKey();null===e.get(r)&&(e=e.insert(r,tD.newInvalidDocument(r)))});let n=nd();return e.forEach((e,r)=>{let s=i.get(e);void 0!==s&&nO(s.mutation,r,e4.empty(),U.now()),na(t,r)&&(n=n.insert(e,r))}),n})}}class iQ{constructor(e){this.serializer=e,this.hr=new Map,this.Pr=new Map}getBundleMetadata(e,t){return ea.resolve(this.hr.get(t))}saveBundleMetadata(e,t){return this.hr.set(t.id,{id:t.id,version:t.version,createTime:rf(t.createTime)}),ea.resolve()}getNamedQuery(e,t){return ea.resolve(this.Pr.get(t))}saveNamedQuery(e,t){return this.Pr.set(t.name,{name:t.name,query:rG(t.bundledQuery),readTime:rf(t.readTime)}),ea.resolve()}}class ij{constructor(){this.overlays=new eX(Q.comparator),this.Ir=new Map}getOverlay(e,t){return ea.resolve(this.overlays.get(t))}getOverlays(e,t){let n=nm();return ea.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){return n.forEach((n,r)=>{this.ht(e,t,r)}),ea.resolve()}removeOverlaysForBatchId(e,t,n){let r=this.Ir.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.Ir.delete(n)),ea.resolve()}getOverlaysForCollection(e,t,n){let r=nm(),i=t.length+1,s=new Q(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){let e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return ea.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let i=new eX((e,t)=>e-t),s=this.overlays.getIterator();for(;s.hasNext();){let e=s.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=i.get(e.largestBatchId);null===t&&(t=nm(),i=i.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}let a=nm(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return ea.resolve(a)}ht(e,t,n){let r=this.overlays.get(n.key);if(null!==r){let e=this.Ir.get(r.largestBatchId).delete(n.key);this.Ir.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new nJ(t,n));let i=this.Ir.get(t);void 0===i&&(i=ny(),this.Ir.set(t,i)),this.Ir.set(t,i.add(n.key))}}class iW{constructor(){this.sessionToken=e3.EMPTY_BYTE_STRING}getSessionToken(e){return ea.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,ea.resolve()}}class iJ{constructor(){this.Tr=new e1(iH.Er),this.dr=new e1(iH.Ar)}isEmpty(){return this.Tr.isEmpty()}addReference(e,t){let n=new iH(e,t);this.Tr=this.Tr.add(n),this.dr=this.dr.add(n)}Rr(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.Vr(new iH(e,t))}mr(e,t){e.forEach(e=>this.removeReference(e,t))}gr(e){let t=new Q(new G([])),n=new iH(t,e),r=new iH(t,e+1),i=[];return this.dr.forEachInRange([n,r],e=>{this.Vr(e),i.push(e.key)}),i}pr(){this.Tr.forEach(e=>this.Vr(e))}Vr(e){this.Tr=this.Tr.delete(e),this.dr=this.dr.delete(e)}yr(e){let t=new Q(new G([])),n=new iH(t,e),r=new iH(t,e+1),i=ny();return this.dr.forEachInRange([n,r],e=>{i=i.add(e.key)}),i}containsKey(e){let t=new iH(e,0),n=this.Tr.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class iH{constructor(e,t){this.key=e,this.wr=t}static Er(e,t){return Q.comparator(e.key,t.key)||O(e.wr,t.wr)}static Ar(e,t){return O(e.wr,t.wr)||Q.comparator(e.key,t.key)}}class iY{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.Sr=1,this.br=new e1(iH.Er)}checkEmpty(e){return ea.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){let i=this.Sr;this.Sr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let s=new nj(i,t,n,r);for(let t of(this.mutationQueue.push(s),r))this.br=this.br.add(new iH(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return ea.resolve(s)}lookupMutationBatch(e,t){return ea.resolve(this.Dr(t))}getNextMutationBatchAfterBatchId(e,t){let n=this.vr(t+1),r=n<0?0:n;return ea.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return ea.resolve(0===this.mutationQueue.length?-1:this.Sr-1)}getAllMutationBatches(e){return ea.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){let n=new iH(t,0),r=new iH(t,Number.POSITIVE_INFINITY),i=[];return this.br.forEachInRange([n,r],e=>{let t=this.Dr(e.wr);i.push(t)}),ea.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new e1(O);return t.forEach(e=>{let t=new iH(e,0),r=new iH(e,Number.POSITIVE_INFINITY);this.br.forEachInRange([t,r],e=>{n=n.add(e.wr)})}),ea.resolve(this.Cr(n))}getAllMutationBatchesAffectingQuery(e,t){let n=t.path,r=n.length+1,i=n;Q.isDocumentKey(i)||(i=i.child(""));let s=new iH(new Q(i),0),a=new e1(O);return this.br.forEachWhile(e=>{let t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.wr)),!0)},s),ea.resolve(this.Cr(a))}Cr(e){let t=[];return e.forEach(e=>{let n=this.Dr(e);null!==n&&t.push(n)}),t}removeMutationBatch(e,t){0===this.Fr(t.batchId,"removed")||E(),this.mutationQueue.shift();let n=this.br;return ea.forEach(t.mutations,r=>{let i=new iH(r.key,t.batchId);return n=n.delete(i),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)}).next(()=>{this.br=n})}On(e){}containsKey(e,t){let n=new iH(t,0),r=this.br.firstAfterOrEqual(n);return ea.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,ea.resolve()}Fr(e,t){return this.vr(e)}vr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Dr(e){let t=this.vr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class iX{constructor(e){this.Mr=e,this.docs=new eX(Q.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){let n=t.key,r=this.docs.get(n),i=r?r.size:0,s=this.Mr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){let t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){let n=this.docs.get(t);return ea.resolve(n?n.document.mutableCopy():tD.newInvalidDocument(t))}getEntries(e,t){let n=nc;return t.forEach(e=>{let t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():tD.newInvalidDocument(e))}),ea.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=nc,s=t.path,a=new Q(s.child("")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){let{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||0>=en(ee(a),n)||(r.has(a.key)||na(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return ea.resolve(i)}getAllFromCollectionGroup(e,t,n,r){E()}Or(e,t){return ea.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new iZ(this)}getSize(e){return ea.resolve(this.size)}}class iZ extends iV{constructor(e){super(),this.cr=e}applyChanges(e){let t=[];return this.changes.forEach((n,r)=>{r.isValidDocument()?t.push(this.cr.addEntry(e,r)):this.cr.removeEntry(n)}),ea.waitFor(t)}getFromCache(e,t){return this.cr.getEntry(e,t)}getAllFromCache(e,t){return this.cr.getEntries(e,t)}}class i0{constructor(e){this.persistence=e,this.Nr=new nu(e=>tY(e),tX),this.lastRemoteSnapshotVersion=B.min(),this.highestTargetId=0,this.Lr=0,this.Br=new iJ,this.targetCount=0,this.kr=iS.Bn()}forEachTarget(e,t){return this.Nr.forEach((e,n)=>t(n)),ea.resolve()}getLastRemoteSnapshotVersion(e){return ea.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return ea.resolve(this.Lr)}allocateTargetId(e){return this.highestTargetId=this.kr.next(),ea.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Lr&&(this.Lr=t),ea.resolve()}Kn(e){this.Nr.set(e.target,e);let t=e.targetId;t>this.highestTargetId&&(this.kr=new iS(t),this.highestTargetId=t),e.sequenceNumber>this.Lr&&(this.Lr=e.sequenceNumber)}addTargetData(e,t){return this.Kn(t),this.targetCount+=1,ea.resolve()}updateTargetData(e,t){return this.Kn(t),ea.resolve()}removeTargetData(e,t){return this.Nr.delete(t.target),this.Br.gr(t.targetId),this.targetCount-=1,ea.resolve()}removeTargets(e,t,n){let r=0,i=[];return this.Nr.forEach((s,a)=>{a.sequenceNumber<=t&&null===n.get(a.targetId)&&(this.Nr.delete(s),i.push(this.removeMatchingKeysForTargetId(e,a.targetId)),r++)}),ea.waitFor(i).next(()=>r)}getTargetCount(e){return ea.resolve(this.targetCount)}getTargetData(e,t){let n=this.Nr.get(t)||null;return ea.resolve(n)}addMatchingKeys(e,t,n){return this.Br.Rr(t,n),ea.resolve()}removeMatchingKeys(e,t,n){this.Br.mr(t,n);let r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(t=>{i.push(r.markPotentiallyOrphaned(e,t))}),ea.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.Br.gr(t),ea.resolve()}getMatchingKeysForTargetId(e,t){let n=this.Br.yr(t);return ea.resolve(n)}containsKey(e,t){return ea.resolve(this.Br.containsKey(t))}}class i1{constructor(e,t){this.qr={},this.overlays={},this.Qr=new ev(0),this.Kr=!1,this.Kr=!0,this.$r=new iW,this.referenceDelegate=e(this),this.Ur=new i0(this),this.indexManager=new ia,this.remoteDocumentCache=new iX(e=>this.referenceDelegate.Wr(e)),this.serializer=new rL(t),this.Gr=new iQ(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Kr=!1,Promise.resolve()}get started(){return this.Kr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new ij,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.qr[e.toKey()];return n||(n=new iY(t,this.referenceDelegate),this.qr[e.toKey()]=n),n}getGlobalsCache(){return this.$r}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Gr}runTransaction(e,t,n){I("MemoryPersistence","Starting transaction:",e);let r=new i2(this.Qr.next());return this.referenceDelegate.zr(),n(r).next(e=>this.referenceDelegate.jr(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Hr(e,t){return ea.or(Object.values(this.qr).map(n=>()=>n.containsKey(e,t)))}}class i2 extends ei{constructor(e){super(),this.currentSequenceNumber=e}}class i5{constructor(e){this.persistence=e,this.Jr=new iJ,this.Yr=null}static Zr(e){return new i5(e)}get Xr(){if(this.Yr)return this.Yr;throw E()}addReference(e,t,n){return this.Jr.addReference(n,t),this.Xr.delete(n.toString()),ea.resolve()}removeReference(e,t,n){return this.Jr.removeReference(n,t),this.Xr.add(n.toString()),ea.resolve()}markPotentiallyOrphaned(e,t){return this.Xr.add(t.toString()),ea.resolve()}removeTarget(e,t){this.Jr.gr(t.targetId).forEach(e=>this.Xr.add(e.toString()));let n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.Xr.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}zr(){this.Yr=new Set}jr(e){let t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return ea.forEach(this.Xr,n=>{let r=Q.fromPath(n);return this.ei(e,r).next(e=>{e||t.removeEntry(r,B.min())})}).next(()=>(this.Yr=null,t.apply(e)))}updateLimboDocument(e,t){return this.ei(e,t).next(e=>{e?this.Xr.delete(t.toString()):this.Xr.add(t.toString())})}Wr(e){return 0}ei(e,t){return ea.or([()=>ea.resolve(this.Jr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Hr(e,t)])}}class i4{constructor(e,t){this.persistence=e,this.ti=new nu(e=>eT(e.path),(e,t)=>e.isEqual(t)),this.garbageCollector=new iF(this,t)}static Zr(e,t){return new i4(e,t)}zr(){}jr(e){return ea.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}Yn(e){let t=this.er(e);return this.persistence.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}er(e){let t=0;return this.Zn(e,e=>{t++}).next(()=>t)}Zn(e,t){return ea.forEach(this.ti,(n,r)=>this.nr(e,n,r).next(e=>e?ea.resolve():t(r)))}removeTargets(e,t,n){return this.persistence.getTargetCache().removeTargets(e,t,n)}removeOrphanedDocuments(e,t){let n=0,r=this.persistence.getRemoteDocumentCache(),i=r.newChangeBuffer();return r.Or(e,r=>this.nr(e,r,t).next(e=>{e||(n++,i.removeEntry(r,B.min()))})).next(()=>i.apply(e)).next(()=>n)}markPotentiallyOrphaned(e,t){return this.ti.set(t,e.currentSequenceNumber),ea.resolve()}removeTarget(e,t){let n=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,n)}addReference(e,t,n){return this.ti.set(n,e.currentSequenceNumber),ea.resolve()}removeReference(e,t,n){return this.ti.set(n,e.currentSequenceNumber),ea.resolve()}updateLimboDocument(e,t){return this.ti.set(t,e.currentSequenceNumber),ea.resolve()}Wr(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=function e(t){switch(tl(t)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:let n=tn(t);return n?16+e(n):16;case 5:return 2*t.stringValue.length;case 6:return te(t.bytesValue).approximateByteSize();case 7:return t.referenceValue.length;case 9:return(t.arrayValue.values||[]).reduce((t,n)=>t+e(n),0);case 10:case 11:var r;let i;return r=t.mapValue,i=0,eJ(r.fields,(t,n)=>{i+=t.length+e(n)}),i;default:throw E()}}(e.data.value)),t}nr(e,t,n){return ea.or([()=>this.persistence.Hr(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{let e=this.ti.get(t);return ea.resolve(void 0!==e&&e>n)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class i8{constructor(e){this.serializer=e}O(e,t,n,r){let i=new eo("createOrUpgrade",t);n<1&&r>=1&&(e.createObjectStore("owner"),e.createObjectStore("mutationQueues",{keyPath:"userId"}),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",eS,{unique:!0}),e.createObjectStore("documentMutations"),i3(e),e.createObjectStore("remoteDocuments"));let s=ea.resolve();return n<3&&r>=3&&(0!==n&&(e.deleteObjectStore("targetDocuments"),e.deleteObjectStore("targets"),e.deleteObjectStore("targetGlobal"),i3(e)),s=s.next(()=>(function(e){let t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:B.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)})(i))),n<4&&r>=4&&(0!==n&&(s=s.next(()=>i.store("mutations").U().next(t=>{e.deleteObjectStore("mutations"),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",eS,{unique:!0});let n=i.store("mutations"),r=t.map(e=>n.put(e));return ea.waitFor(r)}))),s=s.next(()=>{e.createObjectStore("clientMetadata",{keyPath:"clientId"})})),n<5&&r>=5&&(s=s.next(()=>this.ni(i))),n<6&&r>=6&&(s=s.next(()=>(e.createObjectStore("remoteDocumentGlobal"),this.ri(i)))),n<7&&r>=7&&(s=s.next(()=>this.ii(i))),n<8&&r>=8&&(s=s.next(()=>this.si(e,i))),n<9&&r>=9&&(s=s.next(()=>{e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&r>=10&&(s=s.next(()=>this.oi(i))),n<11&&r>=11&&(s=s.next(()=>{e.createObjectStore("bundles",{keyPath:"bundleId"}),e.createObjectStore("namedQueries",{keyPath:"name"})})),n<12&&r>=12&&(s=s.next(()=>{let t=e.createObjectStore("documentOverlays",{keyPath:eO});t.createIndex("collectionPathOverlayIndex",eq,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",eU,{unique:!1})})),n<13&&r>=13&&(s=s.next(()=>(function(e){let t=e.createObjectStore("remoteDocumentsV14",{keyPath:eC});t.createIndex("documentKeyIndex",eD),t.createIndex("collectionGroupIndex",eN)})(e)).next(()=>this._i(e,i)).next(()=>e.deleteObjectStore("remoteDocuments"))),n<14&&r>=14&&(s=s.next(()=>this.ai(e,i))),n<15&&r>=15&&(s=s.next(()=>{e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:eM}).createIndex("sequenceNumberIndex",eL,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:eV}).createIndex("documentKeyIndex",eP,{unique:!1})})),n<16&&r>=16&&(s=s.next(()=>{t.objectStore("indexState").clear()}).next(()=>{t.objectStore("indexEntries").clear()})),n<17&&r>=17&&(s=s.next(()=>{e.createObjectStore("globals",{keyPath:"name"})})),s}ri(e){let t=0;return e.store("remoteDocuments").J((e,n)=>{t+=iv(n)}).next(()=>{let n={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)})}ni(e){let t=e.store("mutationQueues"),n=e.store("mutations");return t.U().next(t=>ea.forEach(t,t=>{let r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.U("userMutationsIndex",r).next(n=>ea.forEach(n,n=>{n.userId===t.userId||E();let r=rU(this.serializer,n);return iw(e,t.userId,r).next(()=>{})}))}))}ii(e){let t=e.store("targetDocuments"),n=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(e=>{let r=[];return n.J((n,i)=>{let s=new G(n),a=[0,eT(s)];r.push(t.get(a).next(n=>n?ea.resolve():t.put({targetId:0,path:eT(s),sequenceNumber:e.highestListenSequenceNumber})))}).next(()=>ea.waitFor(r))})}si(e,t){e.createObjectStore("collectionParents",{keyPath:eF});let n=t.store("collectionParents"),r=new io,i=e=>{if(r.add(e)){let t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:eT(r)})}};return t.store("remoteDocuments").J({H:!0},(e,t)=>i(new G(e).popLast())).next(()=>t.store("documentMutations").J({H:!0},([e,t,n],r)=>i(eE(t).popLast())))}oi(e){let t=e.store("targets");return t.J((e,n)=>{let r=rB(n),i=rz(this.serializer,r);return t.put(i)})}_i(e,t){let n=t.store("remoteDocuments"),r=[];return n.J((e,n)=>{let i=t.store("remoteDocumentsV14"),s=(n.document?new Q(G.fromString(n.document.name).popFirst(5)):n.noDocument?Q.fromSegments(n.noDocument.path):n.unknownDocument?Q.fromSegments(n.unknownDocument.path):E()).path.toArray(),a={prefixPath:s.slice(0,s.length-2),collectionGroup:s[s.length-2],documentId:s[s.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(i.put(a))}).next(()=>ea.waitFor(r))}ai(e,t){let n=t.store("mutations"),r=new iP(this.serializer),i=new i1(i5.Zr,this.serializer.ct);return n.U().next(e=>{let n=new Map;return e.forEach(e=>{var t;let r=null!=(t=n.get(e.userId))?t:ny();rU(this.serializer,e).keys().forEach(e=>r=r.add(e)),n.set(e.userId,r)}),ea.forEach(n,(e,n)=>{let s=new p(n),a=rH.lt(this.serializer,s),o=i.getIndexManager(s);return new i$(r,iI.lt(s,this.serializer,o,i.referenceDelegate),a,o).recalculateAndSaveOverlaysForDocumentKeys(new eQ(t,ev.oe),e).next()})})}}function i3(e){e.createObjectStore("targetDocuments",{keyPath:ek}).createIndex("documentTargetsIndex",eR,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",eA,{unique:!0}),e.createObjectStore("targetGlobal")}let i6="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class i9{constructor(e,t,n,r,i,s,a,o,l,u,c=17){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.ui=i,this.window=s,this.document=a,this.ci=l,this.li=u,this.hi=c,this.Qr=null,this.Kr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Pi=null,this.inForeground=!1,this.Ii=null,this.Ti=null,this.Ei=Number.NEGATIVE_INFINITY,this.di=e=>Promise.resolve(),!i9.D())throw new x(S.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new iM(this,r),this.Ai=t+"main",this.serializer=new rL(o),this.Ri=new el(this.Ai,this.hi,new i8(this.serializer)),this.$r=new rX,this.Ur=new ix(this.referenceDelegate,this.serializer),this.remoteDocumentCache=new iP(this.serializer),this.Gr=new rj,this.window&&this.window.localStorage?this.Vi=this.window.localStorage:(this.Vi=null,!1===u&&_("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.mi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new x(S.FAILED_PRECONDITION,i6);return this.fi(),this.gi(),this.pi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Ur.getHighestSequenceNumber(e))}).then(e=>{this.Qr=new ev(e,this.ci)}).then(()=>{this.Kr=!0}).catch(e=>(this.Ri&&this.Ri.close(),Promise.reject(e)))}yi(e){return this.di=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ri.L(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.ui.enqueueAndForget(async()=>{this.started&&await this.mi()}))}mi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>se(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.wi(e).next(e=>{e||(this.isPrimary=!1,this.ui.enqueueRetryable(()=>this.di(!1)))})}).next(()=>this.Si(e)).next(t=>this.isPrimary&&!t?this.bi(e).next(()=>!1):!!t&&this.Di(e).next(()=>!0))).catch(e=>{if(ed(e))return I("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return I("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.ui.enqueueRetryable(()=>this.di(e)),this.isPrimary=e})}wi(e){return i7(e).get("owner").next(e=>ea.resolve(this.vi(e)))}Ci(e){return se(e).delete(this.clientId)}async Fi(){if(this.isPrimary&&!this.Mi(this.Ei,18e5)){this.Ei=Date.now();let e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{let t=ej(e,"clientMetadata");return t.U().next(e=>{let n=this.xi(e,18e5),r=e.filter(e=>-1===n.indexOf(e));return ea.forEach(r,e=>t.delete(e.clientId)).next(()=>r)})}).catch(()=>[]);if(this.Vi)for(let t of e)this.Vi.removeItem(this.Oi(t.clientId))}}pi(){this.Ti=this.ui.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.mi().then(()=>this.Fi()).then(()=>this.pi()))}vi(e){return!!e&&e.ownerId===this.clientId}Si(e){return this.li?ea.resolve(!0):i7(e).get("owner").next(t=>{if(null!==t&&this.Mi(t.leaseTimestampMs,5e3)&&!this.Ni(t.ownerId)){if(this.vi(t)&&this.networkEnabled)return!0;if(!this.vi(t)){if(!t.allowTabSynchronization)throw new x(S.FAILED_PRECONDITION,i6);return!1}}return!(!this.networkEnabled||!this.inForeground)||se(e).U().next(e=>void 0===this.xi(e,5e3).find(e=>{if(this.clientId!==e.clientId){let t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&I("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.Kr=!1,this.Li(),this.Ti&&(this.Ti.cancel(),this.Ti=null),this.Bi(),this.ki(),await this.Ri.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{let t=new eQ(e,ev.oe);return this.bi(t).next(()=>this.Ci(t))}),this.Ri.close(),this.qi()}xi(e,t){return e.filter(e=>this.Mi(e.updateTimeMs,t)&&!this.Ni(e.clientId))}Qi(){return this.runTransaction("getActiveClients","readonly",e=>se(e).U().next(e=>this.xi(e,18e5).map(e=>e.clientId)))}get started(){return this.Kr}getGlobalsCache(){return this.$r}getMutationQueue(e,t){return iI.lt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new iu(e,this.serializer.ct.databaseId)}getDocumentOverlayCache(e){return rH.lt(this.serializer,e)}getBundleCache(){return this.Gr}runTransaction(e,t,n){var r;let i;I("IndexedDbPersistence","Starting transaction:",e);let s=17===(r=this.hi)?e$:16===r||15===r?eK:14===r||13===r?eG:12===r?ez:11===r?eB:void E();return this.Ri.runTransaction(e,"readonly"===t?"readonly":"readwrite",s,r=>(i=new eQ(r,this.Qr?this.Qr.next():ev.oe),"readwrite-primary"===t?this.wi(i).next(e=>!!e||this.Si(i)).next(t=>{if(!t)throw _(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.ui.enqueueRetryable(()=>this.di(!1)),new x(S.FAILED_PRECONDITION,er);return n(i)}).next(e=>this.Di(i).next(()=>e)):this.Ki(i).next(()=>n(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}Ki(e){return i7(e).get("owner").next(e=>{if(null!==e&&this.Mi(e.leaseTimestampMs,5e3)&&!this.Ni(e.ownerId)&&!this.vi(e)&&!(this.li||this.allowTabSynchronization&&e.allowTabSynchronization))throw new x(S.FAILED_PRECONDITION,i6)})}Di(e){let t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return i7(e).put("owner",t)}static D(){return el.D()}bi(e){let t=i7(e);return t.get("owner").next(e=>this.vi(e)?(I("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):ea.resolve())}Mi(e,t){let n=Date.now();return!(e<n-t)&&(!(e>n)||(_(`Detected an update time that is in the future: ${e} > ${n}`),!1))}fi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ii=()=>{this.ui.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.mi()))},this.document.addEventListener("visibilitychange",this.Ii),this.inForeground="visible"===this.document.visibilityState)}Bi(){this.Ii&&(this.document.removeEventListener("visibilitychange",this.Ii),this.Ii=null)}gi(){var e;"function"==typeof(null==(e=this.window)?void 0:e.addEventListener)&&(this.Pi=()=>{this.Li();let e=/(?:Version|Mobile)\/1[456]/;d.isSafari()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.ui.enterRestrictedMode(!0),this.ui.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Pi))}ki(){this.Pi&&(this.window.removeEventListener("pagehide",this.Pi),this.Pi=null)}Ni(e){var t;try{let n=null!==(null==(t=this.Vi)?void 0:t.getItem(this.Oi(e)));return I("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return _("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Li(){if(this.Vi)try{this.Vi.setItem(this.Oi(this.clientId),String(Date.now()))}catch(e){_("Failed to set zombie client id.",e)}}qi(){if(this.Vi)try{this.Vi.removeItem(this.Oi(this.clientId))}catch(e){}}Oi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function i7(e){return ej(e,"owner")}function se(e){return ej(e,"clientMetadata")}function st(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class sn{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.$i=n,this.Ui=r}static Wi(e,t){let n=ny(),r=ny();for(let e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new sn(e,t.fromCache,n,r)}}class sr{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class si{constructor(){this.Gi=!1,this.zi=!1,this.ji=100,this.Hi=d.isSafari()?8:eu(d.getUA())>0?6:4}initialize(e,t){this.Ji=e,this.indexManager=t,this.Gi=!0}getDocumentsMatchingQuery(e,t,n,r){let i={result:null};return this.Yi(e,t).next(e=>{i.result=e}).next(()=>{if(!i.result)return this.Zi(e,t,r,n).next(e=>{i.result=e})}).next(()=>{if(i.result)return;let n=new sr;return this.Xi(e,t,n).next(r=>{if(i.result=r,this.zi)return this.es(e,t,n,r.size)})}).next(()=>i.result)}es(e,t,n,r){return n.documentReadCount<this.ji?(v()<=h.LogLevel.DEBUG&&I("QueryEngine","SDK will not create cache indexes for query:",ns(t),"since it only creates cache indexes for collection contains","more than or equal to",this.ji,"documents"),ea.resolve()):(v()<=h.LogLevel.DEBUG&&I("QueryEngine","Query:",ns(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.Hi*r?(v()<=h.LogLevel.DEBUG&&I("QueryEngine","The SDK decides to create cache indexes for query:",ns(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,t9(t))):ea.resolve())}Yi(e,t){if(t8(t))return ea.resolve(null);let n=t9(t);return this.indexManager.getIndexType(e,n).next(r=>0===r?null:(null!==t.limit&&1===r&&(n=t9(t=nn(t,null,"F"))),this.indexManager.getDocumentsMatchingTarget(e,n).next(r=>{let i=ny(...r);return this.Ji.getDocuments(e,i).next(r=>this.indexManager.getMinOffset(e,n).next(n=>{let s=this.ts(t,r);return this.ns(t,s,i,n.readTime)?this.Yi(e,nn(t,null,"F")):this.rs(e,s,t,n)}))})))}Zi(e,t,n,r){return t8(t)||r.isEqual(B.min())?ea.resolve(null):this.Ji.getDocuments(e,n).next(i=>{let s=this.ts(t,i);return this.ns(t,s,n,r)?ea.resolve(null):(v()<=h.LogLevel.DEBUG&&I("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),ns(t)),this.rs(e,s,t,Z(r,-1)).next(e=>e))})}ts(e,t){let n=new e1(nl(e));return t.forEach((t,r)=>{na(e,r)&&(n=n.add(r))}),n}ns(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;let i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(r)>0)}Xi(e,t,n){return v()<=h.LogLevel.DEBUG&&I("QueryEngine","Using full collection scan to execute query:",ns(t)),this.Ji.getDocumentsMatchingQuery(e,t,et.min(),n)}rs(e,t,n,r){return this.Ji.getDocumentsMatchingQuery(e,n,r).next(e=>(t.forEach(t=>{e=e.insert(t.key,t)}),e))}}class ss{constructor(e,t,n,r){this.persistence=e,this.ss=t,this.serializer=r,this.os=new eX(O),this._s=new nu(e=>tY(e),tX),this.us=new Map,this.cs=e.getRemoteDocumentCache(),this.Ur=e.getTargetCache(),this.Gr=e.getBundleCache(),this.ls(n)}ls(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new i$(this.cs,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.cs.setIndexManager(this.indexManager),this.ss.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.os))}}async function sa(e,t){return await e.persistence.runTransaction("Handle user change","readonly",n=>{let r;return e.mutationQueue.getAllMutationBatches(n).next(i=>(r=i,e.ls(t),e.mutationQueue.getAllMutationBatches(n))).next(t=>{let i=[],s=[],a=ny();for(let e of r)for(let t of(i.push(e.batchId),e.mutations))a=a.add(t.key);for(let e of t)for(let t of(s.push(e.batchId),e.mutations))a=a.add(t.key);return e.localDocuments.getDocuments(n,a).next(e=>({hs:e,removedBatchIds:i,addedBatchIds:s}))})})}function so(e){return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Ur.getLastRemoteSnapshotVersion(t))}function sl(e,t,n){let r=ny(),i=ny();return n.forEach(e=>r=r.add(e)),t.getEntries(e,r).next(e=>{let r=nc;return n.forEach((n,s)=>{let a=e.get(n);s.isFoundDocument()!==a.isFoundDocument()&&(i=i.add(n)),s.isNoDocument()&&s.version.isEqual(B.min())?(t.removeEntry(n,s.readTime),r=r.insert(n,s)):!a.isValidDocument()||s.version.compareTo(a.version)>0||0===s.version.compareTo(a.version)&&a.hasPendingWrites?(t.addEntry(s),r=r.insert(n,s)):I("LocalStore","Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",s.version)}),{Ps:r,Is:i}})}function su(e,t){return e.persistence.runTransaction("Allocate target","readwrite",n=>{let r;return e.Ur.getTargetData(n,t).next(i=>i?(r=i,ea.resolve(r)):e.Ur.allocateTargetId(n).next(i=>(r=new rM(t,i,"TargetPurposeListen",n.currentSequenceNumber),e.Ur.addTargetData(n,r).next(()=>r))))}).then(n=>{let r=e.os.get(n.targetId);return(null===r||n.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(e.os=e.os.insert(n.targetId,n),e._s.set(t,n.targetId)),n})}async function sc(e,t,n){let r=e.os.get(t);try{n||await e.persistence.runTransaction("Release target",n?"readwrite":"readwrite-primary",t=>e.persistence.referenceDelegate.removeTarget(t,r))}catch(e){if(!ed(e))throw e;I("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}e.os=e.os.remove(t),e._s.delete(r.target)}function sh(e,t,n){let r=B.min(),i=ny();return e.persistence.runTransaction("Execute query","readwrite",s=>(function(e,t,n){let r=e._s.get(n);return void 0!==r?ea.resolve(e.os.get(r)):e.Ur.getTargetData(t,n)})(e,s,t9(t)).next(t=>{if(t)return r=t.lastLimboFreeSnapshotVersion,e.Ur.getMatchingKeysForTargetId(s,t.targetId).next(e=>{i=e})}).next(()=>e.ss.getDocumentsMatchingQuery(s,t,n?r:B.min(),n?i:ny())).next(n=>(sm(e,no(t),n),{documents:n,Ts:i})))}function sd(e,t){let n=e.Ur,r=e.os.get(t);return r?Promise.resolve(r.target):e.persistence.runTransaction("Get target data","readonly",e=>n.ot(e,t).next(e=>e?e.target:null))}function sf(e,t){let n=e.us.get(t)||B.min();return e.persistence.runTransaction("Get new document changes","readonly",r=>e.cs.getAllFromCollectionGroup(r,t,Z(n,-1),Number.MAX_SAFE_INTEGER)).then(n=>(sm(e,t,n),n))}function sm(e,t,n){let r=e.us.get(t)||B.min();n.forEach((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)}),e.us.set(t,r)}async function sg(e,t,n,r){let i=ny(),s=nc;for(let e of n){let n=t.Es(e.metadata.name);e.document&&(i=i.add(n));let r=t.ds(e);r.setReadTime(t.As(e.metadata.readTime)),s=s.insert(n,r)}let a=e.cs.newChangeBuffer({trackRemovals:!0}),o=await su(e,t9(t4(G.fromString(`__bundle__/docs/${r}`))));return e.persistence.runTransaction("Apply bundle documents","readwrite",t=>sl(t,a,s).next(e=>(a.apply(t),e)).next(n=>e.Ur.removeMatchingKeysForTargetId(t,o.targetId).next(()=>e.Ur.addMatchingKeys(t,i,o.targetId)).next(()=>e.localDocuments.getLocalViewOfDocuments(t,n.Ps,n.Is)).next(()=>n.Ps)))}async function sp(e,t,n=ny()){let r=await su(e,t9(rG(t.bundledQuery)));return e.persistence.runTransaction("Save named query","readwrite",i=>{let s=rf(t.readTime);if(r.snapshotVersion.compareTo(s)>=0)return e.Gr.saveNamedQuery(i,t);let a=r.withResumeToken(e3.EMPTY_BYTE_STRING,s);return e.os=e.os.insert(a.targetId,a),e.Ur.updateTargetData(i,a).next(()=>e.Ur.removeMatchingKeysForTargetId(i,r.targetId)).next(()=>e.Ur.addMatchingKeys(i,n,r.targetId)).next(()=>e.Gr.saveNamedQuery(i,t))})}function sy(e,t){return`firestore_clients_${e}_${t}`}function sw(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function sv(e,t){return`firestore_targets_${e}_${t}`}class sI{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Rs(e,t,n){let r=JSON.parse(n),i,s="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return s&&r.error&&(s="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(i=new x(r.error.code,r.error.message)),s?new sI(e,t,r.state,i):(_("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}Vs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class s_{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Rs(e,t){let n=JSON.parse(t),r,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(r=new x(n.error.code,n.error.message)),i?new s_(e,n.state,r):(_("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Vs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class sb{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Rs(e,t){let n=JSON.parse(t),r="object"==typeof n&&n.activeTargetIds instanceof Array,i=nw;for(let e=0;r&&e<n.activeTargetIds.length;++e)r=eb(n.activeTargetIds[e]),i=i.add(n.activeTargetIds[e]);return r?new sb(e,i):(_("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class sT{constructor(e,t){this.clientId=e,this.onlineState=t}static Rs(e){let t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new sT(t.clientId,t.onlineState):(_("SharedClientState",`Failed to parse online state: ${e}`),null)}}class sE{constructor(){this.activeTargetIds=nw}fs(e){this.activeTargetIds=this.activeTargetIds.add(e)}gs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Vs(){return JSON.stringify({activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()})}}class sS{constructor(e,t,n,r,i){var s,a,o;this.window=e,this.ui=t,this.persistenceKey=n,this.ps=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ys=this.ws.bind(this),this.Ss=new eX(O),this.started=!1,this.bs=[];let l=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.Ds=sy(this.persistenceKey,this.ps),this.vs=(s=this.persistenceKey,`firestore_sequence_number_${s}`),this.Ss=this.Ss.insert(this.ps,new sE),this.Cs=RegExp(`^firestore_clients_${l}_([^_]*)$`),this.Fs=RegExp(`^firestore_mutations_${l}_(\\d+)(?:_(.*))?$`),this.Ms=RegExp(`^firestore_targets_${l}_(\\d+)$`),this.xs=(a=this.persistenceKey,`firestore_online_state_${a}`),this.Os=(o=this.persistenceKey,`firestore_bundle_loaded_v2_${o}`),this.window.addEventListener("storage",this.ys)}static D(e){return!(!e||!e.localStorage)}async start(){for(let e of(await this.syncEngine.Qi())){if(e===this.ps)continue;let t=this.getItem(sy(this.persistenceKey,e));if(t){let n=sb.Rs(e,t);n&&(this.Ss=this.Ss.insert(n.clientId,n))}}this.Ns();let e=this.storage.getItem(this.xs);if(e){let t=this.Ls(e);t&&this.Bs(t)}for(let e of this.bs)this.ws(e);this.bs=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.vs,JSON.stringify(e))}getAllActiveQueryTargets(){return this.ks(this.Ss)}isActiveQueryTarget(e){let t=!1;return this.Ss.forEach((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.qs(e,"pending")}updateMutationState(e,t,n){this.qs(e,t,n),this.Qs(e)}addLocalQueryTarget(e,t=!0){let n="not-current";if(this.isActiveQueryTarget(e)){let t=this.storage.getItem(sv(this.persistenceKey,e));if(t){let r=s_.Rs(e,t);r&&(n=r.state)}}return t&&this.Ks.fs(e),this.Ns(),n}removeLocalQueryTarget(e){this.Ks.gs(e),this.Ns()}isLocalQueryTarget(e){return this.Ks.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(sv(this.persistenceKey,e))}updateQueryState(e,t,n){this.$s(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.Qs(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Us(e)}notifyBundleLoaded(e){this.Ws(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ys),this.removeItem(this.Ds),this.started=!1)}getItem(e){let t=this.storage.getItem(e);return I("SharedClientState","READ",e,t),t}setItem(e,t){I("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){I("SharedClientState","REMOVE",e),this.storage.removeItem(e)}ws(e){if(e.storageArea===this.storage){if(I("SharedClientState","EVENT",e.key,e.newValue),e.key===this.Ds)return void _("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.ui.enqueueRetryable(async()=>{if(this.started){if(null!==e.key){if(this.Cs.test(e.key)){if(null==e.newValue){let t=this.Gs(e.key);return this.zs(t,null)}{let t=this.js(e.key,e.newValue);if(t)return this.zs(t.clientId,t)}}else if(this.Fs.test(e.key)){if(null!==e.newValue){let t=this.Hs(e.key,e.newValue);if(t)return this.Js(t)}}else if(this.Ms.test(e.key)){if(null!==e.newValue){let t=this.Ys(e.key,e.newValue);if(t)return this.Zs(t)}}else if(e.key===this.xs){if(null!==e.newValue){let t=this.Ls(e.newValue);if(t)return this.Bs(t)}}else if(e.key===this.vs){let t=function(e){let t=ev.oe;if(null!=e)try{let n=JSON.parse(e);"number"==typeof n||E(),t=n}catch(e){_("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(e.newValue);t!==ev.oe&&this.sequenceNumberHandler(t)}else if(e.key===this.Os){let t=this.Xs(e.newValue);await Promise.all(t.map(e=>this.syncEngine.eo(e)))}}}else this.bs.push(e)})}}get Ks(){return this.Ss.get(this.ps)}Ns(){this.setItem(this.Ds,this.Ks.Vs())}qs(e,t,n){let r=new sI(this.currentUser,e,t,n),i=sw(this.persistenceKey,this.currentUser,e);this.setItem(i,r.Vs())}Qs(e){let t=sw(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Us(e){let t={clientId:this.ps,onlineState:e};this.storage.setItem(this.xs,JSON.stringify(t))}$s(e,t,n){let r=sv(this.persistenceKey,e),i=new s_(e,t,n);this.setItem(r,i.Vs())}Ws(e){let t=JSON.stringify(Array.from(e));this.setItem(this.Os,t)}Gs(e){let t=this.Cs.exec(e);return t?t[1]:null}js(e,t){let n=this.Gs(e);return sb.Rs(n,t)}Hs(e,t){let n=this.Fs.exec(e),r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return sI.Rs(new p(i),r,t)}Ys(e,t){let n=Number(this.Ms.exec(e)[1]);return s_.Rs(n,t)}Ls(e){return sT.Rs(e)}Xs(e){return JSON.parse(e)}async Js(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.no(e.batchId,e.state,e.error);I("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}Zs(e){return this.syncEngine.ro(e.targetId,e.state,e.error)}zs(e,t){let n=t?this.Ss.insert(e,t):this.Ss.remove(e),r=this.ks(this.Ss),i=this.ks(n),s=[],a=[];return i.forEach(e=>{r.has(e)||s.push(e)}),r.forEach(e=>{i.has(e)||a.push(e)}),this.syncEngine.io(s,a).then(()=>{this.Ss=n})}Bs(e){this.Ss.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}ks(e){let t=nw;return e.forEach((e,n)=>{t=t.unionWith(n.activeTargetIds)}),t}}class sx{constructor(){this.so=new sE,this.oo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e,t=!0){return t&&this.so.fs(e),this.oo[e]||"not-current"}updateQueryState(e,t,n){this.oo[e]=t}removeLocalQueryTarget(e){this.so.gs(e)}isLocalQueryTarget(e){return this.so.activeTargetIds.has(e)}clearQueryState(e){delete this.oo[e]}getAllActiveQueryTargets(){return this.so.activeTargetIds}isActiveQueryTarget(e){return this.so.activeTargetIds.has(e)}start(){return this.so=new sE,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class sC{_o(e){}shutdown(){}}class sD{constructor(){this.ao=()=>this.uo(),this.co=()=>this.lo(),this.ho=[],this.Po()}_o(e){this.ho.push(e)}shutdown(){window.removeEventListener("online",this.ao),window.removeEventListener("offline",this.co)}Po(){window.addEventListener("online",this.ao),window.addEventListener("offline",this.co)}uo(){for(let e of(I("ConnectivityMonitor","Network connectivity changed: AVAILABLE"),this.ho))e(0)}lo(){for(let e of(I("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE"),this.ho))e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let sN=null;function sA(){return null===sN?sN=0x10000000+Math.round(0x80000000*Math.random()):sN++,"0x"+sN.toString(16)}let sk={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class sR{constructor(e){this.Io=e.Io,this.To=e.To}Eo(e){this.Ao=e}Ro(e){this.Vo=e}mo(e){this.fo=e}onMessage(e){this.po=e}close(){this.To()}send(e){this.Io(e)}yo(){this.Ao()}wo(){this.Vo()}So(e){this.fo(e)}bo(e){this.po(e)}}let sF="WebChannelConnection";class sM extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;let t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.Do=t+"://"+e.host,this.vo=`projects/${n}/databases/${r}`,this.Co="(default)"===this.databaseId.database?`project_id=${n}`:`project_id=${n}&database_id=${r}`}get Fo(){return!1}Mo(e,t,n,r,i){let s=sA(),a=this.xo(e,t.toUriEncodedString());I("RestConnection",`Sending RPC '${e}' ${s}:`,a,n);let o={"google-cloud-resource-prefix":this.vo,"x-goog-request-params":this.Co};return this.Oo(o,r,i),this.No(e,a,o,n).then(t=>(I("RestConnection",`Received RPC '${e}' ${s}: `,t),t),t=>{throw b("RestConnection",`RPC '${e}' ${s} failed with error: `,t,"url: ",a,"request:",n),t})}Lo(e,t,n,r,i,s){return this.Mo(e,t,n,r,i)}Oo(e,t,n){e["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+y}(),e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((t,n)=>e[n]=t),n&&n.headers.forEach((t,n)=>e[n]=t)}xo(e,t){let n=sk[e];return`${this.Do}/v1/${t}:${n}`}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}No(e,t,n,r){let i=sA();return new Promise((s,a)=>{let o=new m.XhrIo;o.setWithCredentials(!0),o.listenOnce(m.EventType.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case m.ErrorCode.NO_ERROR:let t=o.getResponseJson();I(sF,`XHR for RPC '${e}' ${i} received:`,JSON.stringify(t)),s(t);break;case m.ErrorCode.TIMEOUT:I(sF,`RPC '${e}' ${i} timed out`),a(new x(S.DEADLINE_EXCEEDED,"Request time out"));break;case m.ErrorCode.HTTP_ERROR:let n=o.getStatus();if(I(sF,`RPC '${e}' ${i} failed with status:`,n,"response text:",o.getResponseText()),n>0){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);let t=null==e?void 0:e.error;if(t&&t.status&&t.message){let e=function(e){let t=e.toLowerCase().replace(/_/g,"-");return Object.values(S).indexOf(t)>=0?t:S.UNKNOWN}(t.status);a(new x(e,t.message))}else a(new x(S.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(new x(S.UNAVAILABLE,"Connection failed."));break;default:E()}}finally{I(sF,`RPC '${e}' ${i} completed.`)}});let l=JSON.stringify(r);I(sF,`RPC '${e}' ${i} sending request:`,r),o.send(t,"POST",l,n,15)})}Bo(e,t,n){let i=sA(),s=[this.Do,"/","google.firestore.v1.Firestore","/",e,"/channel"],a=m.createWebChannelTransport(),o=m.getStatEventTarget(),l={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(l.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(l.useFetchStreams=!0),this.Oo(l.initMessageHeaders,t,n),l.encodeInitMessageHeaders=!0;let c=s.join("");I(sF,`Creating RPC '${e}' stream ${i}: ${c}`,l);let h=a.createWebChannel(c,l),d=!1,f=!1,g=new sR({Io:t=>{f?I(sF,`Not sending because RPC '${e}' stream ${i} is closed:`,t):(d||(I(sF,`Opening RPC '${e}' stream ${i} transport.`),h.open(),d=!0),I(sF,`RPC '${e}' stream ${i} sending:`,t),h.send(t))},To:()=>h.close()}),p=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return p(h,m.WebChannel.EventType.OPEN,()=>{f||(I(sF,`RPC '${e}' stream ${i} transport opened.`),g.yo())}),p(h,m.WebChannel.EventType.CLOSE,()=>{f||(f=!0,I(sF,`RPC '${e}' stream ${i} transport closed`),g.So())}),p(h,m.WebChannel.EventType.ERROR,t=>{f||(f=!0,b(sF,`RPC '${e}' stream ${i} transport errored:`,t),g.So(new x(S.UNAVAILABLE,"The operation could not be completed")))}),p(h,m.WebChannel.EventType.MESSAGE,t=>{var n;if(!f){let s=t.data[0];s||E();let a=s.error||(null==(n=s[0])?void 0:n.error);if(a){I(sF,`RPC '${e}' stream ${i} received error:`,a);let t=a.status,n=function(e){let t=r[e];if(void 0!==t)return nZ(t)}(t),s=a.message;void 0===n&&(n=S.INTERNAL,s="Unknown error status: "+t+" with message "+a.message),f=!0,g.So(new x(n,s)),h.close()}else I(sF,`RPC '${e}' stream ${i} received:`,s),g.bo(s)}}),p(o,m.Event.STAT_EVENT,t=>{t.stat===m.Stat.PROXY?I(sF,`RPC '${e}' stream ${i} detected buffering proxy`):t.stat===m.Stat.NOPROXY&&I(sF,`RPC '${e}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{g.wo()},0),g}}function sL(){return"undefined"!=typeof window?window:null}function sV(){return"undefined"!=typeof document?document:null}function sP(e){return new ru(e,!0)}class sO{constructor(e,t,n=1e3,r=1.5,i=6e4){this.ui=e,this.timerId=t,this.ko=n,this.qo=r,this.Qo=i,this.Ko=0,this.$o=null,this.Uo=Date.now(),this.reset()}reset(){this.Ko=0}Wo(){this.Ko=this.Qo}Go(e){this.cancel();let t=Math.floor(this.Ko+this.zo()),n=Math.max(0,Date.now()-this.Uo),r=Math.max(0,t-n);r>0&&I("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Ko} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.$o=this.ui.enqueueAfterDelay(this.timerId,r,()=>(this.Uo=Date.now(),e())),this.Ko*=this.qo,this.Ko<this.ko&&(this.Ko=this.ko),this.Ko>this.Qo&&(this.Ko=this.Qo)}jo(){null!==this.$o&&(this.$o.skipDelay(),this.$o=null)}cancel(){null!==this.$o&&(this.$o.cancel(),this.$o=null)}zo(){return(Math.random()-.5)*this.Ko}}class sq{constructor(e,t,n,r,i,s,a,o){this.ui=e,this.Ho=n,this.Jo=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.Yo=0,this.Zo=null,this.Xo=null,this.stream=null,this.e_=0,this.t_=new sO(e,t)}n_(){return 1===this.state||5===this.state||this.r_()}r_(){return 2===this.state||3===this.state}start(){this.e_=0,4!==this.state?this.auth():this.i_()}async stop(){this.n_()&&await this.close(0)}s_(){this.state=0,this.t_.reset()}o_(){this.r_()&&null===this.Zo&&(this.Zo=this.ui.enqueueAfterDelay(this.Ho,6e4,()=>this.__()))}a_(e){this.u_(),this.stream.send(e)}async __(){if(this.r_())return this.close(0)}u_(){this.Zo&&(this.Zo.cancel(),this.Zo=null)}c_(){this.Xo&&(this.Xo.cancel(),this.Xo=null)}async close(e,t){this.u_(),this.c_(),this.t_.cancel(),this.Yo++,4!==e?this.t_.reset():t&&t.code===S.RESOURCE_EXHAUSTED?(_(t.toString()),_("Using maximum backoff delay to prevent overloading the backend."),this.t_.Wo()):t&&t.code===S.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.l_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.mo(t)}l_(){}auth(){this.state=1;let e=this.h_(this.Yo),t=this.Yo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,n])=>{this.Yo===t&&this.P_(e,n)},t=>{e(()=>{let e=new x(S.UNKNOWN,"Fetching auth token failed: "+t.message);return this.I_(e)})})}P_(e,t){let n=this.h_(this.Yo);this.stream=this.T_(e,t),this.stream.Eo(()=>{n(()=>this.listener.Eo())}),this.stream.Ro(()=>{n(()=>(this.state=2,this.Xo=this.ui.enqueueAfterDelay(this.Jo,1e4,()=>(this.r_()&&(this.state=3),Promise.resolve())),this.listener.Ro()))}),this.stream.mo(e=>{n(()=>this.I_(e))}),this.stream.onMessage(e=>{n(()=>1==++this.e_?this.E_(e):this.onNext(e))})}i_(){this.state=5,this.t_.Go(async()=>{this.state=0,this.start()})}I_(e){return I("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}h_(e){return t=>{this.ui.enqueueAndForget(()=>this.Yo===e?t():(I("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class sU extends sq{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}T_(e,t){return this.connection.Bo("Listen",e,t)}E_(e){return this.onNext(e)}onNext(e){this.t_.reset();let t=function(e,t){let n;if("targetChange"in t){var r,i;t.targetChange;let s="NO_CHANGE"===(r=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===r?1:"REMOVE"===r?2:"CURRENT"===r?3:"RESET"===r?4:E(),a=t.targetChange.targetIds||[],o=(i=t.targetChange.resumeToken,e.useProto3Json?(void 0===i||"string"==typeof i||E(),e3.fromBase64String(i||"")):(void 0===i||i instanceof l||i instanceof Uint8Array||E(),e3.fromUint8Array(i||new Uint8Array))),u=t.targetChange.cause;n=new rt(s,a,o,u&&new x(void 0===u.code?S.UNKNOWN:nZ(u.code),u.message||"")||null)}else if("documentChange"in t){t.documentChange;let r=t.documentChange;r.document,r.document.name,r.document.updateTime;let i=rw(e,r.document.name),s=rf(r.document.updateTime),a=r.document.createTime?rf(r.document.createTime):B.min(),o=new tC({mapValue:{fields:r.document.fields}}),l=tD.newFoundDocument(i,s,a,o);n=new n7(r.targetIds||[],r.removedTargetIds||[],l.key,l)}else if("documentDelete"in t){t.documentDelete;let r=t.documentDelete;r.document;let i=rw(e,r.document),s=r.readTime?rf(r.readTime):B.min(),a=tD.newNoDocument(i,s);n=new n7([],r.removedTargetIds||[],a.key,a)}else if("documentRemove"in t){t.documentRemove;let r=t.documentRemove;r.document;let i=rw(e,r.document);n=new n7([],r.removedTargetIds||[],i,null)}else{if(!("filter"in t))return E();{t.filter;let e=t.filter;e.targetId;let{count:r=0,unchangedNames:i}=e,s=new nY(r,i);n=new re(e.targetId,s)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return B.min();let t=e.targetChange;return t.targetIds&&t.targetIds.length?B.min():t.readTime?rf(t.readTime):B.min()}(e);return this.listener.d_(t,n)}A_(e){let t={};t.database=r_(this.serializer),t.addTarget=function(e,t){let n,r=t.target;if((n=tZ(r)?{documents:rC(e,r)}:{query:rD(e,r)._t}).targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=rd(e,t.resumeToken);let r=rc(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo(B.min())>0){n.readTime=rh(e,t.snapshotVersion.toTimestamp());let r=rc(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);let n=function(e,t){let n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return E()}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.a_(t)}R_(e){let t={};t.database=r_(this.serializer),t.removeTarget=e,this.a_(t)}}class sB extends sq{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}get V_(){return this.e_>0}start(){this.lastStreamToken=void 0,super.start()}l_(){this.V_&&this.m_([])}T_(e,t){return this.connection.Bo("Write",e,t)}E_(e){return e.streamToken||E(),this.lastStreamToken=e.streamToken,e.writeResults&&0!==e.writeResults.length&&E(),this.listener.f_()}onNext(e){var t,n;e.streamToken||E(),this.lastStreamToken=e.streamToken,this.t_.reset();let r=(t=e.writeResults,n=e.commitTime,t&&t.length>0?(void 0!==n||E(),t.map(e=>{let t;return(t=e.updateTime?rf(e.updateTime):rf(n)).isEqual(B.min())&&(t=rf(n)),new nF(t,e.transformResults||[])})):[]),i=rf(e.commitTime);return this.listener.g_(i,r)}p_(){let e={};e.database=r_(this.serializer),this.a_(e)}m_(e){let t={streamToken:this.lastStreamToken,writes:e.map(e=>rS(this.serializer,e))};this.a_(t)}}class sz extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.y_=!1}w_(){if(this.y_)throw new x(S.FAILED_PRECONDITION,"The client has already been terminated.")}Mo(e,t,n,r){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([i,s])=>this.connection.Mo(e,rg(t,n),r,i,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===S.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new x(S.UNKNOWN,e.toString())})}Lo(e,t,n,r,i){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,a])=>this.connection.Lo(e,rg(t,n),r,s,a,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===S.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new x(S.UNKNOWN,e.toString())})}terminate(){this.y_=!0,this.connection.terminate()}}class sG{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.S_=0,this.b_=null,this.D_=!0}v_(){0===this.S_&&(this.C_("Unknown"),this.b_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.b_=null,this.F_("Backend didn't respond within 10 seconds."),this.C_("Offline"),Promise.resolve())))}M_(e){"Online"===this.state?this.C_("Unknown"):(this.S_++,this.S_>=1&&(this.x_(),this.F_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.C_("Offline")))}set(e){this.x_(),this.S_=0,"Online"===e&&(this.D_=!1),this.C_(e)}C_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}F_(e){let t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.D_?(_(t),this.D_=!1):I("OnlineStateTracker",t)}x_(){null!==this.b_&&(this.b_.cancel(),this.b_=null)}}class sK{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.O_=[],this.N_=new Map,this.L_=new Set,this.B_=[],this.k_=i,this.k_._o(e=>{n.enqueueAndForget(async()=>{sZ(this)&&(I("RemoteStore","Restarting streams for network reachability change."),await async function(e){e.L_.add(4),await sQ(e),e.q_.set("Unknown"),e.L_.delete(4),await s$(e)}(this))})}),this.q_=new sG(n,r)}}async function s$(e){if(sZ(e))for(let t of e.B_)await t(!0)}async function sQ(e){for(let t of e.B_)await t(!1)}function sj(e,t){e.N_.has(t.targetId)||(e.N_.set(t.targetId,t),sX(e)?sY(e):as(e).r_()&&sJ(e,t))}function sW(e,t){let n=as(e);e.N_.delete(t),n.r_()&&sH(e,t),0===e.N_.size&&(n.r_()?n.o_():sZ(e)&&e.q_.set("Unknown"))}function sJ(e,t){if(e.Q_.xe(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(B.min())>0){let n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}as(e).A_(t)}function sH(e,t){e.Q_.xe(t),as(e).R_(t)}function sY(e){e.Q_=new rr({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),ot:t=>e.N_.get(t)||null,tt:()=>e.datastore.serializer.databaseId}),as(e).start(),e.q_.v_()}function sX(e){return sZ(e)&&!as(e).n_()&&e.N_.size>0}function sZ(e){return 0===e.L_.size}async function s0(e){e.q_.set("Online")}async function s1(e){e.N_.forEach((t,n)=>{sJ(e,t)})}async function s2(e,t){e.Q_=void 0,sX(e)?(e.q_.M_(t),sY(e)):e.q_.set("Unknown")}async function s5(e,t,n){if(e.q_.set("Online"),t instanceof rt&&2===t.state&&t.cause)try{await async function(e,t){let n=t.cause;for(let r of t.targetIds)e.N_.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.N_.delete(r),e.Q_.removeTarget(r))}(e,t)}catch(n){I("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await s4(e,n)}else if(t instanceof n7?e.Q_.Ke(t):t instanceof re?e.Q_.He(t):e.Q_.We(t),!n.isEqual(B.min()))try{let t=await so(e.localStore);n.compareTo(t)>=0&&await function(e,t){let n=e.Q_.rt(t);return n.targetChanges.forEach((n,r)=>{if(n.resumeToken.approximateByteSize()>0){let i=e.N_.get(r);i&&e.N_.set(r,i.withResumeToken(n.resumeToken,t))}}),n.targetMismatches.forEach((t,n)=>{let r=e.N_.get(t);if(!r)return;e.N_.set(t,r.withResumeToken(e3.EMPTY_BYTE_STRING,r.snapshotVersion)),sH(e,t);let i=new rM(r.target,t,n,r.sequenceNumber);sJ(e,i)}),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){I("RemoteStore","Failed to raise snapshot:",t),await s4(e,t)}}async function s4(e,t,n){if(!ed(t))throw t;e.L_.add(1),await sQ(e),e.q_.set("Offline"),n||(n=()=>so(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{I("RemoteStore","Retrying IndexedDB access"),await n(),e.L_.delete(1),await s$(e)})}function s8(e,t){return t().catch(n=>s4(e,n,t))}async function s3(e){var t;let n=aa(e),r=e.O_.length>0?e.O_[e.O_.length-1].batchId:-1;for(;sZ(t=e)&&t.O_.length<10;)try{let t=await function(e,t){return e.persistence.runTransaction("Get next mutation batch","readonly",n=>(void 0===t&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(n,t)))}(e.localStore,r);if(null===t){0===e.O_.length&&n.o_();break}r=t.batchId,function(e,t){e.O_.push(t);let n=aa(e);n.r_()&&n.V_&&n.m_(t.mutations)}(e,t)}catch(t){await s4(e,t)}s6(e)&&s9(e)}function s6(e){return sZ(e)&&!aa(e).n_()&&e.O_.length>0}function s9(e){aa(e).start()}async function s7(e){aa(e).p_()}async function ae(e){let t=aa(e);for(let n of e.O_)t.m_(n.mutations)}async function at(e,t,n){let r=e.O_.shift(),i=nW.from(r,t,n);await s8(e,()=>e.remoteSyncer.applySuccessfulWrite(i)),await s3(e)}async function an(e,t){t&&aa(e).V_&&await async function(e,t){var n;if(nX(n=t.code)&&n!==S.ABORTED){let n=e.O_.shift();aa(e).s_(),await s8(e,()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t)),await s3(e)}}(e,t),s6(e)&&s9(e)}async function ar(e,t){e.asyncQueue.verifyOperationInProgress(),I("RemoteStore","RemoteStore received new credentials");let n=sZ(e);e.L_.add(3),await sQ(e),n&&e.q_.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.L_.delete(3),await s$(e)}async function ai(e,t){t?(e.L_.delete(2),await s$(e)):t||(e.L_.add(2),await sQ(e),e.q_.set("Unknown"))}function as(e){var t,n,r;return e.K_||(t=e.datastore,n=e.asyncQueue,r={Eo:s0.bind(null,e),Ro:s1.bind(null,e),mo:s2.bind(null,e),d_:s5.bind(null,e)},t.w_(),e.K_=new sU(n,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,r),e.B_.push(async t=>{t?(e.K_.s_(),sX(e)?sY(e):e.q_.set("Unknown")):(await e.K_.stop(),e.Q_=void 0)})),e.K_}function aa(e){var t,n,r;return e.U_||(t=e.datastore,n=e.asyncQueue,r={Eo:()=>Promise.resolve(),Ro:s7.bind(null,e),mo:an.bind(null,e),f_:ae.bind(null,e),g_:at.bind(null,e)},t.w_(),e.U_=new sB(n,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,r),e.B_.push(async t=>{t?(e.U_.s_(),await s3(e)):(await e.U_.stop(),e.O_.length>0&&(I("RemoteStore",`Stopping write stream with ${e.O_.length} pending writes`),e.O_=[]))})),e.U_}class ao{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new C,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,i){let s=new ao(e,t,Date.now()+n,r,i);return s.start(n),s}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new x(S.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function al(e,t){if(_("AsyncQueue",`${t}: ${e}`),ed(e))return new x(S.UNAVAILABLE,`${t}: ${e}`);throw e}class au{constructor(e){this.comparator=e?(t,n)=>e(t,n)||Q.comparator(t.key,n.key):(e,t)=>Q.comparator(e.key,t.key),this.keyedMap=nd(),this.sortedSet=new eX(this.comparator)}static emptySet(e){return new au(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){let t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,n)=>(e(t),!1))}add(e){let t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){let t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof au)||this.size!==e.size)return!1;let t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){let e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){let e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){let n=new au;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class ac{constructor(){this.W_=new eX(Q.comparator)}track(e){let t=e.doc.key,n=this.W_.get(t);n?0!==e.type&&3===n.type?this.W_=this.W_.insert(t,e):3===e.type&&1!==n.type?this.W_=this.W_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.W_=this.W_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.W_=this.W_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.W_=this.W_.remove(t):1===e.type&&2===n.type?this.W_=this.W_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.W_=this.W_.insert(t,{type:2,doc:e.doc}):E():this.W_=this.W_.insert(t,e)}G_(){let e=[];return this.W_.inorderTraversal((t,n)=>{e.push(n)}),e}}class ah{constructor(e,t,n,r,i,s,a,o,l){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=l}static fromInitialDocuments(e,t,n,r,i){let s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new ah(e,t,au.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&nr(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;let t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class ad{constructor(){this.z_=void 0,this.j_=[]}H_(){return this.j_.some(e=>e.J_())}}class af{constructor(){this.queries=am(),this.onlineState="Unknown",this.Y_=new Set}terminate(){!function(e,t){let n=e.queries;e.queries=am(),n.forEach((e,n)=>{for(let e of n.j_)e.onError(t)})}(this,new x(S.ABORTED,"Firestore shutting down"))}}function am(){return new nu(e=>ni(e),nr)}async function ag(e,t){let n=3,r=t.query,i=e.queries.get(r);i?!i.H_()&&t.J_()&&(n=2):(i=new ad,n=+!t.J_());try{switch(n){case 0:i.z_=await e.onListen(r,!0);break;case 1:i.z_=await e.onListen(r,!1);break;case 2:await e.onFirstRemoteStoreListen(r)}}catch(n){let e=al(n,`Initialization of query '${ns(t.query)}' failed`);return void t.onError(e)}e.queries.set(r,i),i.j_.push(t),t.Z_(e.onlineState),i.z_&&t.X_(i.z_)&&av(e)}async function ap(e,t){let n=t.query,r=3,i=e.queries.get(n);if(i){let e=i.j_.indexOf(t);e>=0&&(i.j_.splice(e,1),0===i.j_.length?r=+!t.J_():!i.H_()&&t.J_()&&(r=2))}switch(r){case 0:return e.queries.delete(n),e.onUnlisten(n,!0);case 1:return e.queries.delete(n),e.onUnlisten(n,!1);case 2:return e.onLastRemoteStoreUnlisten(n);default:return}}function ay(e,t){let n=!1;for(let r of t){let t=r.query,i=e.queries.get(t);if(i){for(let e of i.j_)e.X_(r)&&(n=!0);i.z_=r}}n&&av(e)}function aw(e,t,n){let r=e.queries.get(t);if(r)for(let e of r.j_)e.onError(n);e.queries.delete(t)}function av(e){e.Y_.forEach(e=>{e.next()})}(a=s||(s={})).ea="default",a.Cache="cache";class aI{constructor(e,t,n){this.query=e,this.ta=t,this.na=!1,this.ra=null,this.onlineState="Unknown",this.options=n||{}}X_(e){if(!this.options.includeMetadataChanges){let t=[];for(let n of e.docChanges)3!==n.type&&t.push(n);e=new ah(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.na?this.ia(e)&&(this.ta.next(e),t=!0):this.sa(e,this.onlineState)&&(this.oa(e),t=!0),this.ra=e,t}onError(e){this.ta.error(e)}Z_(e){this.onlineState=e;let t=!1;return this.ra&&!this.na&&this.sa(this.ra,e)&&(this.oa(this.ra),t=!0),t}sa(e,t){return!(e.fromCache&&this.J_())||(!this.options._a||"Offline"===t)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}ia(e){if(e.docChanges.length>0)return!0;let t=this.ra&&this.ra.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}oa(e){e=ah.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.na=!0,this.ta.next(e)}J_(){return this.options.source!==s.Cache}}class a_{constructor(e,t){this.aa=e,this.byteLength=t}ua(){return"metadata"in this.aa}}class ab{constructor(e){this.serializer=e}Es(e){return rw(this.serializer,e)}ds(e){return e.metadata.exists?rE(this.serializer,e.document,!1):tD.newNoDocument(this.Es(e.metadata.name),this.As(e.metadata.readTime))}As(e){return rf(e)}}class aT{constructor(e,t,n){this.ca=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=aE(e)}la(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.aa.namedQuery)this.queries.push(e.aa.namedQuery);else if(e.aa.documentMetadata){this.documents.push({metadata:e.aa.documentMetadata}),e.aa.documentMetadata.exists||++t;let n=G.fromString(e.aa.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.aa.document&&(this.documents[this.documents.length-1].document=e.aa.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}ha(e){let t=new Map,n=new ab(this.serializer);for(let r of e)if(r.metadata.queries){let e=n.Es(r.metadata.name);for(let n of r.metadata.queries){let r=(t.get(n)||ny()).add(e);t.set(n,r)}}return t}async complete(){let e=await sg(this.localStore,new ab(this.serializer),this.documents,this.ca.id),t=this.ha(this.documents);for(let e of this.queries)await sp(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,Pa:this.collectionGroups,Ia:e}}}function aE(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class aS{constructor(e){this.key=e}}class ax{constructor(e){this.key=e}}class aC{constructor(e,t){this.query=e,this.Ta=t,this.Ea=null,this.hasCachedResults=!1,this.current=!1,this.da=ny(),this.mutatedKeys=ny(),this.Aa=nl(e),this.Ra=new au(this.Aa)}get Va(){return this.Ta}ma(e,t){let n=t?t.fa:new ac,r=t?t.Ra:this.Ra,i=t?t.mutatedKeys:this.mutatedKeys,s=r,a=!1,o="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,l="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal((e,t)=>{let u=r.get(e),c=na(this.query,t)?t:null,h=!!u&&this.mutatedKeys.has(u.key),d=!!c&&(c.hasLocalMutations||this.mutatedKeys.has(c.key)&&c.hasCommittedMutations),f=!1;u&&c?u.data.isEqual(c.data)?h!==d&&(n.track({type:3,doc:c}),f=!0):this.ga(u,c)||(n.track({type:2,doc:c}),f=!0,(o&&this.Aa(c,o)>0||l&&0>this.Aa(c,l))&&(a=!0)):!u&&c?(n.track({type:0,doc:c}),f=!0):u&&!c&&(n.track({type:1,doc:u}),f=!0,(o||l)&&(a=!0)),f&&(c?(s=s.add(c),i=d?i.add(e):i.delete(e)):(s=s.delete(e),i=i.delete(e)))}),null!==this.query.limit)for(;s.size>this.query.limit;){let e="F"===this.query.limitType?s.last():s.first();s=s.delete(e.key),i=i.delete(e.key),n.track({type:1,doc:e})}return{Ra:s,fa:n,ns:a,mutatedKeys:i}}ga(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){let i=this.Ra;this.Ra=e.Ra,this.mutatedKeys=e.mutatedKeys;let s=e.fa.G_();s.sort((e,t)=>(function(e,t){let n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return E()}};return n(e)-n(t)})(e.type,t.type)||this.Aa(e.doc,t.doc)),this.pa(n),r=null!=r&&r;let a=t&&!r?this.ya():[],o=0===this.da.size&&this.current&&!r?1:0,l=o!==this.Ea;return(this.Ea=o,0!==s.length||l)?{snapshot:new ah(this.query,e.Ra,i,s,e.mutatedKeys,0===o,l,!1,!!n&&n.resumeToken.approximateByteSize()>0),wa:a}:{wa:a}}Z_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Ra:this.Ra,fa:new ac,mutatedKeys:this.mutatedKeys,ns:!1},!1)):{wa:[]}}Sa(e){return!this.Ta.has(e)&&!!this.Ra.has(e)&&!this.Ra.get(e).hasLocalMutations}pa(e){e&&(e.addedDocuments.forEach(e=>this.Ta=this.Ta.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.Ta=this.Ta.delete(e)),this.current=e.current)}ya(){if(!this.current)return[];let e=this.da;this.da=ny(),this.Ra.forEach(e=>{this.Sa(e.key)&&(this.da=this.da.add(e.key))});let t=[];return e.forEach(e=>{this.da.has(e)||t.push(new ax(e))}),this.da.forEach(n=>{e.has(n)||t.push(new aS(n))}),t}ba(e){this.Ta=e.Ts,this.da=ny();let t=this.ma(e.documents);return this.applyChanges(t,!0)}Da(){return ah.fromInitialDocuments(this.query,this.Ra,this.mutatedKeys,0===this.Ea,this.hasCachedResults)}}class aD{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class aN{constructor(e){this.key=e,this.va=!1}}class aA{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.Ca={},this.Fa=new nu(e=>ni(e),nr),this.Ma=new Map,this.xa=new Set,this.Oa=new eX(Q.comparator),this.Na=new Map,this.La=new iJ,this.Ba={},this.ka=new Map,this.qa=iS.kn(),this.onlineState="Unknown",this.Qa=void 0}get isPrimaryClient(){return!0===this.Qa}}async function ak(e,t,n=!0){let r,i=a9(e),s=i.Fa.get(t);return s?(i.sharedClientState.addLocalQueryTarget(s.targetId),r=s.view.Da()):r=await aF(i,t,n,!0),r}async function aR(e,t){let n=a9(e);await aF(n,t,!0,!1)}async function aF(e,t,n,r){let i,s=await su(e.localStore,t9(t)),a=s.targetId,o=e.sharedClientState.addLocalQueryTarget(a,n);return r&&(i=await aM(e,t,a,"current"===o,s.resumeToken)),e.isPrimaryClient&&n&&sj(e.remoteStore,s),i}async function aM(e,t,n,r,i){e.Ka=(t,n,r)=>(async function(e,t,n,r){let i=t.view.ma(n);i.ns&&(i=await sh(e.localStore,t.query,!1).then(({documents:e})=>t.view.ma(e,i)));let s=r&&r.targetChanges.get(t.targetId),a=r&&null!=r.targetMismatches.get(t.targetId),o=t.view.applyChanges(i,e.isPrimaryClient,s,a);return aW(e,t.targetId,o.wa),o.snapshot})(e,t,n,r);let s=await sh(e.localStore,t,!0),a=new aC(t,s.Ts),o=a.ma(s.documents),l=n9.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,i),u=a.applyChanges(o,e.isPrimaryClient,l);aW(e,n,u.wa);let c=new aD(t,n,a);return e.Fa.set(t,c),e.Ma.has(n)?e.Ma.get(n).push(t):e.Ma.set(n,[t]),u.snapshot}async function aL(e,t,n){let r=e.Fa.get(t),i=e.Ma.get(r.targetId);if(i.length>1)return e.Ma.set(r.targetId,i.filter(e=>!nr(e,t))),void e.Fa.delete(t);e.isPrimaryClient?(e.sharedClientState.removeLocalQueryTarget(r.targetId),e.sharedClientState.isActiveQueryTarget(r.targetId)||await sc(e.localStore,r.targetId,!1).then(()=>{e.sharedClientState.clearQueryState(r.targetId),n&&sW(e.remoteStore,r.targetId),aQ(e,r.targetId)}).catch(es)):(aQ(e,r.targetId),await sc(e.localStore,r.targetId,!0))}async function aV(e,t){let n=e.Fa.get(t),r=e.Ma.get(n.targetId);e.isPrimaryClient&&1===r.length&&(e.sharedClientState.removeLocalQueryTarget(n.targetId),sW(e.remoteStore,n.targetId))}async function aP(e,t,n){let r=a7(e);try{var i;let e,s=await function(e,t){let n,r,i=U.now(),s=t.reduce((e,t)=>e.add(t.key),ny());return e.persistence.runTransaction("Locally write mutations","readwrite",a=>{let o=nc,l=ny();return e.cs.getEntries(a,s).next(e=>{(o=e).forEach((e,t)=>{t.isValidDocument()||(l=l.add(e))})}).next(()=>e.localDocuments.getOverlayedDocuments(a,o)).next(r=>{n=r;let s=[];for(let e of t){let t=function(e,t){let n=null;for(let r of e.fieldTransforms){let e=t.data.field(r.field),i=nT(r.transform,e||null);null!=i&&(null===n&&(n=tC.empty()),n.set(r.field,i))}return n||null}(e,n.get(e.key).overlayedDocument);null!=t&&s.push(new nB(e.key,t,function e(t){let n=[];return eJ(t.fields,(t,r)=>{let i=new $([t]);if(tI(r)){let t=e(r.mapValue).fields;if(0===t.length)n.push(i);else for(let e of t)n.push(i.child(e))}else n.push(i)}),new e4(n)}(t.value.mapValue),nM.exists(!0)))}return e.mutationQueue.addMutationBatch(a,i,s,t)}).next(t=>{r=t;let i=t.applyToLocalDocumentSet(n,l);return e.documentOverlayCache.saveOverlays(a,t.batchId,i)})}).then(()=>({batchId:r.batchId,changes:nf(n)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(s.batchId),i=s.batchId,(e=r.Ba[r.currentUser.toKey()])||(e=new eX(O)),e=e.insert(i,n),r.Ba[r.currentUser.toKey()]=e,await aH(r,s.changes),await s3(r.remoteStore)}catch(t){let e=al(t,"Failed to persist write");n.reject(e)}}async function aO(e,t){try{let n=await function(e,t){let n=t.snapshotVersion,r=e.os;return e.persistence.runTransaction("Apply remote event","readwrite-primary",i=>{let s=e.cs.newChangeBuffer({trackRemovals:!0});r=e.os;let a=[];t.targetChanges.forEach((s,o)=>{var l;let u=r.get(o);if(!u)return;a.push(e.Ur.removeMatchingKeys(i,s.removedDocuments,o).next(()=>e.Ur.addMatchingKeys(i,s.addedDocuments,o)));let c=u.withSequenceNumber(i.currentSequenceNumber);null!==t.targetMismatches.get(o)?c=c.withResumeToken(e3.EMPTY_BYTE_STRING,B.min()).withLastLimboFreeSnapshotVersion(B.min()):s.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(s.resumeToken,n)),r=r.insert(o,c),l=c,(0===u.resumeToken.approximateByteSize()||l.snapshotVersion.toMicroseconds()-u.snapshotVersion.toMicroseconds()>=3e8||s.addedDocuments.size+s.modifiedDocuments.size+s.removedDocuments.size>0)&&a.push(e.Ur.updateTargetData(i,c))});let o=nc,l=ny();if(t.documentUpdates.forEach(n=>{t.resolvedLimboDocuments.has(n)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(i,n))}),a.push(sl(i,s,t.documentUpdates).next(e=>{o=e.Ps,l=e.Is})),!n.isEqual(B.min())){let t=e.Ur.getLastRemoteSnapshotVersion(i).next(t=>e.Ur.setTargetsMetadata(i,i.currentSequenceNumber,n));a.push(t)}return ea.waitFor(a).next(()=>s.apply(i)).next(()=>e.localDocuments.getLocalViewOfDocuments(i,o,l)).next(()=>o)}).then(t=>(e.os=r,t))}(e.localStore,t);t.targetChanges.forEach((t,n)=>{let r=e.Na.get(n);r&&(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1||E(),t.addedDocuments.size>0?r.va=!0:t.modifiedDocuments.size>0?r.va||E():t.removedDocuments.size>0&&(r.va||E(),r.va=!1))}),await aH(e,n,t)}catch(e){await es(e)}}function aq(e,t,n){var r;if(e.isPrimaryClient&&0===n||!e.isPrimaryClient&&1===n){let n,i=[];e.Fa.forEach((e,n)=>{let r=n.view.Z_(t);r.snapshot&&i.push(r.snapshot)}),(r=e.eventManager).onlineState=t,n=!1,r.queries.forEach((e,r)=>{for(let e of r.j_)e.Z_(t)&&(n=!0)}),n&&av(r),i.length&&e.Ca.d_(i),e.onlineState=t,e.isPrimaryClient&&e.sharedClientState.setOnlineState(t)}}async function aU(e,t,n){e.sharedClientState.updateQueryState(t,"rejected",n);let r=e.Na.get(t),i=r&&r.key;if(i){let n=new eX(Q.comparator);n=n.insert(i,tD.newNoDocument(i,B.min()));let r=ny().add(i),s=new n6(B.min(),new Map,new eX(O),n,r);await aO(e,s),e.Oa=e.Oa.remove(i),e.Na.delete(t),aJ(e)}else await sc(e.localStore,t,!1).then(()=>aQ(e,t,n)).catch(es)}async function aB(e,t){var n;let r=t.batch.batchId;try{let i=await (n=e.localStore,n.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{let r=t.batch.keys(),i=n.cs.newChangeBuffer({trackRemovals:!0});return(function(e,t,n,r){let i=n.batch,s=i.keys(),a=ea.resolve();return s.forEach(e=>{a=a.next(()=>r.getEntry(t,e)).next(t=>{let s=n.docVersions.get(e);null!==s||E(),0>t.version.compareTo(s)&&(i.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,i))})(n,e,t,i).next(()=>i.apply(e)).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=ny();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t))).next(()=>n.localDocuments.getDocuments(e,r))}));a$(e,r,null),aK(e,r),e.sharedClientState.updateMutationState(r,"acknowledged"),await aH(e,i)}catch(e){await es(e)}}async function az(e,t,n){var r;try{let i=await (r=e.localStore,r.persistence.runTransaction("Reject batch","readwrite-primary",e=>{let n;return r.mutationQueue.lookupMutationBatch(e,t).next(t=>(null!==t||E(),n=t.keys(),r.mutationQueue.removeMutationBatch(e,t))).next(()=>r.mutationQueue.performConsistencyCheck(e)).next(()=>r.documentOverlayCache.removeOverlaysForBatchId(e,n,t)).next(()=>r.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,n)).next(()=>r.localDocuments.getDocuments(e,n))}));a$(e,t,n),aK(e,t),e.sharedClientState.updateMutationState(t,"rejected",n),await aH(e,i)}catch(e){await es(e)}}async function aG(e,t){var n;sZ(e.remoteStore)||I("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{let r=await (n=e.localStore).persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>n.mutationQueue.getHighestUnacknowledgedBatchId(e));if(-1===r)return void t.resolve();let i=e.ka.get(r)||[];i.push(t),e.ka.set(r,i)}catch(n){let e=al(n,"Initialization of waitForPendingWrites() operation failed");t.reject(e)}}function aK(e,t){(e.ka.get(t)||[]).forEach(e=>{e.resolve()}),e.ka.delete(t)}function a$(e,t,n){let r=e.Ba[e.currentUser.toKey()];if(r){let i=r.get(t);i&&(n?i.reject(n):i.resolve(),r=r.remove(t)),e.Ba[e.currentUser.toKey()]=r}}function aQ(e,t,n=null){for(let r of(e.sharedClientState.removeLocalQueryTarget(t),e.Ma.get(t)))e.Fa.delete(r),n&&e.Ca.$a(r,n);e.Ma.delete(t),e.isPrimaryClient&&e.La.gr(t).forEach(t=>{e.La.containsKey(t)||aj(e,t)})}function aj(e,t){e.xa.delete(t.path.canonicalString());let n=e.Oa.get(t);null!==n&&(sW(e.remoteStore,n),e.Oa=e.Oa.remove(t),e.Na.delete(n),aJ(e))}function aW(e,t,n){for(let r of n)r instanceof aS?(e.La.addReference(r.key,t),function(e,t){let n=t.key,r=n.path.canonicalString();e.Oa.get(n)||e.xa.has(r)||(I("SyncEngine","New document in limbo: "+n),e.xa.add(r),aJ(e))}(e,r)):r instanceof ax?(I("SyncEngine","Document no longer in limbo: "+r.key),e.La.removeReference(r.key,t),e.La.containsKey(r.key)||aj(e,r.key)):E()}function aJ(e){for(;e.xa.size>0&&e.Oa.size<e.maxConcurrentLimboResolutions;){let t=e.xa.values().next().value;e.xa.delete(t);let n=new Q(G.fromString(t)),r=e.qa.next();e.Na.set(r,new aN(n)),e.Oa=e.Oa.insert(n,r),sj(e.remoteStore,new rM(t9(t4(n.path)),r,"TargetPurposeLimboResolution",ev.oe))}}async function aH(e,t,n){let r=[],i=[],s=[];e.Fa.isEmpty()||(e.Fa.forEach((a,o)=>{s.push(e.Ka(o,t,n).then(t=>{var s;if((t||n)&&e.isPrimaryClient){let r=t?!t.fromCache:null==(s=null==n?void 0:n.targetChanges.get(o.targetId))?void 0:s.current;e.sharedClientState.updateQueryState(o.targetId,r?"current":"not-current")}if(t){r.push(t);let e=sn.Wi(o.targetId,t);i.push(e)}}))}),await Promise.all(s),e.Ca.d_(r),await async function(e,t){try{await e.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>ea.forEach(t,t=>ea.forEach(t.$i,r=>e.persistence.referenceDelegate.addReference(n,t.targetId,r)).next(()=>ea.forEach(t.Ui,r=>e.persistence.referenceDelegate.removeReference(n,t.targetId,r)))))}catch(e){if(!ed(e))throw e;I("LocalStore","Failed to update sequence numbers: "+e)}for(let n of t){let t=n.targetId;if(!n.fromCache){let n=e.os.get(t),r=n.snapshotVersion,i=n.withLastLimboFreeSnapshotVersion(r);e.os=e.os.insert(t,i)}}}(e.localStore,i))}async function aY(e,t){if(!e.currentUser.isEqual(t)){I("SyncEngine","User change. New user:",t.toKey());let n=await sa(e.localStore,t);e.currentUser=t,e.ka.forEach(e=>{e.forEach(e=>{e.reject(new x(S.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.ka.clear(),e.sharedClientState.handleUserChange(t,n.removedBatchIds,n.addedBatchIds),await aH(e,n.hs)}}function aX(e,t){let n=e.Na.get(t);if(n&&n.va)return ny().add(n.key);{let n=ny(),r=e.Ma.get(t);if(!r)return n;for(let t of r){let r=e.Fa.get(t);n=n.unionWith(r.view.Va)}return n}}async function aZ(e,t){let n=await sh(e.localStore,t.query,!0),r=t.view.ba(n);return e.isPrimaryClient&&aW(e,t.targetId,r.wa),r}async function a0(e,t){return sf(e.localStore,t).then(t=>aH(e,t))}async function a1(e,t,n,r){var i;let s=await function(e,t){let n=e.mutationQueue;return e.persistence.runTransaction("Lookup mutation documents","readonly",r=>n.Mn(r,t).next(t=>t?e.localDocuments.getDocuments(r,t):ea.resolve(null)))}(e.localStore,t);null!==s?("pending"===n?await s3(e.remoteStore):"acknowledged"===n||"rejected"===n?(a$(e,t,r||null),aK(e,t),i=e.localStore,i.mutationQueue.On(t)):E(),await aH(e,s)):I("SyncEngine","Cannot apply mutation batch with id: "+t)}async function a2(e,t){if(a9(e),a7(e),!0===t&&!0!==e.Qa){let t=e.sharedClientState.getAllActiveQueryTargets(),n=await a5(e,t.toArray());for(let t of(e.Qa=!0,await ai(e.remoteStore,!0),n))sj(e.remoteStore,t)}else if(!1===t&&!1!==e.Qa){let t=[],n=Promise.resolve();e.Ma.forEach((r,i)=>{e.sharedClientState.isLocalQueryTarget(i)?t.push(i):n=n.then(()=>(aQ(e,i),sc(e.localStore,i,!0))),sW(e.remoteStore,i)}),await n,await a5(e,t),e.Na.forEach((t,n)=>{sW(e.remoteStore,n)}),e.La.pr(),e.Na=new Map,e.Oa=new eX(Q.comparator),e.Qa=!1,await ai(e.remoteStore,!1)}}async function a5(e,t,n){let r=[],i=[];for(let n of t){let t,s=e.Ma.get(n);if(s&&0!==s.length)for(let n of(t=await su(e.localStore,t9(s[0])),s)){let t=e.Fa.get(n),r=await aZ(e,t);r.snapshot&&i.push(r.snapshot)}else{let r=await sd(e.localStore,n);t=await su(e.localStore,r),await aM(e,a4(r),n,!1,t.resumeToken)}r.push(t)}return e.Ca.d_(i),r}function a4(e){var t,n,r,i,s;return t=e.path,n=e.collectionGroup,r=e.orderBy,i=e.filters,s=e.limit,new t5(t,n,r,i,s,"F",e.startAt,e.endAt)}function a8(e){return e.localStore.persistence.Qi()}async function a3(e,t,n,r){if(e.Qa)return void I("SyncEngine","Ignoring unexpected query state notification.");let i=e.Ma.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{let r=await sf(e.localStore,no(i[0])),s=n6.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,e3.EMPTY_BYTE_STRING);await aH(e,r,s);break}case"rejected":await sc(e.localStore,t,!0),aQ(e,t,r);break;default:E()}}async function a6(e,t,n){let r=a9(e);if(r.Qa){for(let e of t){if(r.Ma.has(e)&&r.sharedClientState.isActiveQueryTarget(e)){I("SyncEngine","Adding an already active target "+e);continue}let t=await sd(r.localStore,e),n=await su(r.localStore,t);await aM(r,a4(t),n.targetId,!1,n.resumeToken),sj(r.remoteStore,n)}for(let e of n)r.Ma.has(e)&&await sc(r.localStore,e,!1).then(()=>{sW(r.remoteStore,e),aQ(r,e)}).catch(es)}}function a9(e){return e.remoteStore.remoteSyncer.applyRemoteEvent=aO.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=aX.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=aU.bind(null,e),e.Ca.d_=ay.bind(null,e.eventManager),e.Ca.$a=aw.bind(null,e.eventManager),e}function a7(e){return e.remoteStore.remoteSyncer.applySuccessfulWrite=aB.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=az.bind(null,e),e}class oe{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=sP(e.databaseInfo.databaseId),this.sharedClientState=this.Wa(e),this.persistence=this.Ga(e),await this.persistence.start(),this.localStore=this.za(e),this.gcScheduler=this.ja(e,this.localStore),this.indexBackfillerScheduler=this.Ha(e,this.localStore)}ja(e,t){return null}Ha(e,t){return null}za(e){var t,n;return t=this.persistence,n=new si,new ss(t,n,e.initialUser,this.serializer)}Ga(e){return new i1(i5.Zr,this.serializer)}Wa(e){return new sx}async terminate(){var e,t;null==(e=this.gcScheduler)||e.stop(),null==(t=this.indexBackfillerScheduler)||t.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}oe.provider={build:()=>new oe};class ot extends oe{constructor(e){super(),this.cacheSizeBytes=e}ja(e,t){return this.persistence.referenceDelegate instanceof i4||E(),new iR(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Ga(e){let t=void 0!==this.cacheSizeBytes?iy.withCacheSize(this.cacheSizeBytes):iy.DEFAULT;return new i1(e=>i4.Zr(e,t),this.serializer)}}class on extends oe{constructor(e,t,n){super(),this.Ja=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.kind="persistent",this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Ja.initialize(this,e),await a7(this.Ja.syncEngine),await s3(this.Ja.remoteStore),await this.persistence.yi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}za(e){var t,n;return t=this.persistence,n=new si,new ss(t,n,e.initialUser,this.serializer)}ja(e,t){return new iR(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Ha(e,t){let n=new ew(t,this.persistence);return new ey(e.asyncQueue,n)}Ga(e){let t=st(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?iy.withCacheSize(this.cacheSizeBytes):iy.DEFAULT;return new i9(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,sL(),sV(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Wa(e){return new sx}}class or extends on{constructor(e,t){super(e,t,!1),this.Ja=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);let t=this.Ja.syncEngine;this.sharedClientState instanceof sS&&(this.sharedClientState.syncEngine={no:a1.bind(null,t),ro:a3.bind(null,t),io:a6.bind(null,t),Qi:a8.bind(null,t),eo:a0.bind(null,t)},await this.sharedClientState.start()),await this.persistence.yi(async e=>{await a2(this.Ja.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}Wa(e){let t=sL();if(!sS.D(t))throw new x(S.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");let n=st(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new sS(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class oi{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>aq(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=aY.bind(null,this.syncEngine),await ai(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new af}createDatastore(e){var t;let n=sP(e.databaseInfo.databaseId),r=new sM(e.databaseInfo);return t=e.authCredentials,new sz(t,e.appCheckCredentials,r,n)}createRemoteStore(e){var t,n;return t=this.localStore,n=this.datastore,new sK(t,n,e.asyncQueue,e=>aq(this.syncEngine,e,0),sD.D()?new sD:new sC)}createSyncEngine(e,t){return function(e,t,n,r,i,s,a){let o=new aA(e,t,n,r,i,s);return a&&(o.Qa=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){var e,t;await async function(e){I("RemoteStore","RemoteStore shutting down."),e.L_.add(5),await sQ(e),e.k_.shutdown(),e.q_.set("Unknown")}(this.remoteStore),null==(e=this.datastore)||e.terminate(),null==(t=this.eventManager)||t.terminate()}}function os(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){let r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}oi.provider={build:()=>new oi};class oa{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.Ya(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.Ya(this.observer.error,e):_("Uncaught Error in snapshot listener:",e.toString()))}Za(){this.muted=!0}Ya(e,t){setTimeout(()=>{this.muted||e(t)},0)}}class oo{constructor(e,t){this.Xa=e,this.serializer=t,this.metadata=new C,this.buffer=new Uint8Array,this.eu=new TextDecoder("utf-8"),this.tu().then(e=>{e&&e.ua()?this.metadata.resolve(e.aa.metadata):this.metadata.reject(Error(`The first element of the bundle is not a metadata, it is
             ${JSON.stringify(null==e?void 0:e.aa)}`))},e=>this.metadata.reject(e))}close(){return this.Xa.cancel()}async getMetadata(){return this.metadata.promise}async Ua(){return await this.getMetadata(),this.tu()}async tu(){let e=await this.nu();if(null===e)return null;let t=this.eu.decode(e),n=Number(t);return isNaN(n)&&this.ru(`length string (${t}) is not valid number`),new a_(JSON.parse(await this.iu(n)),e.length+n)}su(){return this.buffer.findIndex(e=>123===e)}async nu(){for(;0>this.su()&&!await this.ou(););if(0===this.buffer.length)return null;let e=this.su();e<0&&this.ru("Reached the end of bundle when a length string is expected.");let t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async iu(e){for(;this.buffer.length<e;)await this.ou()&&this.ru("Reached the end of bundle when more is expected.");let t=this.eu.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}ru(e){throw this.Xa.cancel(),Error(`Invalid bundle format: ${e}`)}async ou(){let e=await this.Xa.read();if(!e.done){let t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class ol{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new x(S.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;let t=await async function(e,t){let n={documents:t.map(t=>ry(e.serializer,t))},r=await e.Lo("BatchGetDocuments",e.serializer.databaseId,G.emptyPath(),n,t.length),i=new Map;r.forEach(t=>{var n;let r=(n=e.serializer,"found"in t?function(e,t){t.found||E(),t.found.name,t.found.updateTime;let n=rw(e,t.found.name),r=rf(t.found.updateTime),i=t.found.createTime?rf(t.found.createTime):B.min(),s=new tC({mapValue:{fields:t.found.fields}});return tD.newFoundDocument(n,r,i,s)}(n,t):"missing"in t?function(e,t){t.missing||E(),t.readTime||E();let n=rw(e,t.missing),r=rf(t.readTime);return tD.newNoDocument(n,r)}(n,t):E());i.set(r.key.toString(),r)});let s=[];return t.forEach(e=>{let t=i.get(e.toString());t||E(),s.push(t)}),s}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastTransactionError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new n$(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;let e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((e,t)=>{let n=Q.fromPath(t);this.mutations.push(new nQ(n,this.precondition(n)))}),await async function(e,t){let n={writes:t.map(t=>rS(e.serializer,t))};await e.Mo("Commit",e.serializer.databaseId,G.emptyPath(),n)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw E();t=B.min()}let n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new x(S.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){let t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(B.min())?nM.exists(!1):nM.updateTime(t):nM.none()}preconditionForUpdate(e){let t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(B.min()))throw new x(S.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return nM.updateTime(t)}return nM.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class ou{constructor(e,t,n,r,i){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=i,this._u=n.maxAttempts,this.t_=new sO(this.asyncQueue,"transaction_retry")}au(){this._u-=1,this.uu()}uu(){this.t_.Go(async()=>{let e=new ol(this.datastore),t=this.cu(e);t&&t.then(t=>{this.asyncQueue.enqueueAndForget(()=>e.commit().then(()=>{this.deferred.resolve(t)}).catch(e=>{this.lu(e)}))}).catch(e=>{this.lu(e)})})}cu(e){try{let t=this.updateFunction(e);return!eI(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}lu(e){this._u>0&&this.hu(e)?(this._u-=1,this.asyncQueue.enqueueAndForget(()=>(this.uu(),Promise.resolve()))):this.deferred.reject(e)}hu(e){if("FirebaseError"===e.name){let t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!nX(t)}return!1}}class oc{constructor(e,t,n,r,i){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=p.UNAUTHENTICATED,this.clientId=P.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=i,this.authCredentials.start(n,async e=>{I("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(I("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();let e=new C;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(n){let t=al(n,"Failed to shutdown persistence");e.reject(t)}}),e.promise}}async function oh(e,t){e.asyncQueue.verifyOperationInProgress(),I("FirestoreClient","Initializing OfflineComponentProvider");let n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await sa(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function od(e,t){e.asyncQueue.verifyOperationInProgress();let n=await of(e);I("FirestoreClient","Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener(e=>ar(t.remoteStore,e)),e.setAppCheckTokenChangeListener((e,n)=>ar(t.remoteStore,n)),e._onlineComponents=t}async function of(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){I("FirestoreClient","Using user provided OfflineComponentProvider");try{await oh(e,e._uninitializedComponentsProvider._offline)}catch(t){if(!("FirebaseError"===t.name?t.code===S.FAILED_PRECONDITION||t.code===S.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code))throw t;b("Error using user provided cache. Falling back to memory cache: "+t),await oh(e,new oe)}}else I("FirestoreClient","Using default OfflineComponentProvider"),await oh(e,new oe);return e._offlineComponents}async function om(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(I("FirestoreClient","Using user provided OnlineComponentProvider"),await od(e,e._uninitializedComponentsProvider._online)):(I("FirestoreClient","Using default OnlineComponentProvider"),await od(e,new oi))),e._onlineComponents}function og(e){return of(e).then(e=>e.persistence)}function op(e){return of(e).then(e=>e.localStore)}function oy(e){return om(e).then(e=>e.remoteStore)}function ow(e){return om(e).then(e=>e.syncEngine)}function ov(e){return om(e).then(e=>e.datastore)}async function oI(e){let t=await om(e),n=t.eventManager;return n.onListen=ak.bind(null,t.syncEngine),n.onUnlisten=aL.bind(null,t.syncEngine),n.onFirstRemoteStoreListen=aR.bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=aV.bind(null,t.syncEngine),n}function o_(e,t,n={}){let r=new C;return e.asyncQueue.enqueueAndForget(async()=>(function(e,t,n,r,i){let s=new oa({next:o=>{s.Za(),t.enqueueAndForget(()=>ap(e,a));let l=o.docs.has(n);!l&&o.fromCache?i.reject(new x(S.UNAVAILABLE,"Failed to get document because the client is offline.")):l&&o.fromCache&&r&&"server"===r.source?i.reject(new x(S.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):i.resolve(o)},error:e=>i.reject(e)}),a=new aI(t4(n.path),s,{includeMetadataChanges:!0,_a:!0});return ag(e,a)})(await oI(e),e.asyncQueue,t,n,r)),r.promise}function ob(e,t,n={}){let r=new C;return e.asyncQueue.enqueueAndForget(async()=>(function(e,t,n,r,i){let s=new oa({next:n=>{s.Za(),t.enqueueAndForget(()=>ap(e,a)),n.fromCache&&"server"===r.source?i.reject(new x(S.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(n)},error:e=>i.reject(e)}),a=new aI(n,s,{includeMetadataChanges:!0,_a:!0});return ag(e,a)})(await oI(e),e.asyncQueue,t,n,r)),r.promise}function oT(e){let t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}let oE=new Map;function oS(e,t,n){if(!n)throw new x(S.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function ox(e,t,n,r){if(!0===t&&!0===r)throw new x(S.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function oC(e){if(!Q.isDocumentKey(e))throw new x(S.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function oD(e){if(Q.isDocumentKey(e))throw new x(S.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function oN(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{var t;let n=(t=e).constructor?t.constructor.name:null;return n?`a custom ${n} object`:"an object"}}return"function"==typeof e?"a function":E()}function oA(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new x(S.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let n=oN(e);throw new x(S.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function ok(e,t){if(t<=0)throw new x(S.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class oR{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new x(S.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null==(t=e.ssl)||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=0x2800000;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new x(S.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}ox("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=oT(null!=(n=e.experimentalLongPollingOptions)?n:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new x(S.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new x(S.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new x(S.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){var t,n;return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class oF{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new oR({}),this._settingsFrozen=!1,this._terminateTask="notTerminated"}get app(){if(!this._app)throw new x(S.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new x(S.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new oR(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new N;switch(e.type){case"firstParty":return new F(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new x(S.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){"notTerminated"===this._terminateTask?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){let t=oE.get(e);t&&(I("ComponentProvider","Removing Datastore"),oE.delete(e),t.terminate())}(this),Promise.resolve()}}function oM(e,t,n,r={}){var i;let s=(e=oA(e,oF))._getSettings(),a=`${t}:${n}`;if("firestore.googleapis.com"!==s.host&&s.host!==a&&b("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),e._setSettings(Object.assign(Object.assign({},s),{host:a,ssl:!1})),r.mockUserToken){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=p.MOCK_USER;else{t=d.createMockUserToken(r.mockUserToken,null==(i=e._app)?void 0:i.options.projectId);let s=r.mockUserToken.sub||r.mockUserToken.user_id;if(!s)throw new x(S.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new p(s)}e._authCredentials=new A(new D(t,n))}}class oL{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new oL(this.firestore,e,this._query)}}class oV{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new oP(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new oV(this.firestore,e,this._key)}}class oP extends oL{constructor(e,t,n){super(e,t,t4(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let e=this._path.popLast();return e.isEmpty()?null:new oV(this.firestore,null,new Q(e))}withConverter(e){return new oP(this.firestore,e,this._path)}}function oO(e,t,...n){if(e=d.getModularInstance(e),1==arguments.length&&(t=P.newId()),oS("doc","path",t),e instanceof oF){let r=G.fromString(t,...n);return oC(r),new oV(e,null,new Q(r))}{if(!(e instanceof oV||e instanceof oP))throw new x(S.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=e._path.child(G.fromString(t,...n));return oC(r),new oV(e.firestore,e instanceof oP?e.converter:null,new Q(r))}}function oq(e,t){return e=d.getModularInstance(e),t=d.getModularInstance(t),e instanceof oL&&t instanceof oL&&e.firestore===t.firestore&&nr(e._query,t._query)&&e.converter===t.converter}class oU{constructor(e=Promise.resolve()){this.Pu=[],this.Iu=!1,this.Tu=[],this.Eu=null,this.du=!1,this.Au=!1,this.Ru=[],this.t_=new sO(this,"async_queue_retry"),this.Vu=()=>{let e=sV();e&&I("AsyncQueue","Visibility state changed to "+e.visibilityState),this.t_.jo()},this.mu=e;let t=sV();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Vu)}get isShuttingDown(){return this.Iu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.fu(),this.gu(e)}enterRestrictedMode(e){if(!this.Iu){this.Iu=!0,this.Au=e||!1;let t=sV();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Vu)}}enqueue(e){if(this.fu(),this.Iu)return new Promise(()=>{});let t=new C;return this.gu(()=>this.Iu&&this.Au?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Pu.push(e),this.pu()))}async pu(){if(0!==this.Pu.length){try{await this.Pu[0](),this.Pu.shift(),this.t_.reset()}catch(e){if(!ed(e))throw e;I("AsyncQueue","Operation failed with retryable error: "+e)}this.Pu.length>0&&this.t_.Go(()=>this.pu())}}gu(e){let t=this.mu.then(()=>(this.du=!0,e().catch(e=>{let t;throw this.Eu=e,this.du=!1,_("INTERNAL UNHANDLED ERROR: ",(t=e.message||"",e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t)),e}).then(e=>(this.du=!1,e))));return this.mu=t,t}enqueueAfterDelay(e,t,n){this.fu(),this.Ru.indexOf(e)>-1&&(t=0);let r=ao.createAndSchedule(this,e,t,n,e=>this.yu(e));return this.Tu.push(r),r}fu(){this.Eu&&E()}verifyOperationInProgress(){}async wu(){let e;do e=this.mu,await e;while(e!==this.mu)}Su(e){for(let t of this.Tu)if(t.timerId===e)return!0;return!1}bu(e){return this.wu().then(()=>{for(let t of(this.Tu.sort((e,t)=>e.targetTimeMs-t.targetTimeMs),this.Tu))if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.wu()})}Du(e){this.Ru.push(e)}yu(e){let t=this.Tu.indexOf(e);this.Tu.splice(t,1)}}function oB(e){if("object"!=typeof e||null===e)return!1;for(let t of["next","error","complete"])if(t in e&&"function"==typeof e[t])return!0;return!1}class oz{constructor(){this._progressObserver={},this._taskCompletionResolver=new C,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}class oG extends oF{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new oU,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){let e=this._firestoreClient.terminate();this._queue=new oU(e),this._firestoreClient=void 0,await e}}}function oK(e){if(e._terminated)throw new x(S.FAILED_PRECONDITION,"The client has already been terminated.");return e._firestoreClient||o$(e),e._firestoreClient}function o$(e){var t,n,r,i,s;let a=e._freezeSettings(),o=(i=e._databaseId,s=(null==(t=e._app)?void 0:t.options.appId)||"",new ti(i,s,e._persistenceKey,a.host,a.ssl,a.experimentalForceLongPolling,a.experimentalAutoDetectLongPolling,oT(a.experimentalLongPollingOptions),a.useFetchStreams));e._componentsProvider||(null==(n=a.localCache)?void 0:n._offlineComponentProvider)&&(null==(r=a.localCache)?void 0:r._onlineComponentProvider)&&(e._componentsProvider={_offline:a.localCache._offlineComponentProvider,_online:a.localCache._onlineComponentProvider}),e._firestoreClient=new oc(e._authCredentials,e._appCheckCredentials,e._queue,o,e._componentsProvider&&function(e){let t=null==e?void 0:e._online.build();return{_offline:null==e?void 0:e._offline.build(t),_online:t}}(e._componentsProvider))}async function oQ(e){b("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let t=e._freezeSettings();oj(e,oi.provider,{build:e=>new or(e,t.cacheSizeBytes)})}function oj(e,t,n){if((e=oA(e,oG))._firestoreClient||e._terminated)throw new x(S.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.");if(e._componentsProvider||e._getSettings().localCache)throw new x(S.FAILED_PRECONDITION,"SDK cache is already specified.");e._componentsProvider={_online:t,_offline:n},o$(e)}class oW{constructor(e="count",t){this._internalFieldPath=t,this.type="AggregateField",this.aggregateType=e}}class oJ{constructor(e,t,n){this._userDataWriter=t,this._data=n,this.type="AggregateQuerySnapshot",this.query=e}data(){return this._userDataWriter.convertObjectMap(this._data)}}class oH{constructor(e){this._byteString=e}static fromBase64String(e){try{return new oH(e3.fromBase64String(e))}catch(e){throw new x(S.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new oH(e3.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class oY{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new x(S.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new $(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class oX{constructor(e){this._methodName=e}}class oZ{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new x(S.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new x(S.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return O(this._lat,e._lat)||O(this._long,e._long)}}class o0{constructor(e){this._values=(e||[]).map(e=>e)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(this._values,e._values)}}let o1=/^__.*__$/;class o2{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new nB(e,this.data,this.fieldMask,t,this.fieldTransforms):new nU(e,this.data,t,this.fieldTransforms)}}class o5{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new nB(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function o4(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw E()}}class o8{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.vu(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get Cu(){return this.settings.Cu}Fu(e){return new o8(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Mu(e){var t;let n=null==(t=this.path)?void 0:t.child(e),r=this.Fu({path:n,xu:!1});return r.Ou(e),r}Nu(e){var t;let n=null==(t=this.path)?void 0:t.child(e),r=this.Fu({path:n,xu:!1});return r.vu(),r}Lu(e){return this.Fu({path:void 0,xu:!0})}Bu(e){return lg(e,this.settings.methodName,this.settings.ku||!1,this.path,this.settings.qu)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}vu(){if(this.path)for(let e=0;e<this.path.length;e++)this.Ou(this.path.get(e))}Ou(e){if(0===e.length)throw this.Bu("Document fields must not be empty");if(o4(this.Cu)&&o1.test(e))throw this.Bu('Document fields cannot begin and end with "__"')}}class o3{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||sP(e)}Qu(e,t,n,r=!1){return new o8({Cu:e,methodName:t,qu:n,path:$.emptyPath(),xu:!1,ku:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function o6(e){let t=e._freezeSettings(),n=sP(e._databaseId);return new o3(e._databaseId,!!t.ignoreUndefinedProperties,n)}function o9(e,t,n,r,i,s={}){let a,o,l=e.Qu(s.merge||s.mergeFields?2:0,t,n,i);lh("Data must be an object, but it was:",l,r);let u=lu(r,l);if(s.merge)a=new e4(l.fieldMask),o=l.fieldTransforms;else if(s.mergeFields){let e=[];for(let r of s.mergeFields){let i=ld(t,r,n);if(!l.contains(i))throw new x(S.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);lp(e,i)||e.push(i)}a=new e4(e),o=l.fieldTransforms.filter(e=>a.covers(e.field))}else a=null,o=l.fieldTransforms;return new o2(new tC(u),a,o)}class o7 extends oX{_toFieldTransform(e){if(2!==e.Cu)throw 1===e.Cu?e.Bu(`${this._methodName}() can only appear at the top level of your update data`):e.Bu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof o7}}function le(e,t,n){return new o8({Cu:3,qu:t.settings.qu,methodName:e._methodName,xu:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class lt extends oX{_toFieldTransform(e){return new nR(e.path,new nE)}isEqual(e){return e instanceof lt}}class ln extends oX{constructor(e,t){super(e),this.Ku=t}_toFieldTransform(e){let t=le(this,e,!0),n=new nS(this.Ku.map(e=>ll(e,t)));return new nR(e.path,n)}isEqual(e){return e instanceof ln&&d.deepEqual(this.Ku,e.Ku)}}class lr extends oX{constructor(e,t){super(e),this.Ku=t}_toFieldTransform(e){let t=le(this,e,!0),n=new nC(this.Ku.map(e=>ll(e,t)));return new nR(e.path,n)}isEqual(e){return e instanceof lr&&d.deepEqual(this.Ku,e.Ku)}}class li extends oX{constructor(e,t){super(e),this.$u=t}_toFieldTransform(e){let t=new nN(e.serializer,n_(e.serializer,this.$u));return new nR(e.path,t)}isEqual(e){return e instanceof li&&this.$u===e.$u}}function ls(e,t,n,r){let i=e.Qu(1,t,n);lh("Data must be an object, but it was:",i,r);let s=[],a=tC.empty();return eJ(r,(e,r)=>{let o=lm(t,e,n);r=d.getModularInstance(r);let l=i.Nu(o);if(r instanceof o7)s.push(o);else{let e=ll(r,l);null!=e&&(s.push(o),a.set(o,e))}}),new o5(a,new e4(s),i.fieldTransforms)}function la(e,t,n,r,i,s){let a=e.Qu(1,t,n),o=[ld(t,r,n)],l=[i];if(s.length%2!=0)throw new x(S.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<s.length;e+=2)o.push(ld(t,s[e])),l.push(s[e+1]);let u=[],c=tC.empty();for(let e=o.length-1;e>=0;--e)if(!lp(u,o[e])){let t=o[e],n=l[e];n=d.getModularInstance(n);let r=a.Nu(t);if(n instanceof o7)u.push(t);else{let e=ll(n,r);null!=e&&(u.push(t),c.set(t,e))}}return new o5(c,new e4(u),a.fieldTransforms)}function lo(e,t,n,r=!1){return ll(n,e.Qu(r?4:3,t))}function ll(e,t){if(lc(e=d.getModularInstance(e)))return lh("Unsupported field value:",t,e),lu(e,t);if(e instanceof oX)return function(e,t){if(!o4(t.Cu))throw t.Bu(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Bu(`${e._methodName}() is not currently supported inside arrays`);let n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.xu&&4!==t.Cu)throw t.Bu("Nested arrays are not supported");let n=[],r=0;for(let i of e){let e=ll(i,t.Lu(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}return function(e,t){if(null===(e=d.getModularInstance(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return n_(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){let n=U.fromDate(e);return{timestampValue:rh(t.serializer,n)}}if(e instanceof U){let n=new U(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:rh(t.serializer,n)}}if(e instanceof oZ)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof oH)return{bytesValue:rd(t.serializer,e._byteString)};if(e instanceof oV){let n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.Bu(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:rm(e.firestore._databaseId||t.databaseId,e._key.path)}}if(e instanceof o0)return{mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{values:e.toArray().map(e=>{if("number"!=typeof e)throw t.Bu("VectorValues must only contain numeric values.");return nv(t.serializer,e)})}}}}};throw t.Bu(`Unsupported field value: ${oN(e)}`)}(e,t)}function lu(e,t){let n={};return eY(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):eJ(e,(e,r)=>{let i=ll(r,t.Mu(e));null!=i&&(n[e]=i)}),{mapValue:{fields:n}}}function lc(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof U||e instanceof oZ||e instanceof oH||e instanceof oV||e instanceof oX||e instanceof o0)}function lh(e,t,n){if(!lc(n)||"object"!=typeof n||null===n||Object.getPrototypeOf(n)!==Object.prototype&&null!==Object.getPrototypeOf(n)){let r=oN(n);throw"an object"===r?t.Bu(e+" a custom object"):t.Bu(e+" "+r)}}function ld(e,t,n){if((t=d.getModularInstance(t))instanceof oY)return t._internalPath;if("string"==typeof t)return lm(e,t);throw lg("Field path arguments must be of type string or ",e,!1,void 0,n)}let lf=RegExp("[~\\*/\\[\\]]");function lm(e,t,n){if(t.search(lf)>=0)throw lg(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new oY(...t.split("."))._internalPath}catch(r){throw lg(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function lg(e,t,n,r,i){let s=r&&!r.isEmpty(),a=void 0!==i,o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let l="";return(s||a)&&(l+=" (found",s&&(l+=` in field ${r}`),a&&(l+=` in document ${i}`),l+=")"),new x(S.INVALID_ARGUMENT,o+e+l)}function lp(e,t){return e.some(e=>e.isEqual(t))}class ly{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new oV(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){let e=new lw(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){let t=this._document.data.field(lv("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class lw extends ly{data(){return super.data()}}function lv(e,t){return"string"==typeof t?lm(e,t):t instanceof oY?t._internalPath:t._delegate._internalPath}function lI(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new x(S.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class l_{}class lb extends l_{}class lT extends lb{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new lT(e,t,n)}_apply(e){let t=this._parse(e);return lR(e._query,t),new oL(e.firestore,e.converter,nt(e._query,t))}_parse(e){let t=o6(e.firestore);return function(e,t,n,r,i,s,a){let o;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new x(S.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){lk(a,s);let t=[];for(let n of a)t.push(lA(r,e,n));o={arrayValue:{values:t}}}else o=lA(r,e,a)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||lk(a,s),o=lo(n,t,a,"in"===s||"not-in"===s);return tM.create(i,s,o)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}}class lE extends l_{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new lE(e,t)}_parse(e){let t=this._queryConstraints.map(t=>t._parse(e)).filter(e=>e.getFilters().length>0);return 1===t.length?t[0]:tL.create(t,this._getOperator())}_apply(e){let t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;for(let e of t.getFlattenedFilters())lR(n,e),n=nt(n,e)}(e._query,t),new oL(e.firestore,e.converter,nt(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class lS extends lb{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new lS(e,t)}_apply(e){let t=function(e,t,n){if(null!==e.startAt)throw new x(S.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new x(S.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new tR(t,n)}(e._query,this._field,this._direction);return new oL(e.firestore,e.converter,function(e,t){let n=e.explicitOrderBy.concat([t]);return new t5(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}class lx extends lb{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new lx(e,t,n)}_apply(e){return new oL(e.firestore,e.converter,nn(e._query,this._limit,this._limitType))}}class lC extends lb{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new lC(e,t,n)}_apply(e){var t;let n=lN(e,this.type,this._docOrFields,this._inclusive);return new oL(e.firestore,e.converter,(t=e._query,new t5(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,n,t.endAt)))}}class lD extends lb{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new lD(e,t,n)}_apply(e){var t;let n=lN(e,this.type,this._docOrFields,this._inclusive);return new oL(e.firestore,e.converter,(t=e._query,new t5(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,n)))}}function lN(e,t,n,r){if(n[0]=d.getModularInstance(n[0]),n[0]instanceof ly)return function(e,t,n,r,i){if(!r)throw new x(S.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);let s=[];for(let n of t6(e))if(n.field.isKeyField())s.push(tg(t,r.key));else{let e=r.data.field(n.field);if(tt(e))throw new x(S.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){let e=n.field.canonicalString();throw new x(S.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}s.push(e)}return new tN(s,i)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{let i=o6(e.firestore);return function(e,t,n,r,i,s){let a=e.explicitOrderBy;if(i.length>a.length)throw new x(S.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let o=[];for(let s=0;s<i.length;s++){let l=i[s];if(a[s].field.isKeyField()){if("string"!=typeof l)throw new x(S.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof l}`);if(!t3(e)&&-1!==l.indexOf("/"))throw new x(S.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${l}' contains a slash.`);let n=e.path.child(G.fromString(l));if(!Q.isDocumentKey(n))throw new x(S.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);let i=new Q(n);o.push(tg(t,i))}else{let e=lo(n,r,l);o.push(e)}}return new tN(o,s)}(e._query,e.firestore._databaseId,i,t,n,r)}}function lA(e,t,n){if("string"==typeof(n=d.getModularInstance(n))){if(""===n)throw new x(S.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!t3(t)&&-1!==n.indexOf("/"))throw new x(S.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);let r=t.path.child(G.fromString(n));if(!Q.isDocumentKey(r))throw new x(S.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return tg(e,new Q(r))}if(n instanceof oV)return tg(e,n._key);throw new x(S.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${oN(n)}.`)}function lk(e,t){if(!Array.isArray(e)||0===e.length)throw new x(S.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function lR(e,t){let n=function(e,t){for(let n of e)for(let e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new x(S.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new x(S.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}function lF(e,t){if(!(t instanceof lT||t instanceof lE))throw new x(S.INVALID_ARGUMENT,`Function ${e}() requires AppliableConstraints created with a call to 'where(...)', 'or(...)', or 'and(...)'.`)}class lM{convertValue(e,t="none"){switch(tl(e)){case 0:return null;case 1:return e.booleanValue;case 2:return e7(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(te(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw E()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){let n={};return eJ(e,(e,r)=>{n[e]=this.convertValue(r,t)}),n}convertVectorValue(e){var t,n,r;return new o0(null==(r=null==(n=null==(t=e.fields)?void 0:t.value.arrayValue)?void 0:n.values)?void 0:r.map(e=>e7(e.doubleValue)))}convertGeoPoint(e){return new oZ(e7(e.latitude),e7(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":let n=tn(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(tr(e));default:return null}}convertTimestamp(e){let t=e9(e);return new U(t.seconds,t.nanos)}convertDocumentKey(e,t){let n=G.fromString(e);rF(n)||E();let r=new ts(n.get(1),n.get(3)),i=new Q(n.popFirst(5));return r.isEqual(t)||_(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}function lL(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class lV extends lM{constructor(e){super(),this.firestore=e}convertBytes(e){return new oH(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new oV(this.firestore,null,t)}}function lP(){return new oW("count")}class lO{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class lq extends ly{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){let t=new lU(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){let n=this._document.data.field(lv("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class lU extends lq{data(e={}){return super.data(e)}}class lB{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new lO(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){let e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach(n=>{e.call(t,new lU(this._firestore,this._userDataWriter,n.key,n,new lO(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){let t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new x(S.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map(n=>{let r=new lU(e._firestore,e._userDataWriter,n.doc.key,n.doc,new lO(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}})}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter(e=>t||3!==e.type).map(t=>{let r=new lU(e._firestore,e._userDataWriter,t.doc.key,t.doc,new lO(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter),i=-1,s=-1;return 0!==t.type&&(i=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(s=(n=n.add(t.doc)).indexOf(t.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return E()}}(t.type),doc:r,oldIndex:i,newIndex:s}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}class lz extends lM{constructor(e){super(),this.firestore=e}convertBytes(e){return new oH(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new oV(this.firestore,null,t)}}function lG(e,t){var n=oK(e);let r=new C;return n.asyncQueue.enqueueAndForget(async()=>aP(await ow(n),t,r)),r.promise}function lK(e,t,n){let r=n.docs.get(t._key),i=new lz(e);return new lq(e,i,t._key,r,new lO(n.hasPendingWrites,n.fromCache),t.converter)}function l$(e,t){let n=oA(e.firestore,oG),r=oK(n),i=eH(t,(e,t)=>new nH(t,e.aggregateType,e._internalFieldPath));return(function(e,t,n){let r=new C;return e.asyncQueue.enqueueAndForget(async()=>{try{let i=await ov(e);r.resolve(async function(e,t,n){var r;let{request:i,ut:s,parent:a}=rN(e.serializer,t7(t),n);e.connection.Fo||delete i.parent;let o=(await e.Lo("RunAggregationQuery",e.serializer.databaseId,a,i,1)).filter(e=>!!e.result);1===o.length||E();let l=null==(r=o[0].result)?void 0:r.aggregateFields;return Object.keys(l).reduce((e,t)=>(e[s[t]]=l[t],e),{})}(i,t,n))}catch(e){r.reject(e)}}),r.promise})(r,e._query,i).then(t=>new oJ(e,new lz(n),t))}class lQ{constructor(e){this.kind="memory",this._onlineComponentProvider=oi.provider,(null==e?void 0:e.garbageCollector)?this._offlineComponentProvider=e.garbageCollector._offlineComponentProvider:this._offlineComponentProvider=oe.provider}toJSON(){return{kind:this.kind}}}class lj{constructor(e){let t;this.kind="persistent",(null==e?void 0:e.tabManager)?(e.tabManager._initialize(e),t=e.tabManager):(t=lX(void 0))._initialize(e),this._onlineComponentProvider=t._onlineComponentProvider,this._offlineComponentProvider=t._offlineComponentProvider}toJSON(){return{kind:this.kind}}}class lW{constructor(){this.kind="memoryEager",this._offlineComponentProvider=oe.provider}toJSON(){return{kind:this.kind}}}class lJ{constructor(e){this.kind="memoryLru",this._offlineComponentProvider={build:()=>new ot(e)}}toJSON(){return{kind:this.kind}}}class lH{constructor(e){this.forceOwnership=e,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=oi.provider,this._offlineComponentProvider={build:t=>new on(t,null==e?void 0:e.cacheSizeBytes,this.forceOwnership)}}}class lY{constructor(){this.kind="PersistentMultipleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=oi.provider,this._offlineComponentProvider={build:t=>new or(t,null==e?void 0:e.cacheSizeBytes)}}}function lX(e){return new lH(null==e?void 0:e.forceOwnership)}let lZ={maxAttempts:5};class l0{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=o6(e)}set(e,t,n){this._verifyNotCommitted();let r=l1(e,this._firestore),i=lL(r.converter,t,n),s=o9(this._dataReader,"WriteBatch.set",r._key,i,null!==r.converter,n);return this._mutations.push(s.toMutation(r._key,nM.none())),this}update(e,t,n,...r){let i;this._verifyNotCommitted();let s=l1(e,this._firestore);return i="string"==typeof(t=d.getModularInstance(t))||t instanceof oY?la(this._dataReader,"WriteBatch.update",s._key,t,n,r):ls(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,nM.exists(!0))),this}delete(e){this._verifyNotCommitted();let t=l1(e,this._firestore);return this._mutations=this._mutations.concat(new n$(t._key,nM.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new x(S.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function l1(e,t){if((e=d.getModularInstance(e)).firestore!==t)throw new x(S.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class l2 extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=o6(e)}get(e){let t=l1(e,this._firestore),n=new lV(this._firestore);return this._transaction.lookup([t._key]).then(e=>{if(!e||1!==e.length)return E();let r=e[0];if(r.isFoundDocument())return new ly(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new ly(this._firestore,n,t._key,null,t.converter);throw E()})}set(e,t,n){let r=l1(e,this._firestore),i=lL(r.converter,t,n),s=o9(this._dataReader,"Transaction.set",r._key,i,null!==r.converter,n);return this._transaction.set(r._key,s),this}update(e,t,n,...r){let i,s=l1(e,this._firestore);return i="string"==typeof(t=d.getModularInstance(t))||t instanceof oY?la(this._dataReader,"Transaction.update",s._key,t,n,r):ls(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){let t=l1(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){let t=l1(e,this._firestore),n=new lz(this._firestore);return super.get(e).then(e=>new lq(this._firestore,n,t._key,e._document,new lO(!1,!1),t.converter))}}function l5(e,t){if("string"!=typeof e[t])throw new x(S.INVALID_ARGUMENT,"Missing string value for: "+t);return e[t]}class l4{constructor(e){this._firestore=e,this.type="PersistentCacheIndexManager"}}function l8(e,t){var n;(n=oK(e._firestore),n.asyncQueue.enqueue(async()=>{var e;return e=await op(n),void(e.ss.zi=t)})).then(e=>I(`setting persistent cache index auto creation isEnabled=${t} succeeded`)).catch(e=>b(`setting persistent cache index auto creation isEnabled=${t} failed`,e))}let l3=new WeakMap;class l6{constructor(){throw Error("instances of this class should not be created")}static onExistenceFilterMismatch(e){return l9.instance.onExistenceFilterMismatch(e)}}class l9{constructor(){this.Uu=new Map}static get instance(){return l7||function(e){if(n0)throw Error("a TestingHooksSpi instance is already set");n0=e}(l7=new l9),l7}et(e){this.Uu.forEach(t=>t(e))}onExistenceFilterMismatch(e){let t=Symbol(),n=this.Uu;return n.set(t,e),()=>n.delete(t)}}let l7=null;!function(e=!0){y=u.SDK_VERSION,u._registerComponent(new c.Component("firestore",(t,{instanceIdentifier:n,options:r})=>{let i=t.getProvider("app").getImmediate(),s=new oG(new k(t.getProvider("auth-internal")),new L(t.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new x(S.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new ts(e.options.projectId,t)}(i,n),i);return r=Object.assign({useFetchStreams:e},r),s._setSettings(r),s},"PUBLIC").setMultipleInstances(!0)),u.registerVersion(g,"4.7.3",void 0),u.registerVersion(g,"4.7.3","cjs2017")}(),t.AbstractUserDataWriter=lM,t.AggregateField=oW,t.AggregateQuerySnapshot=oJ,t.Bytes=oH,t.CACHE_SIZE_UNLIMITED=-1,t.CollectionReference=oP,t.DocumentReference=oV,t.DocumentSnapshot=lq,t.FieldPath=oY,t.FieldValue=oX,t.Firestore=oG,t.FirestoreError=x,t.GeoPoint=oZ,t.LoadBundleTask=oz,t.PersistentCacheIndexManager=l4,t.Query=oL,t.QueryCompositeFilterConstraint=lE,t.QueryConstraint=lb,t.QueryDocumentSnapshot=lU,t.QueryEndAtConstraint=lD,t.QueryFieldFilterConstraint=lT,t.QueryLimitConstraint=lx,t.QueryOrderByConstraint=lS,t.QuerySnapshot=lB,t.QueryStartAtConstraint=lC,t.SnapshotMetadata=lO,t.Timestamp=U,t.Transaction=l2,t.VectorValue=o0,t.WriteBatch=l0,t._AutoId=P,t._ByteString=e3,t._DatabaseId=ts,t._DocumentKey=Q,t._EmptyAppCheckTokenProvider=V,t._EmptyAuthCredentialsProvider=N,t._FieldPath=$,t._TestingHooks=l6,t._cast=oA,t._debugAssert=function(e,t){e||E()},t._internalAggregationQueryToProtoRunAggregationQueryRequest=function(e,t){var n;let r=eH(t,(e,t)=>new nH(t,e.aggregateType,e._internalFieldPath)),i=null==(n=oK(oA(e.firestore,oG))._onlineComponents)?void 0:n.datastore.serializer;return void 0===i?null:rN(i,t7(e._query),r,!0).request},t._internalQueryToProtoQueryTarget=function(e){var t;let n=null==(t=oK(oA(e.firestore,oG))._onlineComponents)?void 0:t.datastore.serializer;return void 0===n?null:rD(n,t9(e._query))._t},t._isBase64Available=function(){return"undefined"!=typeof atob},t._logWarn=b,t._validateIsNotUsedTogether=ox,t.addDoc=function(e,t){let n=oA(e.firestore,oG),r=oO(e),i=lL(e.converter,t);return lG(n,[o9(o6(e.firestore),"addDoc",r._key,i,null!==e.converter,{}).toMutation(r._key,nM.exists(!1))]).then(()=>r)},t.aggregateFieldEqual=function(e,t){var n,r;return e instanceof oW&&t instanceof oW&&e.aggregateType===t.aggregateType&&(null==(n=e._internalFieldPath)?void 0:n.canonicalString())===(null==(r=t._internalFieldPath)?void 0:r.canonicalString())},t.aggregateQuerySnapshotEqual=function(e,t){return oq(e.query,t.query)&&d.deepEqual(e.data(),t.data())},t.and=function(...e){return e.forEach(e=>lF("and",e)),lE._create("and",e)},t.arrayRemove=function(...e){return new lr("arrayRemove",e)},t.arrayUnion=function(...e){return new ln("arrayUnion",e)},t.average=function(e){return new oW("avg",ld("average",e))},t.clearIndexedDbPersistence=function(e){if(e._initialized&&!e._terminated)throw new x(S.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");let t=new C;return e._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(e){if(!el.D())return Promise.resolve();await el.delete(e+"main")}(st(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}}),t.promise},t.collection=function(e,t,...n){if(e=d.getModularInstance(e),oS("collection","path",t),e instanceof oF){let r=G.fromString(t,...n);return oD(r),new oP(e,null,r)}{if(!(e instanceof oV||e instanceof oP))throw new x(S.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=e._path.child(G.fromString(t,...n));return oD(r),new oP(e.firestore,null,r)}},t.collectionGroup=function(e,t){if(e=oA(e,oF),oS("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new x(S.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new oL(e,null,new t5(G.emptyPath(),t))},t.connectFirestoreEmulator=oM,t.count=lP,t.deleteAllPersistentCacheIndexes=function(e){var t;(t=oK(e._firestore)).asyncQueue.enqueue(async()=>(function(e){let t=e.indexManager;return e.persistence.runTransaction("Delete All Indexes","readwrite",e=>t.deleteAllFieldIndexes(e))})(await op(t))).then(e=>I("deleting all persistent cache indexes succeeded")).catch(e=>b("deleting all persistent cache indexes failed",e))},t.deleteDoc=function(e){return lG(oA(e.firestore,oG),[new n$(e._key,nM.none())])},t.deleteField=function(){return new o7("deleteField")},t.disableNetwork=function(e){var t;return(t=oK(e=oA(e,oG))).asyncQueue.enqueue(async()=>{let e=await og(t),n=await oy(t);return e.setNetworkEnabled(!1),async function(e){e.L_.add(0),await sQ(e),e.q_.set("Offline")}(n)})},t.disablePersistentCacheIndexAutoCreation=function(e){l8(e,!1)},t.doc=oO,t.documentId=function(){return new oY("__name__")},t.enableIndexedDbPersistence=function(e,t){b("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let n=e._freezeSettings();return oj(e,oi.provider,{build:e=>new on(e,n.cacheSizeBytes,null==t?void 0:t.forceOwnership)}),Promise.resolve()},t.enableMultiTabIndexedDbPersistence=oQ,t.enableNetwork=function(e){var t;return(t=oK(e=oA(e,oG))).asyncQueue.enqueue(async()=>{let e=await og(t),n=await oy(t);return e.setNetworkEnabled(!0),n.L_.delete(0),s$(n)})},t.enablePersistentCacheIndexAutoCreation=function(e){l8(e,!0)},t.endAt=function(...e){return lD._create("endAt",e,!0)},t.endBefore=function(...e){return lD._create("endBefore",e,!1)},t.ensureFirestoreConfigured=oK,t.executeWrite=lG,t.getAggregateFromServer=l$,t.getCountFromServer=function(e){return l$(e,{count:lP()})},t.getDoc=function(e){e=oA(e,oV);let t=oA(e.firestore,oG);return o_(oK(t),e._key).then(n=>lK(t,e,n))},t.getDocFromCache=function(e){e=oA(e,oV);let t=oA(e.firestore,oG),n=oK(t),r=new lz(t);return(function(e,t){let n=new C;return e.asyncQueue.enqueueAndForget(async()=>(async function(e,t,n){try{let r=await e.persistence.runTransaction("read document","readonly",n=>e.localDocuments.getDocument(n,t));r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new x(S.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(r){let e=al(r,`Failed to get document '${t} from cache`);n.reject(e)}})(await op(e),t,n)),n.promise})(n,e._key).then(n=>new lq(t,r,e._key,n,new lO(null!==n&&n.hasLocalMutations,!0),e.converter))},t.getDocFromServer=function(e){e=oA(e,oV);let t=oA(e.firestore,oG);return o_(oK(t),e._key,{source:"server"}).then(n=>lK(t,e,n))},t.getDocs=function(e){e=oA(e,oL);let t=oA(e.firestore,oG),n=oK(t),r=new lz(t);return lI(e._query),ob(n,e._query).then(n=>new lB(t,r,e,n))},t.getDocsFromCache=function(e){e=oA(e,oL);let t=oA(e.firestore,oG),n=oK(t),r=new lz(t);return(function(e,t){let n=new C;return e.asyncQueue.enqueueAndForget(async()=>(async function(e,t,n){try{let r=await sh(e,t,!0),i=new aC(t,r.Ts),s=i.ma(r.documents),a=i.applyChanges(s,!1);n.resolve(a.snapshot)}catch(r){let e=al(r,`Failed to execute query '${t} against cache`);n.reject(e)}})(await op(e),t,n)),n.promise})(n,e._query).then(n=>new lB(t,r,e,n))},t.getDocsFromServer=function(e){e=oA(e,oL);let t=oA(e.firestore,oG),n=oK(t),r=new lz(t);return ob(n,e._query,{source:"server"}).then(n=>new lB(t,r,e,n))},t.getFirestore=function(e,t){let n="object"==typeof e?e:u.getApp(),r=u._getProvider(n,"firestore").getImmediate({identifier:"string"==typeof e?e:t||"(default)"});if(!r._initialized){let e=d.getDefaultEmulatorHostnameAndPort("firestore");e&&oM(r,...e)}return r},t.getPersistentCacheIndexManager=function(e){var t;e=oA(e,oG);let n=l3.get(e);if(n)return n;if("persistent"!==(null==(t=oK(e)._uninitializedComponentsProvider)?void 0:t._offline.kind))return null;let r=new l4(e);return l3.set(e,r),r},t.increment=function(e){return new li("increment",e)},t.initializeFirestore=function(e,t,n){n||(n="(default)");let r=u._getProvider(e,"firestore");if(r.isInitialized(n)){let e=r.getImmediate({identifier:n}),i=r.getOptions(n);if(d.deepEqual(i,t))return e;throw new x(S.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==t.cacheSizeBytes&&void 0!==t.localCache)throw new x(S.INVALID_ARGUMENT,"cache and cacheSizeBytes cannot be specified at the same time as cacheSizeBytes willbe deprecated. Instead, specify the cache size in the cache object");if(void 0!==t.cacheSizeBytes&&-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new x(S.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return r.initialize({options:t,instanceIdentifier:n})},t.limit=function(e){return ok("limit",e),lx._create("limit",e,"F")},t.limitToLast=function(e){return ok("limitToLast",e),lx._create("limitToLast",e,"L")},t.loadBundle=function(e,t){let n=oK(e=oA(e,oG)),r=new oz;return function(e,t,n,r){var i;let s=(i=sP(t),new oo(function(e,t){if(e instanceof Uint8Array)return os(e,void 0);if(e instanceof ArrayBuffer)return os(new Uint8Array(e),void 0);if(e instanceof ReadableStream)return e.getReader();throw Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}("string"==typeof n?n1().encode(n):n),i));e.asyncQueue.enqueueAndForget(async()=>{var t;(async function(e,t,n){try{var r;let i=await t.getMetadata();if(await function(e,t){let n=rf(t.createTime);return e.persistence.runTransaction("hasNewerBundle","readonly",n=>e.Gr.getBundleMetadata(n,t.id)).then(e=>!!e&&e.createTime.compareTo(n)>=0)}(e.localStore,i))return await t.close(),n._completeWith({taskState:"Success",documentsLoaded:i.totalDocuments,bytesLoaded:i.totalBytes,totalDocuments:i.totalDocuments,totalBytes:i.totalBytes}),Promise.resolve(new Set);n._updateProgress(aE(i));let s=new aT(i,e.localStore,t.serializer),a=await t.Ua();for(;a;){let e=await s.la(a);e&&n._updateProgress(e),a=await t.Ua()}let o=await s.complete();return await aH(e,o.Ia,void 0),await (r=e.localStore,r.persistence.runTransaction("Save bundle","readwrite",e=>r.Gr.saveBundleMetadata(e,i))),n._completeWith(o.progress),Promise.resolve(o.Pa)}catch(e){return b("SyncEngine",`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(t=await ow(e),s,r).then(e=>{t.sharedClientState.notifyBundleLoaded(e)})})}(n,e._databaseId,t,r),r},t.memoryEagerGarbageCollector=function(){return new lW},t.memoryLocalCache=function(e){return new lQ(e)},t.memoryLruGarbageCollector=function(e){return new lJ(null==e?void 0:e.cacheSizeBytes)},t.namedQuery=function(e,t){var n;return(n=oK(e=oA(e,oG)),n.asyncQueue.enqueue(async()=>{var e;return e=await op(n),e.persistence.runTransaction("Get named query","readonly",n=>e.Gr.getNamedQuery(n,t))})).then(t=>t?new oL(e,null,t.query):null)},t.onSnapshot=function(e,...t){let n,r,i;e=d.getModularInstance(e);let s={includeMetadataChanges:!1,source:"default"},a=0;"object"!=typeof t[0]||oB(t[a])||(s=t[a],a++);let o={includeMetadataChanges:s.includeMetadataChanges,source:s.source};if(oB(t[a])){let e=t[a];t[a]=null==(l=e.next)?void 0:l.bind(e),t[a+1]=null==(u=e.error)?void 0:u.bind(e),t[a+2]=null==(c=e.complete)?void 0:c.bind(e)}if(e instanceof oV)r=oA(e.firestore,oG),i=t4(e._key.path),n={next:n=>{t[a]&&t[a](lK(r,e,n))},error:t[a+1],complete:t[a+2]};else{let s=oA(e,oL);r=oA(s.firestore,oG),i=s._query;let o=new lz(r);n={next:e=>{t[a]&&t[a](new lB(r,o,s,e))},error:t[a+1],complete:t[a+2]},lI(e._query)}var l,u,c,h=oK(r),f=i;let m=new oa(n),g=new aI(f,m,o);return h.asyncQueue.enqueueAndForget(async()=>ag(await oI(h),g)),()=>{m.Za(),h.asyncQueue.enqueueAndForget(async()=>ap(await oI(h),g))}},t.onSnapshotsInSync=function(e,t){return function(e,t){let n=new oa(t);return e.asyncQueue.enqueueAndForget(async()=>{var t;return t=await oI(e),void(t.Y_.add(n),n.next())}),()=>{n.Za(),e.asyncQueue.enqueueAndForget(async()=>{var t;return t=await oI(e),void t.Y_.delete(n)})}}(oK(e=oA(e,oG)),oB(t)?t:{next:t})},t.or=function(...e){return e.forEach(e=>lF("or",e)),lE._create("or",e)},t.orderBy=function(e,t="asc"){let n=lv("orderBy",e);return lS._create(n,t)},t.persistentLocalCache=function(e){return new lj(e)},t.persistentMultipleTabManager=function(){return new lY},t.persistentSingleTabManager=lX,t.query=function(e,t,...n){let r=[];for(let i of(t instanceof l_&&r.push(t),function(e){let t=e.filter(e=>e instanceof lE).length,n=e.filter(e=>e instanceof lT).length;if(t>1||t>0&&n>0)throw new x(S.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r=r.concat(n)),r))e=i._apply(e);return e},t.queryEqual=oq,t.refEqual=function(e,t){return e=d.getModularInstance(e),t=d.getModularInstance(t),(e instanceof oV||e instanceof oP)&&(t instanceof oV||t instanceof oP)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter},t.runTransaction=function(e,t,n){e=oA(e,oG);let r=Object.assign(Object.assign({},lZ),n);if(r.maxAttempts<1)throw new x(S.INVALID_ARGUMENT,"Max attempts must be at least 1");return function(e,t,n){let r=new C;return e.asyncQueue.enqueueAndForget(async()=>{let i=await ov(e);new ou(e.asyncQueue,i,n,t,r).au()}),r.promise}(oK(e),n=>t(new l2(e,n)),r)},t.serverTimestamp=function(){return new lt("serverTimestamp")},t.setDoc=function(e,t,n){e=oA(e,oV);let r=oA(e.firestore,oG),i=lL(e.converter,t,n);return lG(r,[o9(o6(r),"setDoc",e._key,i,null!==e.converter,n).toMutation(e._key,nM.none())])},t.setIndexConfiguration=function(e,t){let n=oK(e=oA(e,oG));if(!n._uninitializedComponentsProvider||"memory"===n._uninitializedComponentsProvider._offline.kind)return b("Cannot enable indexes when persistence is disabled"),Promise.resolve();let r=function(e){let t="string"==typeof e?function(e){try{return JSON.parse(e)}catch(e){throw new x(S.INVALID_ARGUMENT,"Failed to parse JSON: "+(null==e?void 0:e.message))}}(e):e,n=[];if(Array.isArray(t.indexes))for(let e of t.indexes){let t=l5(e,"collectionGroup"),r=[];if(Array.isArray(e.fields))for(let t of e.fields){let e=lm("setIndexConfiguration",l5(t,"fieldPath"));"CONTAINS"===t.arrayConfig?r.push(new Y(e,2)):"ASCENDING"===t.order?r.push(new Y(e,0)):"DESCENDING"===t.order&&r.push(new Y(e,1))}n.push(new j(j.UNKNOWN_ID,t,r,X.empty()))}return n}(t);return n.asyncQueue.enqueue(async()=>(async function(e,t){let n=e.indexManager,r=[];return e.persistence.runTransaction("Configure indexes","readwrite",e=>n.getFieldIndexes(e).next(i=>(function(e,t,n,r,i){t=[...t],(e=[...e]).sort(n),t.sort(n);let s=e.length,a=t.length,o=0,l=0;for(;o<a&&l<s;){let s=n(e[l],t[o]);s<0?i(e[l++]):s>0?r(t[o++]):(o++,l++)}for(;o<a;)r(t[o++]);for(;l<s;)i(e[l++])})(i,t,H,t=>{r.push(n.addFieldIndex(e,t))},t=>{r.push(n.deleteFieldIndex(e,t))})).next(()=>ea.waitFor(r)))})(await op(n),r))},t.setLogLevel=function(e){w.setLogLevel(e)},t.snapshotEqual=function(e,t){return e instanceof lq&&t instanceof lq?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof lB&&t instanceof lB&&e._firestore===t._firestore&&oq(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)},t.startAfter=function(...e){return lC._create("startAfter",e,!1)},t.startAt=function(...e){return lC._create("startAt",e,!0)},t.sum=function(e){return new oW("sum",ld("sum",e))},t.terminate=function(e){return u._removeServiceInstance(e.app,"firestore",e._databaseId.database),e._delete()},t.updateDoc=function(e,t,n,...r){e=oA(e,oV);let i=oA(e.firestore,oG),s=o6(i);return lG(i,[("string"==typeof(t=d.getModularInstance(t))||t instanceof oY?la(s,"updateDoc",e._key,t,n,r):ls(s,"updateDoc",e._key,t)).toMutation(e._key,nM.exists(!0))])},t.vector=function(e){return new o0(e)},t.waitForPendingWrites=function(e){var t=oK(e=oA(e,oG));let n=new C;return t.asyncQueue.enqueueAndForget(async()=>aG(await ow(t),n)),n.promise},t.where=function(e,t,n){let r=lv("where",e);return lT._create(r,t,n)},t.writeBatch=function(e){return oK(e=oA(e,oG)),new l0(e,t=>lG(e,t))}}}]);